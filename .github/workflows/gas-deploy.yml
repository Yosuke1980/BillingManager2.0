name: Google Apps Script ãƒ‡ãƒ—ãƒ­ã‚¤

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    name: ã‚³ãƒ¼ãƒ‰æ¤œè¨¼
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci

    - name: TypeScript å‹ãƒã‚§ãƒƒã‚¯
      run: npm run type-check

    - name: ESLint å®Ÿè¡Œ
      run: npm run lint

    - name: Prettier ãƒã‚§ãƒƒã‚¯
      run: npm run format -- --check

    - name: ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
      run: npm run build

  deploy-staging:
    name: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci

    - name: ãƒ“ãƒ«ãƒ‰
      run: npm run build

    - name: clasp èªè¨¼è¨­å®š
      run: |
        echo "${{ secrets.CLASP_CREDENTIALS }}" > ~/.clasprc.json
        chmod 600 ~/.clasprc.json

    - name: GAS ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š (ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°)
      run: |
        echo '{"scriptId": "${{ secrets.GAS_SCRIPT_ID_STAGING }}", "rootDir": "./dist"}' > .clasp.json

    - name: GAS ã«ãƒ—ãƒƒã‚·ãƒ¥
      run: npx clasp push --force

    - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœé€šçŸ¥
      if: always()
      run: |
        echo "ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
        echo "ã‚¹ã‚¯ãƒªãƒ—ãƒˆID: ${{ secrets.GAS_SCRIPT_ID_STAGING }}"

  deploy-production:
    name: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci

    - name: ãƒ“ãƒ«ãƒ‰
      run: npm run build

    - name: clasp èªè¨¼è¨­å®š
      run: |
        echo "${{ secrets.CLASP_CREDENTIALS }}" > ~/.clasprc.json
        chmod 600 ~/.clasprc.json

    - name: GAS ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š (æœ¬ç•ª)
      run: |
        echo '{"scriptId": "${{ secrets.GAS_SCRIPT_ID_PRODUCTION }}", "rootDir": "./dist"}' > .clasp.json

    - name: GAS ã«ãƒ—ãƒƒã‚·ãƒ¥
      run: npx clasp push --force

    - name: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
      run: npx clasp deploy --description "Production deployment $(date)"

    - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœé€šçŸ¥
      if: always()
      run: |
        echo "æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
        echo "ã‚¹ã‚¯ãƒªãƒ—ãƒˆID: ${{ secrets.GAS_SCRIPT_ID_PRODUCTION }}"

  security-scan:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci

    - name: npm auditå®Ÿè¡Œ
      run: npm audit --audit-level=moderate

    - name: ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
      run: npx audit-ci --moderate

  notify-slack:
    name: Slack é€šçŸ¥
    needs: [validate, deploy-production]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: æˆåŠŸé€šçŸ¥
      if: needs.deploy-production.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: "ğŸ‰ GASè«‹æ±‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ"
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

    - name: å¤±æ•—é€šçŸ¥
      if: needs.validate.result == 'failure' || needs.deploy-production.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: "âŒ GASè«‹æ±‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}