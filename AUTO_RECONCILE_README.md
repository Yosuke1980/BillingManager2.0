# 支払いデータ自動照合機能

## 概要

支払いデータ（billing.db）と費用項目（order_management.db）を自動的に照合し、条件が一致するものを「支払済」として更新する機能です。

## 自動実行タイミング

自動照合は以下のタイミングで自動的に実行されます：

### 1. **アプリケーション起動時**
- アプリを起動すると、自動的に照合処理が実行されます
- 処理結果はログに記録されます

### 2. **CSVインポート時**
- メニューから「ファイル → 最新データの読み込み」を実行した後
- 新しい支払いデータがインポートされた直後に自動照合されます

## 照合条件

以下の3つの条件をすべて満たす場合、自動的に照合されます：

1. **取引先の一致**
   - 取引先名またはコードが一致すること

2. **金額の一致**
   - 金額が±5%以内の誤差で一致すること

3. **日付の近接**
   - 支払日と支払予定日が±7日以内であること

## ログの確認

自動照合の実行結果はログに出力されます：

```
支払いデータの自動照合を開始...
自動照合完了: 照合成功=7件, 未照合費用=453件, 未照合支払=100件
✓ 7件の費用項目を支払い済みに更新しました
```

- **照合成功**: 今回新たに照合できた件数
- **未照合費用**: まだ支払いと紐付いていない費用項目の件数
- **未照合支払**: まだ費用項目と紐付いていない支払いレコードの件数

## 手動での照合確認

自動照合機能をテストしたい場合は、以下のスクリプトを実行してください：

```bash
python3 test_auto_reconcile.py
```

照合前後の状態と、最近照合された項目を確認できます。

## トラブルシューティング

### 照合されない場合

以下の項目を確認してください：

1. **取引先情報**
   - 支払いレコードと費用項目で取引先名またはコードが一致しているか
   - 全角/半角、スペースの有無などが完全一致しているか

2. **金額**
   - 金額が±5%以内の範囲で一致しているか
   - 源泉徴収税や消費税を含めた金額になっていないか

3. **日付**
   - 支払日と支払予定日が±7日以内か
   - 日付が正しい形式（YYYY-MM-DD または YYYY/MM/DD）で入力されているか

### デバッグ方法

特定の費用項目が照合されない理由を調べたい場合：

```bash
# debug_matching.py や debug_2952.py を参考にカスタマイズ
python3 debug_matching.py
```

詳細な照合条件チェック結果が表示されます。

## 実装詳細

### コード位置

- **メインロジック**: `order_management/database_manager.py` の `reconcile_payments_with_expenses()` メソッド
- **自動実行処理**: `app.py` の `_auto_reconcile_payments()` メソッド
- **日付形式対応**: 複数の日付形式（YYYY-MM-DD、YYYY/MM/DD）に対応

### 変更履歴

- **2025-11-15**: 日付形式の複数対応を実装（YYYY/MM/DD形式に対応）
- **2025-11-15**: アプリケーション起動時とCSVインポート時の自動照合機能を追加
