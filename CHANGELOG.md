# 変更履歴

## 2025-11-11

### 番組別費用詳細にコーナー名表示を追加

**実装内容:**

コーナーに紐づく費用項目について、コーナー名を表示できるようにしました。

**変更点:**

1. **データベースクエリの更新** ([database_manager.py:3883-3884, 3955-3956](order_management/database_manager.py#L3883-L3884))
   - `get_production_expense_details()`: productionsテーブルをJOINしてcorner_nameとparent_production_idを取得
   - `get_production_expense_details_by_month()`: 同様にコーナー情報を取得

2. **UIの更新** ([production_expense_detail_widget.py:134-147](order_management/ui/production_expense_detail_widget.py#L134-L147))
   - 費用項目テーブルに「コーナー」列を追加（6列→7列）
   - 列順: 実施日、項目名、**コーナー**、金額、取引先、支払予定日、支払状態
   - 月ヘッダー行のスパンを7列に更新

3. **データ表示ロジックの実装** ([production_expense_detail_widget.py:372-382](order_management/ui/production_expense_detail_widget.py#L372-L382))
   - `parent_production_id`が存在する場合のみコーナー名を表示
   - 通常の番組（コーナーでない）場合は空白を表示

**結果:**
- コーナーの費用項目では、どのコーナーに属しているかが一目で分かる
- 通常の番組では空白表示で邪魔にならない

### 発注管理に金額未定機能を追加

**実装内容:**

発注書・契約書の作成時に金額が未確定の場合に対応する機能を追加しました。

**変更点:**

1. **UIの追加** ([order_contract_edit_dialog.py:357-359, 382-384](order_management/ui/order_contract_edit_dialog.py#L357-L359))
   - レギュラー契約: 単価入力欄の横に「金額未定」チェックボックスを追加
   - 単発契約: スポット金額入力欄の横に「金額未定」チェックボックスを追加

2. **イベントハンドラの実装** ([order_contract_edit_dialog.py:569-581](order_management/ui/order_contract_edit_dialog.py#L569-L581))
   - `on_unit_price_pending_changed()`: レギュラー契約用
   - `on_spot_amount_pending_changed()`: 単発契約用
   - チェック時: 金額入力欄を無効化し、入力内容をクリア
   - チェック解除時: 金額入力欄を有効化

3. **バリデーションの更新** ([order_contract_edit_dialog.py:954](order_management/ui/order_contract_edit_dialog.py#L954))
   - 金額未定チェックボックスがチェックされている場合、金額の入力チェックをスキップ

4. **保存ロジックの更新** ([order_contract_edit_dialog.py:1026-1028, 1083-1084](order_management/ui/order_contract_edit_dialog.py#L1026-L1028))
   - `amount_pending` フラグをデータベースに保存
   - レギュラー契約: `unit_price` を NULL で保存
   - 単発契約: `spot_amount` を NULL で保存

5. **データベース読み込みの対応** ([database_manager.py:1405](order_management/database_manager.py#L1405))
   - `get_order_contract_by_id()` に `amount_pending` フィールドを追加
   - 既存契約編集時にチェックボックスの状態を正しく復元

**結果:**
- 金額が未確定の契約でも発注書・契約書を作成可能に
- 金額確定後、契約を編集して金額を入力可能
- データベースには `amount_pending = 1` と `amount = NULL` で保存

### 番組別費用詳細の表示項目を整理

**変更内容:**

左右のテーブルの表示項目を必要最小限に整理しました。

**変更点:**

1. **左側の番組一覧テーブル** (7列 → 5列)
   - 削除: 「月額平均」「項目数」
   - 残存: 番組名、種別、総費用額、未払い、支払済

2. **右側の費用項目テーブル** (9列 → 6列)
   - 削除: 「ID」「状態」「備考」
   - 並び替え: 実施日、項目名、金額、取引先、支払予定日、支払状態
   - 実施日を先頭に配置して時系列で把握しやすく

**結果:**
- 表示がシンプルで見やすくなった
- 重要な情報（金額、支払状態）に集中できる
- 実施日順で費用の流れを把握しやすい

### レギュラー番組の月別表示機能

**実装内容:**

レギュラー番組の費用項目を月別にグループ化して表示する機能を追加しました。

**変更点:**

1. **データベースメソッドの追加** ([database_manager.py:3923-3960](order_management/database_manager.py#L3923-L3960))
   - `get_production_expense_details_by_month()` メソッドを新規追加
   - 指定した番組の特定月の費用項目詳細を取得
   - 月別フィルタリング機能を実装

2. **UI表示ロジックの改善** ([production_expense_detail_widget.py:280-406](order_management/ui/production_expense_detail_widget.py#L280-L406))
   - レギュラー番組選択時: 月別グループ表示
   - イベント・特番選択時: 全項目一括表示
   - 月ヘッダー行の追加（件数・金額サマリー付き）
   - `_populate_detail_row()` 共通ヘルパーメソッドを追加

**表示内容:**
- **レギュラー番組**:
  - 📅 2026-05 (4件 / ¥675,000)
    - 費用項目1
    - 費用項目2
    - ...
  - 📅 2026-04 (4件 / ¥675,000)
    - ...
- **イベント・特番**: 全費用項目を一括表示

**テスト結果:**
- レギュラー番組「FLAG」で7ヶ月分の月別表示を確認
- 各月のサマリー（件数・金額）が正しく表示される
- イベント「ちょうどいいラジオ」では98件を一括表示

### 番組別費用詳細の表示機能強化

**実装内容:**

レギュラー番組と単発イベントを明確に区別して表示する機能を追加しました。

**変更点:**

1. **データベース集計の改善** ([database_manager.py:671-733](order_management/database_manager.py#L671-L733))
   - `get_production_expense_summary()` メソッドを更新
   - `production_type` カラムを追加
   - `month_count`: 支払予定月数をカウント
   - `monthly_average`: 月額平均費用を自動計算（総費用額 ÷ 月数）
   - 番組タイプによるフィルタリング機能を追加
   - 月額平均でのソート機能を追加

2. **UI表示の改善** ([production_expense_detail_widget.py](order_management/ui/production_expense_detail_widget.py))
   - 番組一覧テーブルを5列から7列に拡張:
     - 新規追加: 「種別」「月額平均」
   - 種別フィルタを追加（全て/レギュラー/イベント/特番/コーナー）
   - 並び替えに「月額平均順」を追加
   - 番組タイプに応じた表示形式:
     - **レギュラー・コーナー**: 「¥X,XXX/月」形式で月額平均を表示
     - **イベント・特番**: 「(Xヶ月)」形式で期間を表示
   - 色分け表示:
     - レギュラー/コーナー: 青系 (#e6f0ff)
     - イベント/特番: 黄系 (#fffae6)
     - その他: オレンジ系 (#fff3e0)

**修正内容:**
- `load_production_detail()` メソッドのデータ構造インデックスを修正
- 新しい12カラムのデータ構造に対応

**結果:**
- レギュラー番組: 9件（月額平均を一覧表示）
- イベント: 5件（総費用と期間を表示）
- 特番: 1件
- 月額平均トップ: FLAG ¥771,428/月、メラタデマンデー ¥342,857/月

## 2025-11-10

### 費用項目の重複データ削除

**問題:**
- JACK STYLE × チャプター: 各月9件ずつ重複
- ちょうどいいラジオ × G-インパクト: 各月12件重複
- ニュース室 × クロスイメージング: 各月15件ずつ重複
- その他多数の重複が発生

**原因:**
- 契約から費用項目を自動生成する処理が複数回実行された
- 同一の番組・取引先・項目名・実施日の組み合わせで重複発生

**対応:**
- production_id, partner_id, item_name, implementation_dateの組み合わせで重複を検出
- 最小IDのレコードを残し、他の重複レコードを削除
- 削除件数: 273件

**結果:**
- 削除前: 731件
- 削除後: 458件（37%削減）
- 来月末までのフィルタ: 234件 → 156件
- 重複: 0件（完全解消）

**確認済み番組:**
- JACK STYLE: 各月1件（正常）
- ちょうどいいラジオ: 各項目1件ずつ（正常）
- ニュース室: 各月1件（正常）

### フィルタ機能の改善

**「今月末まで」フィルタを追加:**
- 今月末（2025-11-30）までの費用項目を表示: 114件

**再来月以降の月フィルタを除外:**
- 2026年1月以降の月をリストから除外
- 実用性の向上: 当月・来月の確認に特化

**デフォルトフィルタを「来月末まで」に変更:**
- 来月末（2025-12-31）までの費用項目のみ表示
- 表示件数: 731件 → 156件（重複削除後）

### パフォーマンス改善

**日付パース処理の最適化:**
- 1行ごとに3回実行していた日付パースを1回に統合
- パフォーマンスを約3倍改善

**日付フォーマットの修正:**
- スラッシュ形式（2025/09/30）をハイフン形式（2025-09-30）に統一
- 修正件数: 12件

### 契約と費用項目の生成

**2025年10月1日〜2026年4月1日の契約を作成:**
- 95件の契約を作成
- 各契約から7ヶ月分（2025年10月〜2026年4月）の費用項目を生成
- 生成件数: 671件（重複含む）
- 重複削除後: 398件の新規費用項目
