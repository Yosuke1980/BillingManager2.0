// 段階的復元テスト - ステップ1: 基本変数と簡単な関数
console.log('Script.html step 1 loaded successfully');


// グローバル変数
let currentView = 'payment';
let allData = {
  payment: [],
  expense: [],
  master: []
};
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 20;

function debugTest() {
    console.log('debugTest() called from step 1 script');
    alert('Step 1 script working!');
    return true;
}

function checkFunctionDefinitions() {
    console.log('checkFunctionDefinitions() called from step 1 script');
    alert('Step 1 check function working!');
    return true;
}

// 基本的な表示関数（template literals なし）
function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

function showError(message) {
    console.error('Error:', message);
    alert('エラー: ' + message);
}

// ステップ2: 基本的なUI関数とイベント処理
function switchView(view) {
    currentView = view;
    console.log('Switching to view:', view);

    // タブアクティブ状態更新
    document.querySelectorAll('.nav-link').forEach(tab => {
        tab.classList.remove('active');
    });
    const targetTab = document.querySelector('[data-bs-target="#' + view + '"]');
    if (targetTab) {
        targetTab.classList.add('active');
    }

    // データ読み込み
    loadData();
    updateUI();
}

function loadData() {
    console.log('Loading data for view:', currentView);
    showLoading(true);

    let functionName;
    switch(currentView) {
        case 'payment':
            functionName = 'getPaymentData';
            break;
        case 'expense':
            functionName = 'getExpenseData';
            break;
        case 'master':
            functionName = 'getMasterData';
            break;
        default:
            functionName = 'getPaymentData';
    }

    // Server function call
    google.script.run
        .withSuccessHandler(function(result) {
            // サーバーは {success: true, data: [...]} または配列を返す可能性がある
            const rows = (result && result.success) ? result.data : result;
            allData[currentView] = Array.isArray(rows) ? rows : [];
            filteredData = allData[currentView];
            console.log('Data loaded for', currentView, ':', filteredData.length, 'items');
            updateTable();
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            console.error('データ読み込みエラー:', error);
            showError('データの読み込みに失敗しました: ' + error.message);
            allData[currentView] = [];
            filteredData = [];
            showLoading(false);
        })[functionName]();
}

function updateUI() {
    const viewTitle = document.getElementById('viewTitle');
    const viewMap = {
        'payment': '支払データ管理',
        'expense': '費用データ管理',
        'master': 'マスタデータ管理'
    };
    if (viewTitle) {
        viewTitle.textContent = viewMap[currentView] || 'データ管理';
    }
}

function updateTable() {
    // ビュー別のtbody要素マッピング
    const bodyMap = {
        payment: '#paymentsTableBody',
        expense: '#expensesTableBody',
        master: '#mastersTableBody'
    };

    const tbody = document.querySelector(bodyMap[currentView]);
    if (!tbody) {
        console.error(`${currentView}TableBody not found`);
        return;
    }

    tbody.innerHTML = '';

    if (!filteredData || filteredData.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 7; // 基本7列（必要に応じて調整）
        cell.className = 'loading';
        cell.innerHTML = '<i class="bi bi-arrow-clockwise pulse"></i><p>データを読み込み中...</p>';
        return;
    }

    // ページネーション計算
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredData.slice(startIndex, endIndex);

    // ビュー別の表示カラム定義（HTMLのth順序に対応）
    const colsByView = {
        payment: ['件名', '案件名', '支払い先', '支払い先コード', '金額', '支払日', '状態'],
        expense: ['案件名', '支払い先', '支払い先コード', '金額', '支払日', '状態'],
        master: ['案件名', '支払い先', '支払い先コード', '金額', '種別', '開始日', '終了日']
    };

    const cols = colsByView[currentView] || [];

    pageData.forEach(item => {
        const row = tbody.insertRow();
        cols.forEach(key => {
            const cell = row.insertCell();
            let value = item[key] || '';

            // 金額の場合は数値フォーマット
            if (key === '金額' && value !== '') {
                const numValue = Number(value);
                if (!isNaN(numValue)) {
                    value = numValue.toLocaleString('ja-JP');
                }
            }

            cell.textContent = value;
        });
    });

    updatePagination();
}

function updatePagination() {
    // シンプルなページネーション（template literalsなし）
    console.log('Updating pagination for page:', currentPage);
}

// 基本的なイベント関数
function refreshAllData() {
    console.log('Refreshing all data');
    loadData();
}

function refreshPayments() {
    currentView = 'payment';
    loadData();
}

function refreshExpenses() {
    currentView = 'expense';
    loadData();
}

function refreshMasters() {
    currentView = 'master';
    loadData();
}

// 統一的なサーバー関数呼び出し機能
function callServerFunction(funcName) {
    console.log('Calling server function:', funcName);

    // ローディング表示
    showLoading(true);

    google.script.run
        .withSuccessHandler(function(result) {
            showLoading(false);
            handleServerSuccess(result, funcName);
        })
        .withFailureHandler(function(error) {
            showLoading(false);
            handleServerError(error, funcName);
        })
        [funcName]();
}

function handleServerSuccess(result, funcName) {
    console.log('Server function success:', funcName, result);

    if (result && typeof result === 'object') {
        if (result.success) {
            alert('成功: ' + (result.message || '処理が完了しました'));

            // スプレッドシートURLがある場合はログ出力
            if (result.spreadsheetUrl) {
                console.log('Spreadsheet URL:', result.spreadsheetUrl);
            }

            // データ更新が必要な場合は再読み込み
            if (funcName.includes('Data') || funcName.includes('Sample')) {
                setTimeout(() => {
                    loadData();
                }, 1000);
            }
        } else {
            alert('処理結果: ' + (result.message || '処理は完了しましたが、詳細が不明です'));
        }
    } else {
        // 単純な戻り値の場合
        alert('処理完了: ' + funcName);
        console.log('Server response:', result);
    }
}

function handleServerError(error, funcName) {
    console.error('Server function error:', funcName, error);
    alert('エラーが発生しました: ' + (error.message || error.toString()));
}

// クライアント側専用の関数（サーバー呼び出し不要）
function debugTest() {
    console.log('debugTest() called - client side test');
    alert('クライアント側テスト機能正常動作中！\n現在のビュー: ' + currentView);
    return true;
}

function checkFunctionDefinitions() {
    console.log('checkFunctionDefinitions() called - checking client functions');
    const functions = ['debugTest', 'loadData', 'updateTable', 'callServerFunction'];
    const results = functions.map(f => f + ': ' + (typeof window[f] === 'function' ? '✓' : '✗'));
    alert('関数定義チェック結果:\n' + results.join('\n'));
    return true;
}

// 初期化処理
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - initializing application');

    // 初期表示は「支払い」タブ
    currentView = 'payment';

    // Bootstrap 5タブイベント対応
    document.querySelectorAll('[data-bs-target="#payment"],[data-bs-target="#expense"],[data-bs-target="#master"]')
        .forEach(btn => {
            btn.addEventListener('shown.bs.tab', (e) => {
                const target = e.target.getAttribute('data-bs-target'); // "#payment" など
                console.log('Tab switched to:', target);

                // data-bs-target からビュー名を判定
                currentView = (target === '#payment') ? 'payment' :
                             (target === '#expense') ? 'expense' : 'master';

                console.log('Current view changed to:', currentView);

                // データ読み込み
                loadData();
            });
        });

    // 初期データ読み込み
    loadData();

    console.log('Application initialized');
});