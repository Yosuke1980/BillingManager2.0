// 段階的復元テスト - ステップ1: 基本変数と簡単な関数
console.log('Script.html step 1 loaded successfully');

// グローバル変数
let currentView = 'payments';
let allData = {
  payments: [],
  expenses: [],
  masters: []
};
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 20;

function debugTest() {
    console.log('debugTest() called from step 1 script');
    alert('Step 1 script working!');
    return true;
}

function checkFunctionDefinitions() {
    console.log('checkFunctionDefinitions() called from step 1 script');
    alert('Step 1 check function working!');
    return true;
}

// 基本的な表示関数（template literals なし）
function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

function showError(message) {
    console.error('Error:', message);
    alert('エラー: ' + message);
}

// ステップ2: 基本的なUI関数とイベント処理
function switchView(view) {
    currentView = view;
    console.log('Switching to view:', view);

    // タブアクティブ状態更新
    document.querySelectorAll('.nav-link').forEach(tab => {
        tab.classList.remove('active');
    });
    const targetTab = document.querySelector('[href="#' + view + '"]');
    if (targetTab) {
        targetTab.classList.add('active');
    }

    // データ読み込み
    loadData();
    updateUI();
}

function loadData() {
    console.log('Loading data for view:', currentView);
    showLoading(true);

    let functionName;
    switch(currentView) {
        case 'payments':
            functionName = 'getPaymentData';
            break;
        case 'expenses':
            functionName = 'getExpenseData';
            break;
        case 'masters':
            functionName = 'getMasterData';
            break;
        default:
            functionName = 'getPaymentData';
    }

    // Server function call
    google.script.run
        .withSuccessHandler(function(data) {
            allData[currentView] = data || [];
            filteredData = allData[currentView];
            updateTable();
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            console.error('データ読み込みエラー:', error);
            showError('データの読み込みに失敗しました: ' + error.message);
            showLoading(false);
        })[functionName]();
}

function updateUI() {
    const viewTitle = document.getElementById('viewTitle');
    const viewMap = {
        'payments': '支払データ管理',
        'expenses': '費用データ管理',
        'masters': 'マスタデータ管理'
    };
    if (viewTitle) {
        viewTitle.textContent = viewMap[currentView] || 'データ管理';
    }
}

function updateTable() {
    const tbody = document.querySelector('#dataTable tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!filteredData || filteredData.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 10;
        cell.textContent = 'データがありません';
        cell.className = 'text-center text-muted py-4';
        return;
    }

    // ページネーション計算
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredData.slice(startIndex, endIndex);

    // テーブル行作成
    pageData.forEach(item => {
        const row = tbody.insertRow();
        // 基本的な列のみ（template literalsを避ける）
        const cells = ['日付', '項目', '金額', '支払先', '状態'];
        cells.forEach(key => {
            const cell = row.insertCell();
            cell.textContent = item[key] || '';
        });
    });

    updatePagination();
}

function updatePagination() {
    // シンプルなページネーション（template literalsなし）
    console.log('Updating pagination for page:', currentPage);
}

// 基本的なイベント関数
function refreshAllData() {
    console.log('Refreshing all data');
    loadData();
}

function refreshPayments() {
    currentView = 'payments';
    loadData();
}

function refreshExpenses() {
    currentView = 'expenses';
    loadData();
}

function refreshMasters() {
    currentView = 'masters';
    loadData();
}

// システム関数（シンプル版）
function initializeCompleteSystem() {
    console.log('Initializing complete system');
    alert('システム初期化を開始します');
}

function createSampleData() {
    console.log('Creating sample data');
    alert('サンプルデータを作成します');
}

function checkSystemStatus() {
    console.log('Checking system status');
    alert('システム状態をチェックします');
}

function showSystemStatus() {
    console.log('Showing system status');
    alert('システム状態を表示します');
}

// 残りのスタブ関数
function createNewSpreadsheet() { alert('createNewSpreadsheet() stub'); }
function importPythonAppData() { alert('importPythonAppData() stub'); }
function showCSVImportDialog() { alert('showCSVImportDialog() stub'); }
function searchPayments() { alert('searchPayments() stub'); }
function resetPaymentFilters() { alert('resetPaymentFilters() stub'); }
function openMasterReflectionModal() { alert('openMasterReflectionModal() stub'); }
function generateFromMasterForCurrentMonth() { alert('generateFromMasterForCurrentMonth() stub'); }
function generateFromMasterForNextMonth() { alert('generateFromMasterForNextMonth() stub'); }
function searchExpenses() { alert('searchExpenses() stub'); }
function resetExpenseFilters() { alert('resetExpenseFilters() stub'); }
function searchMasters() { alert('searchMasters() stub'); }
function resetMasterFilters() { alert('resetMasterFilters() stub'); }
function runAutoMatching() { alert('runAutoMatching() stub'); }
function runSystemDiagnosis() { alert('runSystemDiagnosis() stub'); }
function checkDataIntegrity() { alert('checkDataIntegrity() stub'); }
function showPerformanceStats() { alert('showPerformanceStats() stub'); }
function runEmergencyRepair() { alert('runEmergencyRepair() stub'); }
function verifyDataCounts() { alert('verifyDataCounts() stub'); }
function checkDataDuplicates() { alert('checkDataDuplicates() stub'); }
function validateFieldRanges() { alert('validateFieldRanges() stub'); }
function runCompleteDataValidation() { alert('runCompleteDataValidation() stub'); }
function emergencySystemSetup() { alert('emergencySystemSetup() stub'); }
function runSystemDebug() { alert('runSystemDebug() stub'); }
function setCurrentMonth() { alert('setCurrentMonth() stub'); }
function setNextMonth() { alert('setNextMonth() stub'); }
function setPreviousMonth() { alert('setPreviousMonth() stub'); }
function previewMasterReflection() { alert('previewMasterReflection() stub'); }
function executeMasterReflection() { alert('executeMasterReflection() stub'); }