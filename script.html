// 段階的復元テスト - ステップ1: 基本変数と簡単な関数
console.log('Script.html step 1 loaded successfully');


// グローバル変数
let currentView = 'payment';
let allData = {
  payment: [],
  expense: [],
  master: []
};
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 20;

function debugTest() {
    console.log('debugTest() called from step 1 script');
    alert('Step 1 script working!');
    return true;
}

function checkFunctionDefinitions() {
    console.log('checkFunctionDefinitions() called from step 1 script');
    alert('Step 1 check function working!');
    return true;
}

// 基本的な表示関数（template literals なし）
function showLoading(show) {
    console.log('showLoading called with:', show);
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
        console.log('Loading spinner', show ? 'shown' : 'hidden');
    } else {
        console.warn('loadingSpinner element not found');
    }
}

function showError(message) {
    console.error('Error:', message);
    alert('エラー: ' + message);
}

// ステップ2: 基本的なUI関数とイベント処理
function switchView(view) {
    currentView = view;
    console.log('Switching to view:', view);

    // タブアクティブ状態更新
    document.querySelectorAll('.nav-link').forEach(tab => {
        tab.classList.remove('active');
    });
    const targetTab = document.querySelector('[data-bs-target="#' + view + '"]');
    if (targetTab) {
        targetTab.classList.add('active');
    }

    // データ読み込み
    loadData();
    updateUI();
}

function loadData() {
    console.log('Loading data for view:', currentView);
    showLoading(true);

    let functionName;
    switch(currentView) {
        case 'payment':
            functionName = 'getPaymentData';
            break;
        case 'expense':
            functionName = 'getExpenseData';
            break;
        case 'master':
            functionName = 'getMasterData';
            break;
        default:
            functionName = 'getPaymentData';
    }

    // Server function call with timeout
    console.log('Calling server function:', functionName);

    // タイムアウトタイマーを設定
    const timeoutId = setTimeout(() => {
        console.warn('サーバー関数のタイムアウト:', functionName);
        showError('データの読み込みがタイムアウトしました。再度お試しください。');
        showLoading(false);
    }, 15000); // 15秒でタイムアウト

    google.script.run
        .withSuccessHandler(function(result) {
            clearTimeout(timeoutId); // タイムアウトをクリア
            console.log('Server function success:', functionName, result);

            try {
                // サーバーは {success: true, data: [...]} または配列を返す可能性がある
                let rows = [];

                if (result && typeof result === 'object') {
                    if (result.success) {
                        rows = Array.isArray(result.data) ? result.data : [];

                        // 実行時間の表示
                        if (result.duration) {
                            console.log(`データ取得時間: ${result.duration}ms`);
                        }
                    } else {
                        console.warn('Server returned failure:', result);
                        if (result.message) {
                            showError('データ取得エラー: ' + result.message);
                        }
                        rows = [];
                    }
                } else if (Array.isArray(result)) {
                    rows = result;
                } else {
                    console.warn('Unexpected server response:', result);
                    rows = [];
                }

                allData[currentView] = rows;
                filteredData = allData[currentView];

                console.log(`Data loaded for ${currentView}: ${filteredData.length} items`);

                updateTable();
                showLoading(false);

            } catch (processError) {
                console.error('データ処理エラー:', processError);
                showError('データの処理中にエラーが発生しました: ' + processError.message);
                allData[currentView] = [];
                filteredData = [];
                showLoading(false);
            }
        })
        .withFailureHandler(function(error) {
            clearTimeout(timeoutId); // タイムアウトをクリア
            console.error('Server function failure:', functionName, error);

            let errorMessage = 'データの読み込みに失敗しました';
            if (error && error.message) {
                errorMessage += ': ' + error.message;
            }

            showError(errorMessage);

            // データが取得できない場合は空配列を設定
            allData[currentView] = [];
            filteredData = [];
            updateTable();
            showLoading(false);
        })[functionName]();
}

function updateUI() {
    const viewTitle = document.getElementById('viewTitle');
    const viewMap = {
        'payment': '支払データ管理',
        'expense': '費用データ管理',
        'master': 'マスタデータ管理'
    };
    if (viewTitle) {
        viewTitle.textContent = viewMap[currentView] || 'データ管理';
    }
}

function updateTable() {
    // ビュー別のtbody要素マッピング（CONFIG準拠）
    const bodyMap = {
        payment: '#paymentsTableBody',
        expense: '#expensesTableBody',
        master: '#mastersTableBody'
    };

    const tbody = document.querySelector(bodyMap[currentView]);
    if (!tbody) {
        console.error(`${currentView}TableBody not found`);
        return;
    }

    tbody.innerHTML = '';

    if (!filteredData || filteredData.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 7; // 基本7列（必要に応じて調整）
        cell.className = 'no-data';
        cell.innerHTML = '<i class="bi bi-exclamation-circle"></i><p>データがありません</p>';
        return;
    }

    // ページネーション計算
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredData.slice(startIndex, endIndex);

    // ビュー別の表示カラム定義（HTMLのth順序に対応）
    const colsByView = {
        payment: ['件名', '案件名', '支払い先', '支払い先コード', '金額', '支払日', '状態'],
        expense: ['案件名', '支払い先', '支払い先コード', '金額', '支払日', '状態'],
        master: ['案件名', '支払い先', '支払い先コード', '金額', '種別', '開始日', '終了日']
    };

    const cols = colsByView[currentView] || [];

    pageData.forEach(item => {
        const row = tbody.insertRow();
        cols.forEach((key, index) => {
            const cell = row.insertCell();
            let value = item[key] || '';

            // 金額の場合は数値フォーマット
            if (key === '金額' && value !== '') {
                const numValue = Number(value);
                if (!isNaN(numValue)) {
                    value = numValue.toLocaleString('ja-JP');
                }
            }

            // ステータス列の色分け
            if (key === '状態' && value) {
                applyStatusStyling(cell, value);
            }

            // 支払い先コードのフォーマット
            if (key === '支払い先コード' && value) {
                value = String(value).padStart(4, '0');
            }

            cell.textContent = value;
        });

        // 行全体に照合結果の色分けを適用（将来の機能のため）
        if (item.matchingStatus) {
            applyMatchingStatusStyling(row, item.matchingStatus);
        }
    });

    updatePagination();
}

function updatePagination() {
    // シンプルなページネーション（template literalsなし）
    console.log('Updating pagination for page:', currentPage);
}

// 基本的なイベント関数
function refreshAllData() {
    console.log('Refreshing all data');
    loadData();
}

function refreshPayments() {
    currentView = 'payment';
    loadData();
}

function refreshExpenses() {
    currentView = 'expense';
    loadData();
}

function refreshMasters() {
    currentView = 'master';
    loadData();
}


// スタイリング関数（matching_config.json準拠）
function applyStatusStyling(cell, status) {
    const statusColors = {
        '未処理': { background: '#f8f9fa', color: '#495057' },
        '処理中': { background: '#fff3cd', color: '#856404' },
        '照合済': { background: '#d4edda', color: '#155724' },
        '完了': { background: '#d1ecf1', color: '#0c5460' }
    };

    const colors = statusColors[status];
    if (colors) {
        cell.style.backgroundColor = colors.background;
        cell.style.color = colors.color;
        cell.style.fontWeight = 'bold';
        cell.style.padding = '4px 8px';
        cell.style.borderRadius = '4px';
        cell.style.textAlign = 'center';
    }
}

function applyMatchingStatusStyling(row, matchingStatus) {
    const matchingColors = {
        '未着・催促要': { background: '#f8d7da', color: '#721c24' },
        '要確認・金額確認要': { background: '#fff3cd', color: '#856404' },
        '到着済み・対応不要': { background: '#d4edda', color: '#155724' }
    };

    const colors = matchingColors[matchingStatus];
    if (colors) {
        row.style.backgroundColor = colors.background + '40'; // 40% opacity
        row.style.borderLeft = `4px solid ${colors.background}`;
    }
}

function formatCurrency(amount) {
    const numAmount = Number(amount);
    if (isNaN(numAmount)) return '0';
    return numAmount.toLocaleString('ja-JP', {
        style: 'currency',
        currency: 'JPY'
    });
}

function formatPayeeCode(code) {
    if (!code) return '';
    return String(code).padStart(4, '0');
}

// 統一的なサーバー関数呼び出し機能
function callServerFunction(funcName) {
    console.log('Calling server function:', funcName);

    // ローディング表示
    showLoading(true);

    google.script.run
        .withSuccessHandler(function(result) {
            showLoading(false);
            handleServerSuccess(result, funcName);
        })
        .withFailureHandler(function(error) {
            showLoading(false);
            handleServerError(error, funcName);
        })
        [funcName]();
}

function handleServerSuccess(result, funcName) {
    console.log('Server function success:', funcName, result);

    if (result && typeof result === 'object') {
        if (result.success) {
            // サンプルCSV生成の場合は特別な処理
            if (funcName.includes('SampleCSV')) {
                let message = result.message;
                if (result.downloadUrl) {
                    message += '\n\nダウンロードURL: ' + result.downloadUrl;
                }
                if (result.viewUrl) {
                    message += '\n表示URL: ' + result.viewUrl;
                }
                if (result.headers) {
                    message += '\n\n必要なヘッダー: ' + result.headers.join(', ');
                }
                alert(message);

                // ダウンロードリンクがある場合は新しいウィンドウで開く
                if (result.downloadUrl) {
                    window.open(result.downloadUrl, '_blank');
                }
            } else {
                alert('成功: ' + (result.message || '処理が完了しました'));
            }

            // スプレッドシートURLがある場合はログ出力
            if (result.spreadsheetUrl) {
                console.log('Spreadsheet URL:', result.spreadsheetUrl);
            }

            // データ更新が必要な場合は再読み込み
            if (funcName.includes('Data') && !funcName.includes('SampleCSV')) {
                setTimeout(() => {
                    loadData();
                }, 1000);
            }
        } else {
            alert('処理結果: ' + (result.message || '処理は完了しましたが、詳細が不明です'));
        }
    } else {
        // 単純な戻り値の場合
        alert('処理完了: ' + funcName);
        console.log('Server response:', result);
    }
}

function handleServerError(error, funcName) {
    console.error('Server function error:', funcName, error);
    alert('エラーが発生しました: ' + (error.message || error.toString()));
}

// クライアント側専用の関数（サーバー呼び出し不要）
function debugTest() {
    console.log('debugTest() called - client side test');
    alert('クライアント側テスト機能正常動作中！\n現在のビュー: ' + currentView);
    return true;
}

function checkFunctionDefinitions() {
    console.log('checkFunctionDefinitions() called - checking client functions');
    const functions = ['debugTest', 'loadData', 'updateTable', 'callServerFunction'];
    const results = functions.map(f => f + ': ' + (typeof window[f] === 'function' ? '✓' : '✗'));
    alert('関数定義チェック結果:\n' + results.join('\n'));
    return true;
}

// 初期化処理
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - initializing application');

    // 初期表示は「支払い」タブ
    currentView = 'payment';

    // Bootstrap 5タブイベント対応
    document.querySelectorAll('[data-bs-target="#payment"],[data-bs-target="#expense"],[data-bs-target="#master"]')
        .forEach(btn => {
            btn.addEventListener('shown.bs.tab', (e) => {
                const target = e.target.getAttribute('data-bs-target'); // "#payment" など
                console.log('Tab switched to:', target);

                // data-bs-target からビュー名を判定
                currentView = (target === '#payment') ? 'payment' :
                             (target === '#expense') ? 'expense' : 'master';

                console.log('Current view changed to:', currentView);

                // データ読み込み
                loadData();
            });
        });

    // 初期データ読み込み
    loadData();

    console.log('Application initialized');
});