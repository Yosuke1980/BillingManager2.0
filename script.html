<!-- script.html å®Œå…¨ä¿®æ­£ç‰ˆ - ã‚¨ãƒ©ãƒ¼ä¿®æ­£æ¸ˆã¿ -->
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentPayments = [];
let currentExpenses = [];
let currentMaster = [];
let selectedPayments = new Set();
let selectedExpenses = new Set();
let selectedMaster = new Set();

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const tabTriggerList = [].slice.call(document.querySelectorAll('#mainTabs button[data-bs-toggle="tab"]'));
    tabTriggerList.forEach(function (tabTrigger) {
        tabTrigger.addEventListener('shown.bs.tab', function (event) {
            const target = event.target.getAttribute('data-bs-target');
            switch(target) {
                case '#payment':
                    loadPayments();
                    break;
                case '#expense':
                    loadExpenses();
                    break;
                case '#master':
                    loadMaster();
                    break;
            }
        });
    });

    // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('selectAllPayments').addEventListener('change', toggleAllPayments);
    document.getElementById('selectAllExpenses').addEventListener('change', toggleAllExpenses);
    document.getElementById('selectAllMaster').addEventListener('change', toggleAllMaster);

    // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    loadPayments();
    loadStats();
});

// === çµ±ä¸€ã•ã‚ŒãŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ===

function showStatus(message, type = 'info') {
    const alert = document.getElementById('statusAlert');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alert.classList.remove('d-none');
    
    setTimeout(() => {
        alert.classList.add('d-none');
    }, 5000);
}

function showLoading(elementId, show = true) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = show ? 'block' : 'none';
    }
}

function formatAmount(amount) {
    if (!amount && amount !== 0) return '';
    
    const num = parseFloat(amount);
    if (isNaN(num)) return amount;
    
    return new Intl.NumberFormat('ja-JP', {
        style: 'currency',
        currency: 'JPY',
        minimumFractionDigits: 0
    }).format(num);
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ja-JP');
    } catch (error) {
        return dateStr;
    }
}

function getStatusBadge(status) {
    return `<span class="status-badge status-${status}">${status}</span>`;
}

function formatBroadcastDays(daysStr) {
    if (!daysStr) return '';
    
    const dayMap = {
        'æœˆ': 'æœˆ',
        'ç«': 'ç«', 
        'æ°´': 'æ°´',
        'æœ¨': 'æœ¨',
        'é‡‘': 'é‡‘',
        'åœŸ': 'åœŸ',
        'æ—¥': 'æ—¥'
    };
    
    const days = daysStr.split(',').map(day => day.trim());
    return days.map(day => dayMap[day] || day).join('ãƒ»');
}

function getPaymentTypeBadge(type) {
    const typeColors = {
        'æœˆé¡å›ºå®š': 'primary',
        'å›æ•°ãƒ™ãƒ¼ã‚¹': 'success',
        'å˜ç™º': 'warning',
        'ãã®ä»–': 'secondary'
    };
    
    const color = typeColors[type] || 'secondary';
    return `<span class="badge bg-${color}">${type}</span>`;
}

function handleDataLoadError(error, dataType) {
    console.error(`${dataType}ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
    showStatus(`${dataType}ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error}`, 'danger');
}

function displayDataWithFallback(data, displayFunction, tableBodyId, dataType) {
    const tbody = document.getElementById(tableBodyId);
    
    if (!tbody) {
        console.error(`ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${tableBodyId}`);
        showStatus(`${dataType}ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ`, 'danger');
        return;
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢
    tbody.innerHTML = '';
    
    // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆ
    if (!data || data.length === 0) {
        const colspan = tbody.parentElement.querySelector('thead tr').children.length;
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="${colspan}" class="text-center text-muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>`;
        tbody.appendChild(row);
        return;
    }
    
    try {
        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºé–¢æ•°ã‚’å‘¼ã³å‡ºã—
        displayFunction(data);
        console.log(`${dataType}ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå®Œäº†: ${data.length}ä»¶`);
    } catch (displayError) {
        console.error(`${dataType}ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:`, displayError);
        const colspan = tbody.parentElement.querySelector('thead tr').children.length;
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="${colspan}" class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</td>`;
        tbody.appendChild(row);
        showStatus(`${dataType}ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`, 'danger');
    }
}

// === çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ ===

function loadStats() {
    google.script.run
        .withSuccessHandler(function(result) {
            try {
                if (result && result.payments && result.payments.data) {
                    document.getElementById('paymentCount').textContent = result.payments.data.length;
                    document.getElementById('matchedCount').textContent = result.payments.matchedCount || 0;
                } else {
                    document.getElementById('paymentCount').textContent = '0';
                    document.getElementById('matchedCount').textContent = '0';
                }
                
                if (result && result.expenses && result.expenses.data) {
                    document.getElementById('expenseCount').textContent = result.expenses.data.length;
                } else {
                    document.getElementById('expenseCount').textContent = '0';
                }
                
                if (result && result.master && result.master.data) {
                    document.getElementById('masterCount').textContent = result.master.data.length;
                } else {
                    document.getElementById('masterCount').textContent = '0';
                }
            } catch (error) {
                console.error('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                document.getElementById('paymentCount').textContent = '0';
                document.getElementById('expenseCount').textContent = '0';
                document.getElementById('masterCount').textContent = '0';
                document.getElementById('matchedCount').textContent = '0';
            }
        })
        .withFailureHandler(function(error) {
            handleDataLoadError(error, 'çµ±è¨ˆ');
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            document.getElementById('paymentCount').textContent = '0';
            document.getElementById('expenseCount').textContent = '0';
            document.getElementById('masterCount').textContent = '0';
            document.getElementById('matchedCount').textContent = '0';
        })
        .loadAllStats();
}

// === æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿é–¢é€£ ===

function loadPayments() {
    showLoading('paymentLoading');
    const searchTerm = document.getElementById('paymentSearch').value || '';
    
    google.script.run
        .withSuccessHandler(function(result) {
            showLoading('paymentLoading', false);
            try {
                if (result && result.success && result.data) {
                    currentPayments = result.data;
                    displayDataWithFallback(result.data, displayPayments, 'paymentTableBody', 'æ”¯æ‰•ã„');
                    document.getElementById('paymentCount').textContent = result.data.length;
                    document.getElementById('matchedCount').textContent = result.matchedCount || 0;
                    
                    if (result.data.length === 0) {
                        showStatus('æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
                    }
                } else {
                    currentPayments = [];
                    displayDataWithFallback([], displayPayments, 'paymentTableBody', 'æ”¯æ‰•ã„');
                    document.getElementById('paymentCount').textContent = '0';
                    document.getElementById('matchedCount').textContent = '0';
                    showStatus(result ? result.message : 'æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
                }
            } catch (error) {
                console.error('æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                currentPayments = [];
                displayDataWithFallback([], displayPayments, 'paymentTableBody', 'æ”¯æ‰•ã„');
                showStatus('æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
            }
        })
        .withFailureHandler(function(error) {
            showLoading('paymentLoading', false);
            handleDataLoadError(error, 'æ”¯æ‰•ã„');
            currentPayments = [];
            displayDataWithFallback([], displayPayments, 'paymentTableBody', 'æ”¯æ‰•ã„');
        })
        .getPaymentData(searchTerm);
}

function displayPayments(payments) {
    const tbody = document.getElementById('paymentTableBody');
    
    payments.forEach(payment => {
        const row = document.createElement('tr');
        if (payment.status === 'ç…§åˆæ¸ˆ' || payment.status === 'å‡¦ç†æ¸ˆ') {
            row.classList.add('matched');
        }
        
        // å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿å–å¾—
        const safePayment = {
            id: payment.id || '',
            subject: payment.subject || '',
            projectName: payment.projectName || '',
            payee: payment.payee || '',
            payeeCode: payment.payeeCode || '',
            amount: payment.amount || 0,
            paymentDate: payment.paymentDate || '',
            status: payment.status || 'æœªå‡¦ç†'
        };
        
        row.innerHTML = `
            <td><input type="checkbox" class="payment-select" value="${safePayment.id}" onchange="togglePaymentSelection('${safePayment.id}')"></td>
            <td>${safePayment.subject}</td>
            <td>${safePayment.projectName}</td>
            <td>${safePayment.payee}</td>
            <td>${safePayment.payeeCode}</td>
            <td class="text-end">${formatAmount(safePayment.amount)}</td>
            <td>${formatDate(safePayment.paymentDate)}</td>
            <td>${getStatusBadge(safePayment.status)}</td>
        `;
        
        tbody.appendChild(row);
    });
}

// === è²»ç”¨ãƒ‡ãƒ¼ã‚¿é–¢é€£ ===

function loadExpenses() {
    showLoading('expenseLoading');
    const searchTerm = document.getElementById('expenseSearch').value || '';
    const filterMonth = document.getElementById('expenseMonthFilter').value || '';
    
    google.script.run
        .withSuccessHandler(function(result) {
            showLoading('expenseLoading', false);
            try {
                if (result && result.success && result.data) {
                    currentExpenses = result.data;
                    displayDataWithFallback(result.data, displayExpenses, 'expenseTableBody', 'è²»ç”¨');
                    document.getElementById('expenseCount').textContent = result.data.length;
                    updateMonthFilter(result.data);
                    
                    if (result.data.length === 0) {
                        showStatus('è²»ç”¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
                    }
                } else {
                    currentExpenses = [];
                    displayDataWithFallback([], displayExpenses, 'expenseTableBody', 'è²»ç”¨');
                    document.getElementById('expenseCount').textContent = '0';
                    showStatus(result ? result.message : 'è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
                }
            } catch (error) {
                console.error('è²»ç”¨ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                currentExpenses = [];
                displayDataWithFallback([], displayExpenses, 'expenseTableBody', 'è²»ç”¨');
                showStatus('è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
            }
        })
        .withFailureHandler(function(error) {
            showLoading('expenseLoading', false);
            handleDataLoadError(error, 'è²»ç”¨');
            currentExpenses = [];
            displayDataWithFallback([], displayExpenses, 'expenseTableBody', 'è²»ç”¨');
        })
        .getExpenseData(searchTerm, filterMonth);
}

function displayExpenses(expenses) {
    const tbody = document.getElementById('expenseTableBody');
    
    expenses.forEach(expense => {
        const row = document.createElement('tr');
        if (expense.status === 'ç…§åˆæ¸ˆ') {
            row.classList.add('matched');
        }
        
        // å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿å–å¾—
        const safeExpense = {
            id: expense.id || '',
            projectName: expense.projectName || '',
            payee: expense.payee || '',
            payeeCode: expense.payeeCode || '',
            amount: expense.amount || 0,
            paymentDate: expense.paymentDate || '',
            status: expense.status || 'æœªå‡¦ç†'
        };
        
        row.innerHTML = `
            <td><input type="checkbox" class="expense-select" value="${safeExpense.id}" onchange="toggleExpenseSelection('${safeExpense.id}')"></td>
            <td>${safeExpense.projectName}</td>
            <td>${safeExpense.payee}</td>
            <td>${safeExpense.payeeCode}</td>
            <td class="text-end">${formatAmount(safeExpense.amount)}</td>
            <td>${formatDate(safeExpense.paymentDate)}</td>
            <td>${getStatusBadge(safeExpense.status)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editExpense('${safeExpense.id}')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteExpense('${safeExpense.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// === è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼é–¢é€£ ===

function loadMaster() {
    showLoading('masterLoading');
    const searchTerm = document.getElementById('masterSearch').value || '';
    
    google.script.run
        .withSuccessHandler(function(result) {
            showLoading('masterLoading', false);
            try {
                if (result && result.success && result.data) {
                    currentMaster = result.data;
                    displayDataWithFallback(result.data, displayMaster, 'masterTableBody', 'è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼');
                    document.getElementById('masterCount').textContent = result.data.length;
                    
                    if (result.data.length === 0) {
                        showStatus('è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
                    }
                } else {
                    currentMaster = [];
                    displayDataWithFallback([], displayMaster, 'masterTableBody', 'è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼');
                    document.getElementById('masterCount').textContent = '0';
                    showStatus(result ? result.message : 'è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
                }
            } catch (error) {
                console.error('è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                currentMaster = [];
                displayDataWithFallback([], displayMaster, 'masterTableBody', 'è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼');
                showStatus('è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
            }
        })
        .withFailureHandler(function(error) {
            showLoading('masterLoading', false);
            handleDataLoadError(error, 'è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼');
            currentMaster = [];
            displayDataWithFallback([], displayMaster, 'masterTableBody', 'è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼');
        })
        .getMasterData(searchTerm);
}

function displayMaster(masters) {
    const tbody = document.getElementById('masterTableBody');
    
    masters.forEach(master => {
        const row = document.createElement('tr');
        
        // å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿å–å¾—
        const safeMaster = {
            id: master.id || '',
            projectName: master.projectName || '',
            payee: master.payee || '',
            payeeCode: master.payeeCode || '',
            amount: master.amount || 0,
            paymentType: master.paymentType || 'æœˆé¡å›ºå®š',
            broadcastDays: master.broadcastDays || ''
        };
        
        row.innerHTML = `
            <td><input type="checkbox" class="master-select" value="${safeMaster.id}" onchange="toggleMasterSelection('${safeMaster.id}')"></td>
            <td>${safeMaster.projectName}</td>
            <td>${safeMaster.payee}</td>
            <td>${safeMaster.payeeCode}</td>
            <td class="text-end">${formatAmount(safeMaster.amount)}</td>
            <td>${getPaymentTypeBadge(safeMaster.paymentType)}</td>
            <td class="text-center">${formatBroadcastDays(safeMaster.broadcastDays)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editMaster('${safeMaster.id}')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteMaster('${safeMaster.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// === æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–° ===

function updateMonthFilter(expenses) {
    const monthFilter = document.getElementById('expenseMonthFilter');
    if (!monthFilter) return;
    
    const months = new Set();
    
    if (expenses && expenses.length > 0) {
        expenses.forEach(expense => {
            if (expense.paymentDate) {
                try {
                    const date = new Date(expense.paymentDate);
                    if (!isNaN(date.getTime())) {
                        const yearMonth = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        months.add(yearMonth);
                    }
                } catch (error) {
                    console.warn('æ—¥ä»˜è§£æã‚¨ãƒ©ãƒ¼:', expense.paymentDate);
                }
            }
        });
    }
    
    // ç¾åœ¨ã®é¸æŠã‚’ä¿å­˜
    const currentValue = monthFilter.value;
    
    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
    monthFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®æœˆ</option>';
    
    // æœˆã‚’é™é †ã§ã‚½ãƒ¼ãƒˆã—ã¦è¿½åŠ 
    Array.from(months).sort().reverse().forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = `${month.replace('-', 'å¹´')}æœˆ`;
        monthFilter.appendChild(option);
    });
    
    // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
    monthFilter.value = currentValue;
}

// === æ¤œç´¢é–¢æ•° ===

function searchPayments() {
    loadPayments();
}

function resetPaymentSearch() {
    document.getElementById('paymentSearch').value = '';
    loadPayments();
}

function searchExpenses() {
    loadExpenses();
}

function resetExpenseSearch() {
    document.getElementById('expenseSearch').value = '';
    document.getElementById('expenseMonthFilter').value = '';
    loadExpenses();
}

function searchMaster() {
    loadMaster();
}

function resetMasterSearch() {
    document.getElementById('masterSearch').value = '';
    loadMaster();
}

// === é¸æŠå‡¦ç† ===

function toggleAllPayments() {
    const selectAll = document.getElementById('selectAllPayments').checked;
    const checkboxes = document.querySelectorAll('.payment-select');
    
    selectedPayments.clear();
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        if (selectAll && checkbox.value) {
            selectedPayments.add(checkbox.value);
        }
    });
}

function togglePaymentSelection(id) {
    if (!id) return;
    
    if (selectedPayments.has(id)) {
        selectedPayments.delete(id);
    } else {
        selectedPayments.add(id);
    }
}

function toggleAllExpenses() {
    const selectAll = document.getElementById('selectAllExpenses').checked;
    const checkboxes = document.querySelectorAll('.expense-select');
    
    selectedExpenses.clear();
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        if (selectAll && checkbox.value) {
            selectedExpenses.add(checkbox.value);
        }
    });
}

function toggleExpenseSelection(id) {
    if (!id) return;
    
    if (selectedExpenses.has(id)) {
        selectedExpenses.delete(id);
    } else {
        selectedExpenses.add(id);
    }
}

function toggleAllMaster() {
    const selectAll = document.getElementById('selectAllMaster').checked;
    const checkboxes = document.querySelectorAll('.master-select');
    
    selectedMaster.clear();
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        if (selectAll && checkbox.value) {
            selectedMaster.add(checkbox.value);
        }
    });
}

function toggleMasterSelection(id) {
    if (!id) return;
    
    if (selectedMaster.has(id)) {
        selectedMaster.delete(id);
    } else {
        selectedMaster.add(id);
    }
}

// === æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿æ“ä½œ ===

function markSelectedPayments(status) {
    if (selectedPayments.size === 0) {
        showStatus('å‡¦ç†ã™ã‚‹æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
    }
    
    const updates = Array.from(selectedPayments).map(id => ({id, status}));
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showStatus(`${selectedPayments.size}ä»¶ã®æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã‚’${status}ã«ã—ã¾ã—ãŸ`, 'success');
                selectedPayments.clear();
                document.getElementById('selectAllPayments').checked = false;
                loadPayments();
            } else {
                showStatus(result ? result.message : 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .updateMultiplePaymentStatus(updates);
}

function matchWithExpenses() {
    showLoading('paymentLoading');
    
    google.script.run
        .withSuccessHandler(function(result) {
            showLoading('paymentLoading', false);
            if (result && result.success) {
                showStatus(result.message, 'success');
                loadPayments();
                if (document.querySelector('#expense-tab').classList.contains('active')) {
                    loadExpenses();
                }
            } else {
                showStatus(result ? result.message : 'ç…§åˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showLoading('paymentLoading', false);
            showStatus('ç…§åˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .matchExpensesWithPayments();
}

// === è²»ç”¨ãƒ‡ãƒ¼ã‚¿æ“ä½œ ===

function openExpenseModal(expenseId = null) {
    const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
    const title = document.getElementById('expenseModalTitle');
    
    if (expenseId) {
        title.textContent = 'è²»ç”¨ãƒ‡ãƒ¼ã‚¿ç·¨é›†';
        const expense = currentExpenses.find(e => e.id === expenseId);
        if (expense) {
            document.getElementById('expenseId').value = expense.id || '';
            document.getElementById('expenseProjectName').value = expense.projectName || '';
            document.getElementById('expensePayee').value = expense.payee || '';
            document.getElementById('expensePayeeCode').value = expense.payeeCode || '';
            document.getElementById('expenseAmount').value = expense.amount || '';
            document.getElementById('expensePaymentDate').value = expense.paymentDate ? expense.paymentDate.split('T')[0] : '';
            document.getElementById('expenseStatus').value = expense.status || 'æœªå‡¦ç†';
        }
    } else {
        title.textContent = 'è²»ç”¨ãƒ‡ãƒ¼ã‚¿æ–°è¦ä½œæˆ';
        document.getElementById('expenseForm').reset();
        document.getElementById('expenseId').value = '';
        document.getElementById('expenseStatus').value = 'æœªå‡¦ç†';
    }
    
    modal.show();
}

function editExpense(expenseId) {
    if (!expenseId) return;
    openExpenseModal(expenseId);
}

function saveExpense() {
    const form = document.getElementById('expenseForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const expenseData = {
        id: document.getElementById('expenseId').value,
        projectName: document.getElementById('expenseProjectName').value,
        payee: document.getElementById('expensePayee').value,
        payeeCode: document.getElementById('expensePayeeCode').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        paymentDate: document.getElementById('expensePaymentDate').value,
        status: document.getElementById('expenseStatus').value
    };
    
    const isNew = !expenseData.id;
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showStatus(result.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
                loadExpenses();
            } else {
                showStatus(result ? result.message : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .saveExpense(expenseData, isNew);
}

function deleteExpense(expenseId) {
    if (!expenseId) return;
    
    const expense = currentExpenses.find(e => e.id === expenseId);
    if (expense && confirm(`è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã€Œ${expense.projectName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        google.script.run
            .withSuccessHandler(function(result) {
                if (result && result.success) {
                    showStatus(result.message, 'success');
                    loadExpenses();
                } else {
                    showStatus(result ? result.message : 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                }
            })
            .withFailureHandler(function(error) {
                showStatus('è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
            })
            .deleteData('è²»ç”¨ãƒ‡ãƒ¼ã‚¿', expenseId);
    }
}

function deleteSelectedExpenses() {
    if (selectedExpenses.size === 0) {
        showStatus('å‰Šé™¤ã™ã‚‹è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
    }
    
    if (confirm(`é¸æŠã•ã‚ŒãŸ${selectedExpenses.size}ä»¶ã®è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        const promises = Array.from(selectedExpenses).map(id => {
            return new Promise((resolve) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(resolve)
                    .deleteData('è²»ç”¨ãƒ‡ãƒ¼ã‚¿', id);
            });
        });
        
        Promise.all(promises).then(() => {
            showStatus(`${selectedExpenses.size}ä»¶ã®è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
            selectedExpenses.clear();
            document.getElementById('selectAllExpenses').checked = false;
            loadExpenses();
        });
    }
}

function duplicateSelectedExpense() {
    if (selectedExpenses.size === 0) {
        showStatus('è¤‡è£½ã™ã‚‹è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
    }
    
    const expenseId = Array.from(selectedExpenses)[0];
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showStatus(result.message, 'success');
                loadExpenses();
            } else {
                showStatus(result ? result.message : 'è¤‡è£½ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®è¤‡è£½ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .duplicateData('è²»ç”¨ãƒ‡ãƒ¼ã‚¿', expenseId);
}

function matchExpensesWithPayments() {
    showLoading('expenseLoading');
    
    google.script.run
        .withSuccessHandler(function(result) {
            showLoading('expenseLoading', false);
            if (result && result.success) {
                showStatus(result.message, 'success');
                loadExpenses();
                if (document.querySelector('#payment-tab').classList.contains('active')) {
                    loadPayments();
                }
            } else {
                showStatus(result ? result.message : 'ç…§åˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showLoading('expenseLoading', false);
            showStatus('ç…§åˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .matchExpensesWithPayments();
}

function exportExpensesCsv() {
    google.script.run
        .withSuccessHandler(function(base64Content) {
            if (base64Content) {
                downloadCsv(base64Content, `è²»ç”¨ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0, 10)}.csv`);
                showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
            } else {
                showStatus('CSVãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .exportExpensesToCsv();
}

// === è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼æ“ä½œ ===

function openMasterModal(masterId = null) {
    const modal = new bootstrap.Modal(document.getElementById('masterModal'));
    const title = document.getElementById('masterModalTitle');
    
    if (masterId) {
        title.textContent = 'è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ç·¨é›†';
        const master = currentMaster.find(m => m.id === masterId);
        if (master) {
            document.getElementById('masterId').value = master.id || '';
            document.getElementById('masterProjectName').value = master.projectName || '';
            document.getElementById('masterPayee').value = master.payee || '';
            document.getElementById('masterPayeeCode').value = master.payeeCode || '';
            document.getElementById('masterAmount').value = master.amount || '';
            document.getElementById('masterPaymentType').value = master.paymentType || 'æœˆé¡å›ºå®š';
            document.getElementById('masterStartDate').value = master.startDate ? master.startDate.split('T')[0] : '';
            document.getElementById('masterEndDate').value = master.endDate ? master.endDate.split('T')[0] : '';
            
            // æ”¾é€æ›œæ—¥ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
            const broadcastDays = (master.broadcastDays || '').split(',');
            const weekdays = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            const weekdayIds = ['broadcastMon', 'broadcastTue', 'broadcastWed', 'broadcastThu', 'broadcastFri', 'broadcastSat', 'broadcastSun'];
            
            weekdayIds.forEach((id, index) => {
                const element = document.getElementById(id);
                if (element) {
                    element.checked = broadcastDays.includes(weekdays[index]);
                }
            });
        }
    } else {
        title.textContent = 'è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼æ–°è¦ä½œæˆ';
        document.getElementById('masterForm').reset();
        document.getElementById('masterId').value = '';
        document.getElementById('masterPaymentType').value = 'æœˆé¡å›ºå®š';
        
        // æ”¾é€æ›œæ—¥ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
        const weekdayIds = ['broadcastMon', 'broadcastTue', 'broadcastWed', 'broadcastThu', 'broadcastFri', 'broadcastSat', 'broadcastSun'];
        weekdayIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.checked = false;
            }
        });
    }
    
    modal.show();
}

function editMaster(masterId) {
    if (!masterId) return;
    openMasterModal(masterId);
}

function saveMaster() {
    const form = document.getElementById('masterForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // æ”¾é€æ›œæ—¥ã‚’å–å¾—
    const weekdays = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
    const weekdayIds = ['broadcastMon', 'broadcastTue', 'broadcastWed', 'broadcastThu', 'broadcastFri', 'broadcastSat', 'broadcastSun'];
    const selectedDays = [];
    
    weekdayIds.forEach((id, index) => {
        const element = document.getElementById(id);
        if (element && element.checked) {
            selectedDays.push(weekdays[index]);
        }
    });
    
    const masterData = {
        id: document.getElementById('masterId').value,
        projectName: document.getElementById('masterProjectName').value,
        payee: document.getElementById('masterPayee').value,
        payeeCode: document.getElementById('masterPayeeCode').value,
        amount: parseFloat(document.getElementById('masterAmount').value),
        paymentType: document.getElementById('masterPaymentType').value,
        startDate: document.getElementById('masterStartDate').value,
        endDate: document.getElementById('masterEndDate').value,
        broadcastDays: selectedDays.join(',')
    };
    
    const isNew = !masterData.id;
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showStatus(result.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('masterModal')).hide();
                loadMaster();
            } else {
                showStatus(result ? result.message : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .saveMaster(masterData, isNew);
}

function deleteMaster(masterId) {
    if (!masterId) return;
    
    const master = currentMaster.find(m => m.id === masterId);
    if (master && confirm(`è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ã€Œ${master.projectName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        google.script.run
            .withSuccessHandler(function(result) {
                if (result && result.success) {
                    showStatus(result.message, 'success');
                    loadMaster();
                } else {
                    showStatus(result ? result.message : 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                }
            })
            .withFailureHandler(function(error) {
                showStatus('è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
            })
            .deleteData('è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼', masterId);
    }
}

function deleteSelectedMaster() {
    if (selectedMaster.size === 0) {
        showStatus('å‰Šé™¤ã™ã‚‹è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
    }
    
    if (confirm(`é¸æŠã•ã‚ŒãŸ${selectedMaster.size}ä»¶ã®è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        const promises = Array.from(selectedMaster).map(id => {
            return new Promise((resolve) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(resolve)
                    .deleteData('è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼', id);
            });
        });
        
        Promise.all(promises).then(() => {
            showStatus(`${selectedMaster.size}ä»¶ã®è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
            selectedMaster.clear();
            document.getElementById('selectAllMaster').checked = false;
            loadMaster();
        });
    }
}

function duplicateSelectedMaster() {
    if (selectedMaster.size === 0) {
        showStatus('è¤‡è£½ã™ã‚‹è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
    }
    
    const masterId = Array.from(selectedMaster)[0];
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showStatus(result.message, 'success');
                loadMaster();
            } else {
                showStatus(result ? result.message : 'è¤‡è£½ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®è¤‡è£½ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .duplicateData('è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼', masterId);
}

function exportMasterCsv() {
    google.script.run
        .withSuccessHandler(function(base64Content) {
            if (base64Content) {
                downloadCsv(base64Content, `è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼_${new Date().toISOString().slice(0, 10)}.csv`);
                showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
            } else {
                showStatus('CSVãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .exportMasterToCsv();
}

function forceRefresh() {
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showStatus(result.message, 'success');
                loadMaster();
            } else {
                showStatus(result ? result.message : 'å¼·åˆ¶æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('å¼·åˆ¶æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .forceRefreshData();
}

function debugSpreadsheet() {
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                console.log('ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', result);
                showStatus(result.message, 'info');
            } else {
                showStatus(result ? result.message : 'ãƒ‡ãƒãƒƒã‚°å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('ãƒ‡ãƒãƒƒã‚°å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .debugSpreadsheetContent();
}

function initializeSystem() {
    if (confirm('ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) {
        google.script.run
            .withSuccessHandler(function(result) {
                if (result && result.success) {
                    showStatus(result.message, 'success');
                    loadStats();
                    loadPayments();
                } else {
                    showStatus(result ? result.message : 'åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                }
            })
            .withFailureHandler(function(error) {
                showStatus('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
            })
            .initializeSheets();
    }
}

// === CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿å‡¦ç† ===

function handleFileImport(file, type) {
    if (!file) return;
    
    showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 'info');
    console.log('ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:', {
        name: file.name,
        size: file.size,
        type: file.type,
        lastModified: new Date(file.lastModified)
    });
    
    // ã¾ãšãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œï¼ˆUTF-8ï¼‰
    const reader = new FileReader();
    reader.onload = function(e) {
        const csvContent = e.target.result;
        console.log('UTF-8ã¨ã—ã¦èª­ã¿è¾¼ã¿æˆåŠŸ');
        console.log('å†…å®¹ã®æœ€åˆã®200æ–‡å­—:', csvContent.substring(0, 200));
        
        // æ—¥æœ¬èªãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (csvContent.includes('æ¡ˆä»¶å') || csvContent.includes('æ ªå¼ä¼šç¤¾')) {
            console.log('æ—¥æœ¬èªãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            importWithContent(csvContent, type);
        } else {
            console.log('æ—¥æœ¬èªãŒæ–‡å­—åŒ–ã‘ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚Shift-JISã§å†è©¦è¡Œ...');
            // Shift-JISã§å†è©¦è¡Œ
            const readerSJIS = new FileReader();
            readerSJIS.onload = function(e2) {
                const sjisContent = e2.target.result;
                console.log('Shift-JISã¨ã—ã¦èª­ã¿è¾¼ã¿æˆåŠŸ');
                console.log('å†…å®¹ã®æœ€åˆã®200æ–‡å­—:', sjisContent.substring(0, 200));
                importWithContent(sjisContent, type);
            };
            readerSJIS.onerror = function() {
                console.log('Shift-JISèª­ã¿è¾¼ã¿å¤±æ•—ã€‚UTF-8ã§é€²è¡Œã—ã¾ã™ã€‚');
                importWithContent(csvContent, type);
            };
            readerSJIS.readAsText(file, 'shift_jis');
        }
    };
    
    reader.onerror = function() {
        showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
    };
    
    // UTF-8ã¨ã—ã¦èª­ã¿è¾¼ã¿
    reader.readAsText(file, 'UTF-8');
}

function importWithContent(csvContent, type) {
    const functionName = type === 'master' ? 'importMasterCsvText' : 'importExpensesFromCsv';
    const loadFunction = type === 'master' ? loadMaster : loadExpenses;
    
    console.log(`${functionName}ã‚’å‘¼ã³å‡ºã—ä¸­...`);
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('GASé–¢æ•°å®Ÿè¡Œçµæœ:', result);
            if (result && result.success) {
                let message = result.message || 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ';
                
                // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤º
                if (result.errorCount && result.errorCount > 0) {
                    console.log('ã‚¨ãƒ©ãƒ¼è©³ç´°:', result.errorDetails);
                    
                    // ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
                    if (result.errorDetails && result.errorDetails.length > 0) {
                        const errorSummary = result.errorDetails.slice(0, 5).join('\n');
                        message += `\n\nä¸»ãªã‚¨ãƒ©ãƒ¼:\n${errorSummary}`;
                        if (result.errorDetails.length > 5) {
                            message += `\n... ä»–${result.errorDetails.length - 5}ä»¶ã®ã‚¨ãƒ©ãƒ¼`;
                        }
                    }
                    
                    showStatus(message, 'warning');
                } else {
                    showStatus(message, 'success');
                }
                
                loadFunction();
            } else {
                let errorMessage = result ? (result.message || 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ') : 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (result && result.errorDetails) {
                    errorMessage += '\nè©³ç´°: ' + result.errorDetails.join(', ');
                }
                showStatus(errorMessage, 'danger');
            }
        })
        .withFailureHandler(function(error) {
            console.error('GASå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
            showStatus('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        [functionName](csvContent);
}

// === ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°ï¼ˆCSVï¼‰ ===

function downloadCsv(base64Content, filename) {
    try {
        const byteCharacters = atob(base64Content);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'text/csv; charset=UTF-8' });
        
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        
        window.URL.revokeObjectURL(link.href);
    } catch (error) {
        console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
    }
}

// === è¨ºæ–­æ©Ÿèƒ½ ===

/**
 * ç°¡æ˜“è¨ºæ–­
 */
function runQuickDiagnosis() {
    console.log('=== ç°¡æ˜“è¨ºæ–­é–‹å§‹ ===');
    
    showStatus('ç°¡æ˜“è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...', 'info');
    
    // 1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºæœ¬ãƒã‚§ãƒƒã‚¯
    const frontendCheck = {
        domElements: checkDOMElements(),
        javaScriptFunctions: checkJavaScriptFunctions(),
        gasConnection: checkGASConnection()
    };
    
    console.log('ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨ºæ–­çµæœ:', frontendCheck);
    
    // 2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãƒã‚§ãƒƒã‚¯
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±å–å¾—çµæœ:', result);
            
            let message = 'ğŸ“‹ ç°¡æ˜“è¨ºæ–­çµæœ\n\n';
            
            // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµæœ
            message += 'â–  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰\n';
            message += `DOMè¦ç´ : ${frontendCheck.domElements.success ? 'âœ…' : 'âŒ'}\n`;
            message += `JavaScripté–¢æ•°: ${frontendCheck.javaScriptFunctions.success ? 'âœ…' : 'âŒ'}\n`;
            message += `GASæ¥ç¶š: ${frontendCheck.gasConnection.success ? 'âœ…' : 'âŒ'}\n\n`;
            
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµæœ
            message += 'â–  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰\n';
            if (result && result.success) {
                message += `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹: âœ…\n`;
                message += `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå: ${result.spreadsheetName || 'ä¸æ˜'}\n`;
                message += `ã‚·ãƒ¼ãƒˆæ•°: ${result.sheetCount || 0}\n\n`;
                
                message += 'ğŸ‰ åŸºæœ¬çš„ãªæ¥ç¶šã¯æ­£å¸¸ã§ã™ï¼\n';
                message += 'ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€ä»¥ä¸‹ã‚’è©¦ã—ã¦ãã ã•ã„ï¼š\n';
                message += '1. åˆæœŸåŒ–ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n';
                message += '2. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ\n';
                message += '3. ãƒ–ãƒ©ã‚¦ã‚¶ã®æ›´æ–°';
            } else {
                message += `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹: âŒ\n`;
                message += `ã‚¨ãƒ©ãƒ¼: ${result ? result.error : 'ä¸æ˜'}\n\n`;
                
                message += 'âš ï¸ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™\n';
                message += 'ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š\n';
                message += '1. Code.gsã®SPREADSHEET_IDãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹\n';
                message += '2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®š\n';
                message += '3. GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¨©é™';
            }
            
            console.log(message);
            alert(message);
            showStatus('ç°¡æ˜“è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸ', result && result.success ? 'success' : 'warning');
        })
        .withFailureHandler(function(error) {
            console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            
            let message = 'ğŸ“‹ ç°¡æ˜“è¨ºæ–­çµæœ\n\n';
            message += 'â–  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰\n';
            message += `DOMè¦ç´ : ${frontendCheck.domElements.success ? 'âœ…' : 'âŒ'}\n`;
            message += `JavaScripté–¢æ•°: ${frontendCheck.javaScriptFunctions.success ? 'âœ…' : 'âŒ'}\n`;
            message += `GASæ¥ç¶š: ${frontendCheck.gasConnection.success ? 'âœ…' : 'âŒ'}\n\n`;
            
            message += 'â–  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰\n';
            message += `GASé–¢æ•°å®Ÿè¡Œ: âŒ\n`;
            message += `ã‚¨ãƒ©ãƒ¼: ${error.toString()}\n\n`;
            
            message += 'ğŸš¨ é‡å¤§ãªå•é¡ŒãŒã‚ã‚Šã¾ã™\n';
            message += 'ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š\n';
            message += '1. GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ããƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹\n';
            message += '2. ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹\n';
            message += '3. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š';
            
            console.log(message);
            alert(message);
            showStatus('ç°¡æ˜“è¨ºæ–­ã§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ', 'danger');
        })
        .debugSpreadsheetStatus();
}

/**
 * ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—è¨ºæ–­
 */
function runStepByStepDiagnosis() {
    console.log('=== ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—è¨ºæ–­é–‹å§‹ ===');
    
    showStatus('ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—è¨ºæ–­ã‚’å®Ÿè¡Œä¸­...', 'info');
    
    // åŸºæœ¬çš„ãªã‚¹ãƒ†ãƒƒãƒ—è¨ºæ–­ã‚’å®Ÿè¡Œ
    const step1 = checkDOMElements();
    const step2 = checkJavaScriptFunctions();
    const step3 = checkGASConnection();
    
    let message = 'ğŸ” ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—è¨ºæ–­çµæœ\n\n';
    message += `ã‚¹ãƒ†ãƒƒãƒ—1 - DOMè¦ç´ ãƒã‚§ãƒƒã‚¯: ${step1.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n`;
    message += `ã‚¹ãƒ†ãƒƒãƒ—2 - JavaScripté–¢æ•°ãƒã‚§ãƒƒã‚¯: ${step2.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n`;
    message += `ã‚¹ãƒ†ãƒƒãƒ—3 - GASæ¥ç¶šãƒã‚§ãƒƒã‚¯: ${step3.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n\n`;
    
    const successCount = [step1, step2, step3].filter(step => step.success).length;
    message += `æˆåŠŸç‡: ${successCount}/3 (${Math.round(successCount/3*100)}%)\n\n`;
    
    if (successCount === 3) {
        message += 'ğŸ‰ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã¯å…¨ã¦æ­£å¸¸ã§ã™ï¼\n';
        message += 'ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã«å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€è©³ç´°è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
    } else {
        message += 'âš ï¸ å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\n';
        
        if (!step1.success) message += `\nDOMè¦ç´ ã‚¨ãƒ©ãƒ¼: ${step1.error}`;
        if (!step2.success) message += `\nJavaScripté–¢æ•°ã‚¨ãƒ©ãƒ¼: ${step2.error}`;
        if (!step3.success) message += `\nGASæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${step3.error}`;
    }
    
    console.log(message);
    alert(message);
    showStatus('ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸ', successCount === 3 ? 'success' : 'warning');
}

/**
 * è©³ç´°ãƒ‡ãƒãƒƒã‚°è¨ºæ–­
 */
function runDetailedDebugDiagnosis() {
    console.log('=== è©³ç´°ãƒ‡ãƒãƒƒã‚°è¨ºæ–­é–‹å§‹ ===');
    
    showStatus('è©³ç´°è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...', 'info');
    testBasicGASConnection();
}

/**
 * ç·åˆè¨ºæ–­
 */
function runCompleteDiagnosis() {
    console.log('=== ç·åˆè¨ºæ–­é–‹å§‹ ===');
    
    showStatus('ç·åˆè¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...', 'info');
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
            .withSuccessHandler(function(backendResult) {
                console.log('ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨ºæ–­çµæœ:', backendResult);
                
                let message = 'ğŸ” ç·åˆè¨ºæ–­çµæœ\n\n';
                
                if (backendResult && backendResult.success) {
                    const diagnosis = backendResult.diagnosis;
                    message += 'â–  ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹\n';
                    message += `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹: ${diagnosis.summary.spreadsheetAccess ? 'âœ…' : 'âŒ'}\n`;
                    message += `ãƒ‡ãƒ¼ã‚¿å­˜åœ¨: ${diagnosis.summary.dataExists ? 'âœ…' : 'âŒ'}\n`;
                    message += `ãƒ‡ãƒ¼ã‚¿æ§‹é€ : ${diagnosis.summary.dataStructure ? 'âœ…' : 'âŒ'}\n`;
                    message += `ç·åˆçŠ¶æ…‹: ${diagnosis.summary.overallStatus}\n\n`;
                    
                    if (diagnosis.recommendations.length > 0) {
                        message += 'æ¨å¥¨å¯¾å¿œ:\n';
                        diagnosis.recommendations.forEach(rec => {
                            message += `â€¢ ${rec}\n`;
                        });
                    }
                } else {
                    message += `ã‚¨ãƒ©ãƒ¼: ${backendResult ? backendResult.message : 'è¨ºæ–­ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
                }
                
                console.log(message);
                alert(message);
                showStatus('ç·åˆè¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸ', backendResult && backendResult.success ? 'success' : 'warning');
            })
            .withFailureHandler(function(error) {
                console.error('ç·åˆè¨ºæ–­ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ç·åˆè¨ºæ–­ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
            })
            .comprehensiveDiagnosis();
    } else {
        showStatus('GASæ¥ç¶šãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'danger');
    }
}

/**
 * å€‹åˆ¥ãƒã‚§ãƒƒã‚¯é–¢æ•°
 */
function checkDOMElements() {
    const requiredElements = [
        'masterTableBody', 
        'expenseTableBody', 
        'paymentTableBody',
        'masterLoading',
        'expenseLoading', 
        'paymentLoading'
    ];
    
    const missingElements = [];
    
    requiredElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (!element) {
            missingElements.push(elementId);
        }
    });
    
    if (missingElements.length > 0) {
        return {
            success: false,
            error: `å¿…è¦ãªDOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missingElements.join(', ')}`,
            solution: 'index.htmlãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚'
        };
    }
    
    return { success: true };
}

function checkJavaScriptFunctions() {
    const requiredFunctions = [
        'loadMaster', 
        'displayMaster', 
        'showStatus', 
        'loadExpenses', 
        'loadPayments'
    ];
    
    const missingFunctions = [];
    
    requiredFunctions.forEach(funcName => {
        if (typeof window[funcName] !== 'function') {
            missingFunctions.push(funcName);
        }
    });
    
    if (missingFunctions.length > 0) {
        return {
            success: false,
            error: `å¿…è¦ãªJavaScripté–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“: ${missingFunctions.join(', ')}`,
            solution: 'script.htmlãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã€JavaScriptã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
        };
    }
    
    return { success: true };
}

function checkGASConnection() {
    if (typeof google === 'undefined' || !google.script || !google.script.run) {
        return {
            success: false,
            error: 'Google Apps Scriptæ¥ç¶šãŒåˆ©ç”¨ã§ãã¾ã›ã‚“',
            solution: 'GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒWebã‚¢ãƒ—ãƒªã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤URLã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
        };
    }
    
    return { success: true };
}

/**
 * åŸºæœ¬GASæ¥ç¶šãƒ†ã‚¹ãƒˆ
 */
function testBasicGASConnection() {
    console.log('åŸºæœ¬GASæ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ:', result);
            showStatus('åŸºæœ¬æ¥ç¶š: æˆåŠŸ', 'success');
            setTimeout(() => testDataRetrieval(), 1000);
        })
        .withFailureHandler(function(error) {
            console.error('åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            showStatus('åŸºæœ¬æ¥ç¶š: å¤±æ•— - ' + error, 'danger');
            
            setTimeout(() => {
                alert('ğŸš¨ åŸºæœ¬GASæ¥ç¶šã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\n' +
                      `ã‚¨ãƒ©ãƒ¼å†…å®¹:\n${error}\n\n` +
                      'æ¨å¥¨è§£æ±ºç­–:\n' +
                      'GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n' +
                      '1. ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç®¡ç†ã€\n' +
                      '2. ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã€Œå…¨å“¡ã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª\n' +
                      '3. æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä½œæˆã—ã¦ã¿ã¦ãã ã•ã„');
            }, 1000);
        })
        .getSystemInfo();
}

/**
 * ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
 */
function testDataRetrieval() {
    console.log('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ãƒ†ã‚¹ãƒˆä¸­...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆçµæœ:', result);
            
            if (result && result.data !== undefined) {
                showStatus(`ãƒ‡ãƒ¼ã‚¿å–å¾—: æˆåŠŸ (${result.data.length}ä»¶)`, 'success');
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’å®Ÿéš›ã«è¡¨ç¤ºã—ã¦ã¿ã‚‹
                try {
                    displayMaster(result.data);
                    showStatus('ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º: æˆåŠŸ', 'success');
                    
                    setTimeout(() => {
                        showStatus('ğŸ‰ å…¨ã¦ã®è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                        showCompleteDiagnosticSummary();
                    }, 1000);
                } catch (displayError) {
                    console.error('ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', displayError);
                    showStatus('ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º: å¤±æ•— - ' + displayError, 'danger');
                    
                    setTimeout(() => {
                        alert('ğŸš¨ ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\n' +
                              `ã‚¨ãƒ©ãƒ¼å†…å®¹:\n${displayError.toString()}\n\n` +
                              'æ¨å¥¨è§£æ±ºç­–:\n' +
                              'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®è¡¨ç¤ºé–¢æ•°ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚\n' +
                              'ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§JavaScriptã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }, 1000);
                }
            } else {
                showStatus('ãƒ‡ãƒ¼ã‚¿å–å¾—: ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼', 'warning');
                console.error('äºˆæœŸã—ãªã„ãƒ‡ãƒ¼ã‚¿å½¢å¼:', result);
                
                setTimeout(() => {
                    alert('ğŸš¨ ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼\n\n' +
                          'ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“\n\n' +
                          'æ¨å¥¨è§£æ±ºç­–:\n' +
                          'GASå´ã®ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ã®æˆ»ã‚Šå€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }, 1000);
            }
        })
        .withFailureHandler(function(error) {
            console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', error);
            showStatus('ãƒ‡ãƒ¼ã‚¿å–å¾—: å¤±æ•— - ' + error, 'danger');
            analyzeDataRetrievalError(error);
        })
        .getMasterData('');
}

/**
 * ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ã®åˆ†æ
 */
function analyzeDataRetrievalError(error) {
    const errorString = error.toString().toLowerCase();
    
    let analysis = 'âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼åˆ†æ\n\n';
    let recommendation = '';
    
    if (errorString.includes('timeout') || errorString.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
        analysis += 'åŸå› : å®Ÿè¡Œæ™‚é–“è¶…é\n';
        recommendation = '1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿é‡ã‚’ç¢ºèª\n' +
                        '2. è¤‡é›‘ãªè¨ˆç®—å¼ãŒã‚ã‚Œã°ç°¡ç´ åŒ–\n' +
                        '3. ä¸€æ™‚çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’å°‘ãªãã—ã¦è©¦è¡Œ';
    } else if (errorString.includes('permission') || errorString.includes('æ¨©é™')) {
        analysis += 'åŸå› : ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ä¸è¶³\n';
        recommendation = '1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ç¢ºèª\n' +
                        '2. GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¨©é™ã‚’å†æ‰¿èª\n' +
                        '3. Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã™';
    } else if (errorString.includes('not found') || errorString.includes('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
        analysis += 'åŸå› : ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¾ãŸã¯ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„\n';
        recommendation = '1. SPREADSHEET_IDãŒæ­£ã—ã„ã‹ç¢ºèª\n' +
                        '2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª\n' +
                        '3. åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¦ã‚·ãƒ¼ãƒˆã‚’å†ä½œæˆ';
    } else {
        analysis += 'åŸå› : ä¸æ˜ãªã‚¨ãƒ©ãƒ¼\n';
        recommendation = '1. ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦å†è©¦è¡Œ\n' +
                        '2. åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§è©¦è¡Œ\n' +
                        '3. ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œ';
    }
    
    analysis += '\næ¨å¥¨å¯¾å¿œ:\n' + recommendation;
    
    console.error(analysis);
    setTimeout(() => { alert(analysis); }, 2000);
}

/**
 * è¨ºæ–­ã‚µãƒãƒªãƒ¼è¡¨ç¤º
 */
function showCompleteDiagnosticSummary() {
    const summary = 'ğŸ¯ è¨ºæ–­å®Œäº†ã‚µãƒãƒªãƒ¼\n\n' +
                   'åŸºæœ¬æ¥ç¶š: æ­£å¸¸\n' +
                   'ãƒ‡ãƒ¼ã‚¿å–å¾—: æ­£å¸¸\n' +
                   'ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º: æ­£å¸¸\n\n' +
                   'âœ… ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼\n\n' +
                   'ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯:\n' +
                   '1. ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™\n' +
                   '2. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ãã ã•ã„\n' +
                   '3. CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãã ã•ã„';
    
    console.log(summary);
    alert(summary);
}

/**
 * ç·Šæ€¥ãƒ‡ãƒ¼ã‚¿ä½œæˆ
 */
function createEmergencyTestData() {
    if (!confirm('ç·Šæ€¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚')) {
        return;
    }
    
    showStatus('ç·Šæ€¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆä¸­...', 'info');
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('ç·Šæ€¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆçµæœ:', result);
            
            if (result && result.success) {
                showStatus('ç·Šæ€¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ: æˆåŠŸ', 'success');
                
                // å³åº§ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                setTimeout(() => {
                    loadMaster();
                    loadExpenses();
                    loadPayments();
                    loadStats();
                }, 1000);
                
                alert('âœ… ç·Šæ€¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã—ãŸï¼\n\n' +
                      'ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n' +
                      'æ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚Œã°ã€ã‚·ã‚¹ãƒ†ãƒ ã¯å‹•ä½œã—ã¦ã„ã¾ã™ã€‚');
            } else {
                showStatus('ç·Šæ€¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ: å¤±æ•—', 'danger');
                alert('âŒ ç·Šæ€¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + 
                      (result ? result.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            }
        })
        .withFailureHandler(function(error) {
            console.error('ç·Šæ€¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            showStatus('ç·Šæ€¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ: ã‚¨ãƒ©ãƒ¼', 'danger');
            alert('âŒ ç·Šæ€¥ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\n' + error);
        })
        .createMinimalTestData();
}

/**
 * æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
 */
function testManualDataDisplay() {
    console.log('æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...');
    
    // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ
    const testData = [
        {
            id: 'TEST_001',
            projectName: 'æ‰‹å‹•ãƒ†ã‚¹ãƒˆæ¡ˆä»¶',
            payee: 'æ‰‹å‹•ãƒ†ã‚¹ãƒˆä¼šç¤¾',
            payeeCode: 'MANUAL001',
            amount: 50000,
            paymentType: 'æœˆé¡å›ºå®š',
            startDate: '2024-01-01',
            endDate: '2024-12-31',
            broadcastDays: 'æœˆ,æ°´,é‡‘',
            createdAt: new Date()
        }
    ];
    
    try {
        console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§displayMasteré–¢æ•°ã‚’å®Ÿè¡Œ...');
        displayMaster(testData);
        
        showStatus('æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ†ã‚¹ãƒˆ: æˆåŠŸ', 'success');
        alert('âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®è¡¨ç¤ºæ©Ÿèƒ½ã¯æ­£å¸¸ã§ã™ï¼\n\n' +
              'å•é¡Œã¯ãƒ‡ãƒ¼ã‚¿å–å¾—å´ã«ã‚ã‚Šã¾ã™ã€‚\n' +
              'GASå´ã®é–¢æ•°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    } catch (error) {
        console.error('æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        showStatus('æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ†ã‚¹ãƒˆ: å¤±æ•—', 'danger');
        alert('âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®è¡¨ç¤ºæ©Ÿèƒ½ã«å•é¡ŒãŒã‚ã‚Šã¾ã™\n\n' +
              'ã‚¨ãƒ©ãƒ¼: ' + error.toString() + '\n\n' +
              'script.htmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
}

/**
 * ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ï¼‰
 */
function createTestDataFromFrontend() {
    if (!confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚')) {
        return;
    }
    
    showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ã„ã¾ã™...', 'info');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showStatus(result.message, 'success');
                // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                setTimeout(() => {
                    loadMaster();
                    loadExpenses();
                    loadPayments();
                    loadStats();
                }, 1000);
            } else {
                showStatus(result ? result.message : 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .createTestData();
}

/**
 * å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ï¼‰
 */
function clearAllDataFromFrontend() {
    if (!confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
        return;
    }
    
    if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«å¤±ã‚ã‚Œã¾ã™ã€‚')) {
        return;
    }
    
    showStatus('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™...', 'info');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showStatus(result.message, 'success');
                // ç”»é¢ã‚’ã‚¯ãƒªã‚¢
                setTimeout(() => {
                    loadMaster();
                    loadExpenses();
                    loadPayments();
                    loadStats();
                }, 1000);
            } else {
                showStatus(result ? result.message : 'ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .clearAllDataForDiagnosis();
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«è¨ºæ–­é–¢æ•°ã‚’è¿½åŠ 
window.runQuickDiagnosis = runQuickDiagnosis;
window.runCompleteDiagnosis = runCompleteDiagnosis;
window.runStepByStepDiagnosis = runStepByStepDiagnosis;
window.runDetailedDebugDiagnosis = runDetailedDebugDiagnosis;
window.createEmergencyTestData = createEmergencyTestData;
window.testManualDataDisplay = testManualDataDisplay;
window.createTestDataFromFrontend = createTestDataFromFrontend;
window.clearAllDataFromFrontend = clearAllDataFromFrontend;

// æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£ã®JavaScripté–¢æ•°

let currentPaymentCsvContent = '';
let currentPaymentCsvHeaders = [];
let paymentMappingSettings = {};

/**
 * æ”¯æ‰•ã„CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæ¨™æº–ï¼‰- Shift-JISå¯¾å¿œå¼·åŒ–ç‰ˆ
 */
function handlePaymentFileImport(file) {
    if (!file) return;
    
    showStatus('æ”¯æ‰•ã„CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 'info');
    console.log('æ”¯æ‰•ã„ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:', {
        name: file.name,
        size: file.size,
        type: file.type,
        lastModified: new Date(file.lastModified)
    });
    
    // ã¾ãšUTF-8ã§èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
    readCsvWithEncoding(file, 'UTF-8')
        .then(csvContent => {
            console.log('UTF-8èª­ã¿è¾¼ã¿æˆåŠŸ');
            console.log('å†…å®¹ã®æœ€åˆã®200æ–‡å­—:', csvContent.substring(0, 200));
            
            // æ—¥æœ¬èªã®æ–‡å­—åŒ–ã‘ãƒã‚§ãƒƒã‚¯
            if (isValidJapaneseContent(csvContent)) {
                console.log('UTF-8: æ—¥æœ¬èªãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
                importPaymentWithContent(csvContent);
            } else {
                console.log('UTF-8: æ—¥æœ¬èªãŒæ–‡å­—åŒ–ã‘ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚Shift-JISã§å†è©¦è¡Œ...');
                // Shift-JISã§å†è©¦è¡Œ
                return readCsvWithEncoding(file, 'Shift_JIS');
            }
        })
        .then(sjisContent => {
            if (sjisContent) {
                console.log('Shift-JISèª­ã¿è¾¼ã¿æˆåŠŸ');
                console.log('å†…å®¹ã®æœ€åˆã®200æ–‡å­—:', sjisContent.substring(0, 200));
                
                if (isValidJapaneseContent(sjisContent)) {
                    console.log('Shift-JIS: æ—¥æœ¬èªãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
                    importPaymentWithContent(sjisContent);
                } else {
                    console.log('Shift-JIS: æ–‡å­—åŒ–ã‘ãŒè§£æ±ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚UTF-8ã§é€²è¡Œã—ã¾ã™ã€‚');
                    // æœ€åˆã®UTF-8ã®çµæœã§é€²è¡Œ
                    return readCsvWithEncoding(file, 'UTF-8')
                        .then(fallbackContent => importPaymentWithContent(fallbackContent));
                }
            }
        })
        .catch(error => {
            console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'danger');
        });
}

/**
 * æŒ‡å®šã•ã‚ŒãŸã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
 */
function readCsvWithEncoding(file, encoding) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            resolve(e.target.result);
        };
        
        reader.onerror = function() {
            reject(new Error(`${encoding}ã§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ`));
        };
        
        try {
            reader.readAsText(file, encoding);
        } catch (error) {
            reject(new Error(`${encoding}ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“`));
        }
    });
}

/**
 * æ—¥æœ¬èªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
 */
function isValidJapaneseContent(content) {
    // ä¸€èˆ¬çš„ãªæ—¥æœ¬èªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
    const japaneseKeywords = [
        'æ¡ˆä»¶å', 'æ”¯æ‰•', 'é‡‘é¡', 'ä¼šç¤¾', 'æ ªå¼ä¼šç¤¾', 'æœ‰é™ä¼šç¤¾', 'åˆåŒä¼šç¤¾',
        'æ–™é‡‘', 'è²»ç”¨', 'æ—¥ä»˜', 'çŠ¶æ…‹', 'å‡¦ç†', 'ä»¶å', 'å–å¼•å…ˆ', 'æ¥­è€…',
        'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ', 'ã‚³ãƒ¼ãƒ‰', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
    ];
    
    // æ–‡å­—åŒ–ã‘ã®å…¸å‹çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
    const corruptedPatterns = [
        /ï¿½/, // ç½®æ›æ–‡å­—
        /[Ã¯Â¿Â½]+/, // UTF-8ã‚¨ãƒ©ãƒ¼æ–‡å­—
        /[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/, // åˆ¶å¾¡æ–‡å­—
        /[Ã Ã¡Ã¢Ã£Ã¤Ã¥Ã¦Ã§Ã¨Ã©ÃªÃ«Ã¬Ã­Ã®Ã¯Ã°Ã±Ã²Ã³Ã´ÃµÃ¶Ã·Ã¸Ã¹ÃºÃ»Ã¼Ã½Ã¾Ã¿]{3,}/, // é€£ç¶šã—ãŸæ–‡å­—åŒ–ã‘æ–‡å­—
    ];
    
    // æ–‡å­—åŒ–ã‘ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯ç„¡åŠ¹
    for (const pattern of corruptedPatterns) {
        if (pattern.test(content)) {
            console.log('æ–‡å­—åŒ–ã‘ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º:', pattern);
            return false;
        }
    }
    
    // æ—¥æœ¬èªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const hasJapanese = japaneseKeywords.some(keyword => content.includes(keyword));
    
    // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ¼¢å­—ã®å­˜åœ¨ã‚‚ãƒã‚§ãƒƒã‚¯
    const hasJapaneseChars = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(content);
    
    return hasJapanese || hasJapaneseChars;
}

/**
 * æ”¯æ‰•ã„CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ - Shift-JISå¯¾å¿œå¼·åŒ–ç‰ˆ
 */
function previewPaymentCsv(file) {
    if (!file) return;
    
    console.log('CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹:', file.name);
    
    // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡ºã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    detectAndReadCsv(file)
        .then(result => {
            console.log(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿æˆåŠŸ (${result.encoding}):`, result.content.substring(0, 100));
            currentPaymentCsvContent = result.content;
            
            try {
                const lines = result.content.trim().split(/\r?\n/);
                const headers = parseCSVLine(lines[0]);
                currentPaymentCsvHeaders = headers;
                
                console.log('æ¤œå‡ºã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼:', headers);
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                let previewHtml = generateCsvPreviewHtml(headers, lines);
                document.getElementById('csvPreview').innerHTML = previewHtml;
                
                // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æƒ…å ±ã‚’è¡¨ç¤º
                const encodingInfo = `<div class="alert alert-info mb-2">
                    <small><i class="bi bi-info-circle"></i> æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: <strong>${result.encoding}</strong></small>
                </div>`;
                document.getElementById('csvPreview').insertAdjacentHTML('afterbegin', encodingInfo);
                
                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                populatePaymentMappingOptions(headers);
                
                // è‡ªå‹•æ¤œå‡ºã‚’å®Ÿè¡Œ
                autoDetectPaymentMapping();
                
            } catch (error) {
                console.error('CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('csvPreview').innerHTML = 
                    '<div class="alert alert-danger">CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</div>';
            }
        })
        .catch(error => {
            console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('csvPreview').innerHTML = 
                '<div class="alert alert-danger">ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</div>';
        });
}

/**
 * ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡ºã¨CSVèª­ã¿è¾¼ã¿
 */
function detectAndReadCsv(file) {
    return new Promise(async (resolve, reject) => {
        try {
            // UTF-8ã‚’è©¦è¡Œ
            console.log('UTF-8ã§ã®èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ...');
            const utf8Content = await readCsvWithEncoding(file, 'UTF-8');
            
            if (isValidJapaneseContent(utf8Content)) {
                console.log('UTF-8ã§æ­£å¸¸ã«èª­ã¿è¾¼ã‚ã¾ã—ãŸ');
                resolve({ content: utf8Content, encoding: 'UTF-8' });
                return;
            }
            
            // Shift-JISã‚’è©¦è¡Œ
            console.log('Shift-JISã§ã®èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ...');
            const sjisContent = await readCsvWithEncoding(file, 'Shift_JIS');
            
            if (isValidJapaneseContent(sjisContent)) {
                console.log('Shift-JISã§æ­£å¸¸ã«èª­ã¿è¾¼ã‚ã¾ã—ãŸ');
                resolve({ content: sjisContent, encoding: 'Shift-JIS' });
                return;
            }
            
            // EUC-JPã‚’è©¦è¡Œï¼ˆè¿½åŠ å¯¾å¿œï¼‰
            console.log('EUC-JPã§ã®èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ...');
            try {
                const eucContent = await readCsvWithEncoding(file, 'EUC-JP');
                if (isValidJapaneseContent(eucContent)) {
                    console.log('EUC-JPã§æ­£å¸¸ã«èª­ã¿è¾¼ã‚ã¾ã—ãŸ');
                    resolve({ content: eucContent, encoding: 'EUC-JP' });
                    return;
                }
            } catch (eucError) {
                console.log('EUC-JPèª­ã¿è¾¼ã¿å¤±æ•—:', eucError.message);
            }
            
            // å…¨ã¦å¤±æ•—ã—ãŸå ´åˆã¯UTF-8ã®çµæœã‚’è¿”ã™
            console.log('å…¨ã¦ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§æ–‡å­—åŒ–ã‘ãŒè§£æ±ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚UTF-8ã§é€²è¡Œã—ã¾ã™ã€‚');
            resolve({ content: utf8Content, encoding: 'UTF-8 (æ–‡å­—åŒ–ã‘ã®å¯èƒ½æ€§)' });
            
        } catch (error) {
            reject(error);
        }
    });
}

/**
 * CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLç”Ÿæˆ
 */
function generateCsvPreviewHtml(headers, lines) {
    let previewHtml = '<div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr>';
    
    headers.forEach((header, index) => {
        previewHtml += `<th style="min-width: 120px;">
            åˆ—${index + 1}<br>
            <small class="text-primary">${escapeHtml(header)}</small>
        </th>`;
    });
    previewHtml += '</tr></thead><tbody>';
    
    // æœ€åˆã®5è¡Œã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    const maxPreviewRows = Math.min(6, lines.length);
    for (let i = 1; i < maxPreviewRows; i++) {
        const row = parseCSVLine(lines[i]);
        previewHtml += '<tr>';
        headers.forEach((header, colIndex) => {
            const cellValue = row[colIndex] || '';
            previewHtml += `<td><small>${escapeHtml(cellValue)}</small></td>`;
        });
        previewHtml += '</tr>';
    }
    
    previewHtml += '</tbody></table></div>';
    
    if (lines.length > maxPreviewRows) {
        previewHtml += `<small class="text-muted">... ä»– ${lines.length - maxPreviewRows} è¡Œ</small>`;
    }
    
    return previewHtml;
}

/**
 * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
 */
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

/**
 * ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨ºæ–­æ©Ÿèƒ½
 */
function diagnoseCsvEncoding(file) {
    return new Promise(async (resolve) => {
        const diagnosis = {
            file: {
                name: file.name,
                size: file.size,
                type: file.type
            },
            encodings: {}
        };
        
        const encodingsToTest = ['UTF-8', 'Shift_JIS', 'EUC-JP'];
        
        for (const encoding of encodingsToTest) {
            try {
                console.log(`${encoding}ã§ã®è¨ºæ–­ä¸­...`);
                const content = await readCsvWithEncoding(file, encoding);
                const isValid = isValidJapaneseContent(content);
                
                diagnosis.encodings[encoding] = {
                    success: true,
                    isValid: isValid,
                    sampleText: content.substring(0, 100),
                    hasJapanese: /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(content),
                    lineCount: content.split(/\r?\n/).length
                };
                
                console.log(`${encoding} è¨ºæ–­çµæœ:`, diagnosis.encodings[encoding]);
            } catch (error) {
                diagnosis.encodings[encoding] = {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // æ¨å¥¨ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ±ºå®š
        diagnosis.recommended = Object.keys(diagnosis.encodings).find(enc => 
            diagnosis.encodings[enc].success && diagnosis.encodings[enc].isValid
        ) || 'UTF-8';
        
        resolve(diagnosis);
    });
}

/**
 * ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨ºæ–­çµæœè¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
 */
function showEncodingDiagnosis(file) {
    diagnoseCsvEncoding(file)
        .then(diagnosis => {
            console.log('=== ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨ºæ–­çµæœ ===');
            console.log('ãƒ•ã‚¡ã‚¤ãƒ«:', diagnosis.file);
            console.log('æ¨å¥¨ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°:', diagnosis.recommended);
            
            Object.keys(diagnosis.encodings).forEach(encoding => {
                const result = diagnosis.encodings[encoding];
                console.log(`${encoding}:`, result);
            });
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çµæœã‚’è¡¨ç¤ºï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            let message = `ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨ºæ–­çµæœ:\n\n`;
            message += `æ¨å¥¨: ${diagnosis.recommended}\n\n`;
            
            Object.keys(diagnosis.encodings).forEach(encoding => {
                const result = diagnosis.encodings[encoding];
                if (result.success) {
                    message += `${encoding}: ${result.isValid ? 'âœ“ æ­£å¸¸' : 'âš  æ–‡å­—åŒ–ã‘ã®å¯èƒ½æ€§'}\n`;
                } else {
                    message += `${encoding}: âœ— èª­ã¿è¾¼ã¿å¤±æ•—\n`;
                }
            });
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆé€šå¸¸ã¯è¡¨ç¤ºã—ãªã„ï¼‰
            if (window.location.search.includes('debug=true')) {
                alert(message);
            }
        })
        .catch(error => {
            console.error('ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨ºæ–­ã‚¨ãƒ©ãƒ¼:', error);
        });
}

// ãƒãƒƒãƒ”ãƒ³ã‚°é¸æŠãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const mappingSelects = document.querySelectorAll('#mappingFields .mapping-select');
        mappingSelects.forEach(select => {
            select.addEventListener('change', updatePaymentMappingStatus);
        });
    }, 1000);
});

/**
 * æ”¯æ‰•ã„CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
 */
function importPaymentWithContent(csvContent) {
    console.log('æ”¯æ‰•ã„CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œä¸­...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('æ”¯æ‰•ã„CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ:', result);
            if (result && result.success) {
                let message = result.message || 'æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ';
                
                // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤º
                if (result.errorCount && result.errorCount > 0) {
                    console.log('ã‚¨ãƒ©ãƒ¼è©³ç´°:', result.errorDetails);
                    
                    if (result.errorDetails && result.errorDetails.length > 0) {
                        const errorSummary = result.errorDetails.slice(0, 5).join('\n');
                        message += `\n\nä¸»ãªã‚¨ãƒ©ãƒ¼:\n${errorSummary}`;
                        if (result.errorDetails.length > 5) {
                            message += `\n... ä»–${result.errorDetails.length - 5}ä»¶ã®ã‚¨ãƒ©ãƒ¼`;
                        }
                    }
                    
                    showStatus(message, 'warning');
                } else {
                    showStatus(message, 'success');
                }
                
                // ãƒãƒƒãƒ”ãƒ³ã‚°ã®è­¦å‘Šè¡¨ç¤º
                if (result.missingMappings && result.missingMappings.length > 0) {
                    console.warn('ãƒãƒƒãƒ”ãƒ³ã‚°ã§ããªã‹ã£ãŸåˆ—:', result.missingMappings);
                    setTimeout(() => {
                        alert(`âš ï¸ æ³¨æ„: ä»¥ä¸‹ã®åˆ—ãŒãƒãƒƒãƒ”ãƒ³ã‚°ã§ãã¾ã›ã‚“ã§ã—ãŸ\n\n${result.missingMappings.join(', ')}\n\nã‚ˆã‚Šæ­£ç¢ºãªã‚¤ãƒ³ãƒãƒ¼ãƒˆã«ã¯ã€Œãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‚’ã”ä½¿ç”¨ãã ã•ã„ã€‚`);
                    }, 2000);
                }
                
                loadPayments();
            } else {
                let errorMessage = result ? (result.message || 'æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ') : 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (result && result.errorDetails) {
                    errorMessage += '\nè©³ç´°: ' + result.errorDetails.join(', ');
                }
                showStatus(errorMessage, 'danger');
            }
        })
        .withFailureHandler(function(error) {
            console.error('æ”¯æ‰•ã„CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            showStatus('æ”¯æ‰•ã„CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
        })
        .importPaymentsFromCsv(csvContent);
}

/**
 * ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
 */
function openPaymentMappingModal() {
    const modal = new bootstrap.Modal(document.getElementById('paymentMappingModal'));
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
    resetPaymentMapping();
    document.getElementById('csvPreview').innerHTML = '<p class="text-muted">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
    document.getElementById('mappingStatus').className = 'alert alert-secondary';
    document.getElementById('mappingStatus').textContent = 'ãƒãƒƒãƒ”ãƒ³ã‚°æœªè¨­å®š';
    document.getElementById('executeMappingImport').disabled = true;
    
    modal.show();
}

/**
 * æ”¯æ‰•ã„CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ - Shift-JISå¯¾å¿œå¼·åŒ–ç‰ˆ
 */
function previewPaymentCsv(file) {
    if (!file) return;
    
    console.log('CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹:', file.name);
    
    // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡ºã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    detectAndReadCsv(file)
        .then(result => {
            console.log(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿æˆåŠŸ (${result.encoding}):`, result.content.substring(0, 100));
            currentPaymentCsvContent = result.content;
            
            try {
                const lines = result.content.trim().split(/\r?\n/);
                const headers = parseCSVLine(lines[0]);
                currentPaymentCsvHeaders = headers;
                
                console.log('æ¤œå‡ºã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼:', headers);
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                let previewHtml = generateCsvPreviewHtml(headers, lines);
                document.getElementById('csvPreview').innerHTML = previewHtml;
                
                // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æƒ…å ±ã‚’è¡¨ç¤º
                const encodingInfo = `<div class="alert alert-info mb-2">
                    <small><i class="bi bi-info-circle"></i> æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: <strong>${result.encoding}</strong></small>
                </div>`;
                document.getElementById('csvPreview').insertAdjacentHTML('afterbegin', encodingInfo);
                
                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                populatePaymentMappingOptions(headers);
                
                // è‡ªå‹•æ¤œå‡ºã‚’å®Ÿè¡Œ
                autoDetectPaymentMapping();
                
            } catch (error) {
                console.error('CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('csvPreview').innerHTML = 
                    '<div class="alert alert-danger">CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</div>';
            }
        })
        .catch(error => {
            console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('csvPreview').innerHTML = 
                '<div class="alert alert-danger">ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</div>';
        });
}

/**
 * ãƒãƒƒãƒ”ãƒ³ã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
 */
function populatePaymentMappingOptions(headers) {
    const selects = document.querySelectorAll('#mappingFields .mapping-select');
    
    selects.forEach(select => {
        // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æ®‹ã™ï¼‰
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }
        
        // CSVãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¿½åŠ 
        headers.forEach((header, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `åˆ—${index + 1}: ${header}`;
            select.appendChild(option);
        });
    });
}

/**
 * è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°æ¤œå‡º
 */
function autoDetectPaymentMapping() {
    if (currentPaymentCsvHeaders.length === 0) return;
    
    const autoMapping = {
        subject: findBestMatch(currentPaymentCsvHeaders, ['ä»¶å', 'ã‚¿ã‚¤ãƒˆãƒ«', 'é¡Œå', 'subject', 'title']),
        projectName: findBestMatch(currentPaymentCsvHeaders, ['æ¡ˆä»¶å', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ', 'project', 'æ¡ˆä»¶']),
        payee: findBestMatch(currentPaymentCsvHeaders, ['æ”¯æ‰•ã„å…ˆ', 'æ”¯æ‰•å…ˆ', 'å–å¼•å…ˆ', 'ä¼šç¤¾å', 'payee', 'company', 'æ¥­è€…']),
        payeeCode: findBestMatch(currentPaymentCsvHeaders, ['æ”¯æ‰•ã„å…ˆã‚³ãƒ¼ãƒ‰', 'æ”¯æ‰•å…ˆã‚³ãƒ¼ãƒ‰', 'å–å¼•å…ˆã‚³ãƒ¼ãƒ‰', 'ä¼šç¤¾ã‚³ãƒ¼ãƒ‰', 'code', 'ã‚³ãƒ¼ãƒ‰']),
        amount: findBestMatch(currentPaymentCsvHeaders, ['é‡‘é¡', 'æ–™é‡‘', 'ä¾¡æ ¼', 'è²»ç”¨', 'amount', 'price', 'cost']),
        paymentDate: findBestMatch(currentPaymentCsvHeaders, ['æ”¯æ‰•æ—¥', 'æ”¯æ‰•ã„æ—¥', 'æ±ºæ¸ˆæ—¥', 'æ—¥ä»˜', 'date', 'payment_date']),
        status: findBestMatch(currentPaymentCsvHeaders, ['çŠ¶æ…‹', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡¦ç†çŠ¶æ³', 'status', 'state'])
    };
    
    // æ¤œå‡ºçµæœã‚’è¨­å®š
    Object.keys(autoMapping).forEach(field => {
        const index = autoMapping[field];
        if (index !== -1) {
            const select = document.querySelector(`[data-field="${field}"]`);
            if (select) {
                select.value = index;
            }
        }
    });
    
    updatePaymentMappingStatus();
}

/**
 * æœ€é©ãªåˆ—ãƒãƒƒãƒãƒ³ã‚°ã‚’æ¤œå‡º
 */
function findBestMatch(headers, keywords) {
    // å®Œå…¨ä¸€è‡´ã‚’å„ªå…ˆ
    for (const keyword of keywords) {
        const index = headers.findIndex(header => 
            header.toLowerCase() === keyword.toLowerCase()
        );
        if (index !== -1) return index;
    }
    
    // éƒ¨åˆ†ä¸€è‡´
    for (const keyword of keywords) {
        const index = headers.findIndex(header => 
            header.toLowerCase().includes(keyword.toLowerCase()) ||
            keyword.toLowerCase().includes(header.toLowerCase())
        );
        if (index !== -1) return index;
    }
    
    return -1;
}

/**
 * ãƒãƒƒãƒ”ãƒ³ã‚°çŠ¶æ³ã‚’æ›´æ–°
 */
function updatePaymentMappingStatus() {
    const selects = document.querySelectorAll('#mappingFields .mapping-select');
    const mappings = {};
    let mappedCount = 0;
    let requiredCount = 0;
    
    selects.forEach(select => {
        const field = select.getAttribute('data-field');
        const value = select.value;
        const isRequired = select.parentElement.querySelector('.text-danger') !== null;
        
        if (isRequired) requiredCount++;
        
        if (value && value !== '') {
            mappings[field] = parseInt(value);
            mappedCount++;
        }
    });
    
    paymentMappingSettings = mappings;
    
    const statusDiv = document.getElementById('mappingStatus');
    const executeBtn = document.getElementById('executeMappingImport');
    
    if (mappedCount >= 3 && mappings.payee !== undefined && mappings.amount !== undefined) {
        statusDiv.className = 'alert alert-success';
        statusDiv.innerHTML = `
            <i class="bi bi-check-circle"></i> 
            ãƒãƒƒãƒ”ãƒ³ã‚°å®Œäº† (${mappedCount}é …ç›®)
            <br><small>å¿…é ˆé …ç›®: æ”¯æ‰•ã„å…ˆã€é‡‘é¡ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™</small>
        `;
        executeBtn.disabled = false;
    } else if (mappedCount > 0) {
        statusDiv.className = 'alert alert-warning';
        statusDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle"></i> 
            ãƒãƒƒãƒ”ãƒ³ã‚°ä¸å®Œå…¨ (${mappedCount}é …ç›®)
            <br><small>æ”¯æ‰•ã„å…ˆã¨é‡‘é¡ã¯å¿…é ˆã§ã™</small>
        `;
        executeBtn.disabled = true;
    } else {
        statusDiv.className = 'alert alert-secondary';
        statusDiv.textContent = 'ãƒãƒƒãƒ”ãƒ³ã‚°æœªè¨­å®š';
        executeBtn.disabled = true;
    }
}

/**
 * ãƒãƒƒãƒ”ãƒ³ã‚°ãƒªã‚»ãƒƒãƒˆ
 */
function resetPaymentMapping() {
    const selects = document.querySelectorAll('#mappingFields .mapping-select');
    selects.forEach(select => {
        select.value = '';
    });
    paymentMappingSettings = {};
    updatePaymentMappingStatus();
}

/**
 * ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
 */
function executePaymentMappingImport() {
    if (!currentPaymentCsvContent) {
        showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
        return;
    }
    
    if (Object.keys(paymentMappingSettings).length === 0) {
        showStatus('ãƒãƒƒãƒ”ãƒ³ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
        return;
    }
    
    showStatus('ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...', 'info');
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¨­å®šã—ã¦ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
    google.script.run
        .withSuccessHandler(function(mappingResult) {
            if (mappingResult && mappingResult.success) {
                console.log('ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šæˆåŠŸ');
                
                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ:', result);
                        
                        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                        bootstrap.Modal.getInstance(document.getElementById('paymentMappingModal')).hide();
                        
                        if (result && result.success) {
                            let message = result.message || 'ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šã§ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ';
                            
                            if (result.errorCount && result.errorCount > 0) {
                                if (result.errorDetails && result.errorDetails.length > 0) {
                                    const errorSummary = result.errorDetails.slice(0, 3).join('\n');
                                    message += `\n\nä¸»ãªã‚¨ãƒ©ãƒ¼:\n${errorSummary}`;
                                }
                                showStatus(message, 'warning');
                            } else {
                                showStatus(message, 'success');
                            }
                            
                            loadPayments();
                        } else {
                            showStatus(result ? result.message : 'ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                        }
                    })
                    .withFailureHandler(function(error) {
                        bootstrap.Modal.getInstance(document.getElementById('paymentMappingModal')).hide();
                        showStatus('ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error, 'danger');
                    })
                    .importPaymentsFromCsv(currentPaymentCsvContent);
            } else {
                showStatus('ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        })
        .withFailureHandler(function(error) {
            showStatus('ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šã‚¨ãƒ©ãƒ¼: ' + error, 'danger');
        })
        .setCustomPaymentHeaderMapping(paymentMappingSettings);
}

/**
 * æ”¯æ‰•ã„CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
 */
function downloadPaymentCsvTemplate() {
    const templateData = [
        ['ä»¶å', 'æ¡ˆä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'æ”¯æ‰•ã„å…ˆã‚³ãƒ¼ãƒ‰', 'é‡‘é¡', 'æ”¯æ‰•æ—¥', 'çŠ¶æ…‹'],
        ['ã‚µãƒ³ãƒ—ãƒ«ä»¶å1', 'ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶A', 'ã‚µãƒ³ãƒ—ãƒ«ä¼šç¤¾æ ªå¼ä¼šç¤¾', 'SAMPLE001', '50000', '2024-01-15', 'æœªå‡¦ç†'],
        ['ã‚µãƒ³ãƒ—ãƒ«ä»¶å2', 'ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶B', 'ãƒ†ã‚¹ãƒˆå•†äº‹æœ‰é™ä¼šç¤¾', 'TEST002', '30000', '2024-01-20', 'æœªå‡¦ç†'],
        ['ã‚µãƒ³ãƒ—ãƒ«ä»¶å3', 'ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶C', 'ä¾‹ç¤ºä¼æ¥­åˆåŒä¼šç¤¾', 'EXAMPLE003', '75000', '2024-01-25', 'å‡¦ç†æ¸ˆ']
    ];
    
    let csvContent = '';
    templateData.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
    });
    
    // BOMã‚’è¿½åŠ ã—ã¦Excelã§æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvContent], { type: 'text/csv; charset=UTF-8' });
    
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.download = `æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
    
    window.URL.revokeObjectURL(link.href);
    showStatus('æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
}

/**
 * CSVè¡Œè§£æé–¢æ•°
 */
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current.trim());
    return result;
}

// ãƒãƒƒãƒ”ãƒ³ã‚°é¸æŠãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const mappingSelects = document.querySelectorAll('#mappingFields .mapping-select');
        mappingSelects.forEach(select => {
            select.addEventListener('change', updatePaymentMappingStatus);
        });
    }, 1000);
});
</script>