// 段階的復元テスト - ステップ1: 基本変数と簡単な関数
console.log('Script.html step 1 loaded successfully');

// Google Apps Script API モック（ローカル環境対応）
if (typeof google === 'undefined') {
    console.log('Local environment detected - setting up GAS API mock');
    window.google = {
        script: {
            run: {
                withSuccessHandler: function(successHandler) {
                    return {
                        withFailureHandler: function(failureHandler) {
                            const mockFunctions = {
                                getPaymentData: function() {
                                    console.log('Mock: getPaymentData called');
                                    setTimeout(() => {
                                        successHandler([
                                            {subject: 'テスト件名1', projectName: 'テストプロジェクト1', payee: 'テスト支払先1', payeeCode: 'CODE001', amount: '100000', paymentDate: '2024-01-01', status: '完了'},
                                            {subject: 'テスト件名2', projectName: 'テストプロジェクト2', payee: 'テスト支払先2', payeeCode: 'CODE002', amount: '200000', paymentDate: '2024-01-02', status: '処理中'}
                                        ]);
                                    }, 1000);
                                },
                                getExpenseData: function() {
                                    console.log('Mock: getExpenseData called');
                                    setTimeout(() => {
                                        successHandler([
                                            {date: '2024-01-01', category: 'テストカテゴリ1', description: 'テスト説明1', amount: '50000', status: '完了'},
                                            {date: '2024-01-02', category: 'テストカテゴリ2', description: 'テスト説明2', amount: '75000', status: '処理中'}
                                        ]);
                                    }, 1000);
                                },
                                getMasterData: function() {
                                    console.log('Mock: getMasterData called');
                                    setTimeout(() => {
                                        successHandler([
                                            {category: 'テストマスター1', description: 'マスター説明1', amount: '30000', frequency: '月次'},
                                            {category: 'テストマスター2', description: 'マスター説明2', amount: '40000', frequency: '年次'}
                                        ]);
                                    }, 1000);
                                }
                            };

                            return mockFunctions;
                        }
                    };
                }
            }
        }
    };
} else {
    console.log('GAS environment detected - using real API');
}

// グローバル変数
let currentView = 'payment';
let allData = {
  payment: [],
  expense: [],
  master: []
};
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 20;

function debugTest() {
    console.log('debugTest() called from step 1 script');
    alert('Step 1 script working!');
    return true;
}

function checkFunctionDefinitions() {
    console.log('checkFunctionDefinitions() called from step 1 script');
    alert('Step 1 check function working!');
    return true;
}

// 基本的な表示関数（template literals なし）
function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

function showError(message) {
    console.error('Error:', message);
    alert('エラー: ' + message);
}

// ステップ2: 基本的なUI関数とイベント処理
function switchView(view) {
    currentView = view;
    console.log('Switching to view:', view);

    // タブアクティブ状態更新
    document.querySelectorAll('.nav-link').forEach(tab => {
        tab.classList.remove('active');
    });
    const targetTab = document.querySelector('[data-bs-target="#' + view + '"]');
    if (targetTab) {
        targetTab.classList.add('active');
    }

    // データ読み込み
    loadData();
    updateUI();
}

function loadData() {
    console.log('Loading data for view:', currentView);
    showLoading(true);

    let functionName;
    switch(currentView) {
        case 'payment':
            functionName = 'getPaymentData';
            break;
        case 'expense':
            functionName = 'getExpenseData';
            break;
        case 'master':
            functionName = 'getMasterData';
            break;
        default:
            functionName = 'getPaymentData';
    }

    // Server function call
    google.script.run
        .withSuccessHandler(function(data) {
            allData[currentView] = data || [];
            filteredData = allData[currentView];
            updateTable();
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            console.error('データ読み込みエラー:', error);
            showError('データの読み込みに失敗しました: ' + error.message);
            showLoading(false);
        })[functionName]();
}

function updateUI() {
    const viewTitle = document.getElementById('viewTitle');
    const viewMap = {
        'payment': '支払データ管理',
        'expense': '費用データ管理',
        'master': 'マスタデータ管理'
    };
    if (viewTitle) {
        viewTitle.textContent = viewMap[currentView] || 'データ管理';
    }
}

function updateTable() {
    switch(currentView) {
        case 'payment':
            updatePaymentTable();
            break;
        case 'expense':
            updateExpenseTable();
            break;
        case 'master':
            updateMasterTable();
            break;
    }
}

function updatePaymentTable() {
    const tbody = document.querySelector('#paymentsTableBody');
    if (!tbody) {
        console.error('paymentsTableBody not found');
        return;
    }

    tbody.innerHTML = '';

    if (!filteredData || filteredData.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 7; // 支払いテーブルは7列
        cell.textContent = 'データがありません';
        cell.className = 'text-center text-muted py-4';
        return;
    }

    // ページネーション計算
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredData.slice(startIndex, endIndex);

    // テーブル行作成 - HTMLの列に合わせて修正
    pageData.forEach(item => {
        const row = tbody.insertRow();
        // 支払いテーブルの列: 件名, 案件名, 支払い先, コード, 金額, 支払日, 状態
        const columns = ['subject', 'projectName', 'payee', 'payeeCode', 'amount', 'paymentDate', 'status'];
        columns.forEach(key => {
            const cell = row.insertCell();
            cell.textContent = item[key] || '';
        });
    });

    updatePagination();
}

function updateExpenseTable() {
    const tbody = document.querySelector('#expensesTableBody');
    if (!tbody) {
        console.error('expensesTableBody not found');
        return;
    }

    tbody.innerHTML = '';

    if (!filteredData || filteredData.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 6; // 費用テーブルの列数に応じて調整
        cell.textContent = 'データがありません';
        cell.className = 'text-center text-muted py-4';
        return;
    }

    // ページネーション計算
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredData.slice(startIndex, endIndex);

    // テーブル行作成
    pageData.forEach(item => {
        const row = tbody.insertRow();
        // 費用テーブルの基本列
        const columns = ['date', 'category', 'description', 'amount', 'status'];
        columns.forEach(key => {
            const cell = row.insertCell();
            cell.textContent = item[key] || '';
        });
    });

    updatePagination();
}

function updateMasterTable() {
    const tbody = document.querySelector('#mastersTableBody');
    if (!tbody) {
        console.error('mastersTableBody not found');
        return;
    }

    tbody.innerHTML = '';

    if (!filteredData || filteredData.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 5; // マスターテーブルの列数に応じて調整
        cell.textContent = 'データがありません';
        cell.className = 'text-center text-muted py-4';
        return;
    }

    // ページネーション計算
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredData.slice(startIndex, endIndex);

    // テーブル行作成
    pageData.forEach(item => {
        const row = tbody.insertRow();
        // マスターテーブルの基本列
        const columns = ['category', 'description', 'amount', 'frequency'];
        columns.forEach(key => {
            const cell = row.insertCell();
            cell.textContent = item[key] || '';
        });
    });

    updatePagination();
}

function updatePagination() {
    // シンプルなページネーション（template literalsなし）
    console.log('Updating pagination for page:', currentPage);
}

// 基本的なイベント関数
function refreshAllData() {
    console.log('Refreshing all data');
    loadData();
}

function refreshPayments() {
    currentView = 'payment';
    loadData();
}

function refreshExpenses() {
    currentView = 'expense';
    loadData();
}

function refreshMasters() {
    currentView = 'master';
    loadData();
}

// システム関数（シンプル版）
function initializeCompleteSystem() {
    console.log('Initializing complete system');
    alert('システム初期化を開始します');
}

function createSampleData() {
    console.log('Creating sample data');
    alert('サンプルデータを作成します');
}

function checkSystemStatus() {
    console.log('Checking system status');
    alert('システム状態をチェックします');
}

function showSystemStatus() {
    console.log('Showing system status');
    alert('システム状態を表示します');
}

// 残りのスタブ関数
function createNewSpreadsheet() { alert('createNewSpreadsheet() stub'); }
function importPythonAppData() { alert('importPythonAppData() stub'); }
function showCSVImportDialog() { alert('showCSVImportDialog() stub'); }
function searchPayments() { alert('searchPayments() stub'); }
function resetPaymentFilters() { alert('resetPaymentFilters() stub'); }
function openMasterReflectionModal() { alert('openMasterReflectionModal() stub'); }
function generateFromMasterForCurrentMonth() { alert('generateFromMasterForCurrentMonth() stub'); }
function generateFromMasterForNextMonth() { alert('generateFromMasterForNextMonth() stub'); }
function searchExpenses() { alert('searchExpenses() stub'); }
function resetExpenseFilters() { alert('resetExpenseFilters() stub'); }
function searchMasters() { alert('searchMasters() stub'); }
function resetMasterFilters() { alert('resetMasterFilters() stub'); }
function runAutoMatching() { alert('runAutoMatching() stub'); }
function runSystemDiagnosis() { alert('runSystemDiagnosis() stub'); }
function checkDataIntegrity() { alert('checkDataIntegrity() stub'); }
function showPerformanceStats() { alert('showPerformanceStats() stub'); }
function runEmergencyRepair() { alert('runEmergencyRepair() stub'); }
function verifyDataCounts() { alert('verifyDataCounts() stub'); }
function checkDataDuplicates() { alert('checkDataDuplicates() stub'); }
function validateFieldRanges() { alert('validateFieldRanges() stub'); }
function runCompleteDataValidation() { alert('runCompleteDataValidation() stub'); }
function emergencySystemSetup() { alert('emergencySystemSetup() stub'); }
function runSystemDebug() { alert('runSystemDebug() stub'); }
function setCurrentMonth() { alert('setCurrentMonth() stub'); }
function setNextMonth() { alert('setNextMonth() stub'); }
function setPreviousMonth() { alert('setPreviousMonth() stub'); }
function previewMasterReflection() { alert('previewMasterReflection() stub'); }
function executeMasterReflection() { alert('executeMasterReflection() stub'); }