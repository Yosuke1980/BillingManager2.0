# 契約と出演者の紐付け機能

## 📋 概要

出演契約に出演者を紐付ける機能を実装しました。出演の契約書には誰を出演させるかが記載されているため、発注管理でもこれを管理できるようになりました。

## 🎯 目的

- 出演契約と出演者の関係を明確に管理
- 契約書に記載される出演者リストをデータベースで管理
- 出演者ごとの役割（MC、ナレーター、ゲストなど）を記録

## 📊 データベース構造

### contract_cast テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| contract_id | INTEGER | 契約ID（contracts テーブル） |
| cast_id | INTEGER | 出演者ID（cast テーブル） |
| role | TEXT | 役割（MC、ナレーター、ゲストなど） |
| created_at | TIMESTAMP | 作成日時 |

**制約**:
- `UNIQUE(contract_id, cast_id)`: 同じ契約に同じ出演者は重複登録不可
- `FOREIGN KEY (contract_id)`: 契約削除時にカスケード削除
- `FOREIGN KEY (cast_id)`: 出演者削除時にカスケード削除

## 🛠️ 実装内容

### 1. データベースメソッド（database_manager.py）

#### get_contract_cast(contract_id)
契約に紐付いた出演者を取得
```python
cast_list = db.get_contract_cast(contract_id)
# 戻り値: [(contract_cast_id, cast_id, cast_name, partner_name, role), ...]
```

#### add_contract_cast(contract_id, cast_id, role=None)
契約に出演者を追加
```python
db.add_contract_cast(1, 78, 'MC')
```

#### remove_contract_cast(contract_cast_id)
契約から出演者を削除
```python
db.remove_contract_cast(contract_cast_id)
```

#### update_contract_cast_role(contract_cast_id, role)
出演者の役割を更新
```python
db.update_contract_cast_role(contract_cast_id, 'ナレーター')
```

#### get_all_cast()
すべての出演者を取得
```python
all_cast = db.get_all_cast()
# 戻り値: [(cast_id, cast_name, partner_name), ...]
```

### 2. UI機能（order_contract_edit_dialog.py）

#### 出演者情報グループ
- 業務種別が「出演」の場合のみ表示
- 出演者テーブル（出演者名、所属、役割、削除ボタン）
- 「➕ 出演者を追加」ボタン

#### add_cast_to_contract()
出演者選択ダイアログを表示
- すべての出演者をリスト表示
- 既に追加済みの出演者は除外
- 所属事務所名も表示
- 複数選択可能

#### remove_cast_from_table(row)
テーブルから出演者を削除
- 確認ダイアログを表示
- 削除後、残りの行のボタンを再設定

#### load_contract_cast()
既存契約の出演者情報を読み込み
- 契約編集時に自動的に呼び出される
- 出演者名、所属、役割を表示

#### save_contract_cast(contract_id)
出演者情報を保存
- 契約保存時に自動的に呼び出される（出演契約の場合のみ）
- 既存のリンクを削除してから再作成
- トランザクション管理

## 💡 使用方法

### 新規出演契約を作成する場合

1. 発注管理タブから「新規追加」をクリック
2. 業務種別で「出演」を選択
3. 番組、取引先、契約内容を入力
4. 「出演者情報」グループで「➕ 出演者を追加」をクリック
5. 出演者選択ダイアログから出演者を選択
6. 必要に応じて「役割」列に役割を入力（MC、ナレーターなど）
7. 「OK」をクリックして保存

### 既存出演契約を編集する場合

1. 発注管理タブから出演契約をダブルクリック
2. 出演者情報グループに既存の出演者が表示される
3. 追加: 「➕ 出演者を追加」ボタンをクリック
4. 削除: 出演者の行の「🗑️」ボタンをクリック
5. 役割変更: 「役割」列を直接編集
6. 「OK」をクリックして保存

## 📝 データの流れ

```
契約編集ダイアログを開く
    ↓
load_contract_data()
    ↓
load_contract_cast()  ← contract_castテーブルから出演者を取得
    ↓
出演者情報をテーブルに表示
    ↓
ユーザーが編集
    ↓
「OK」ボタンをクリック
    ↓
save()
    ↓
save_order_contract()  ← 契約を保存
    ↓
save_contract_cast()  ← 出演者情報を保存（出演契約の場合のみ）
    ↓
完了
```

## ⚠️ 注意事項

### 制作契約では表示されない
- 業務種別が「制作」の場合、出演者情報グループは非表示
- 制作契約には出演者は紐付けられません

### 重複チェック
- 同じ契約に同じ出演者を2回追加することはできません
- データベース制約（UNIQUE）により保護されています

### カスケード削除
- 契約を削除すると、紐付いた出演者情報も自動的に削除されます
- 出演者マスタを削除すると、契約との紐付けも削除されます

## 🎉 完成した機能

✅ 出演契約に出演者を複数追加できる
✅ 出演者ごとに役割を記録できる
✅ 契約編集時に既存の出演者が表示される
✅ 出演者の追加・削除が簡単にできる
✅ 出演者マスタから選択するため、データの一貫性が保たれる

## 🔮 今後の拡張案（未実装）

### 契約一覧での出演者表示
- 発注管理タブの契約一覧に出演者名を表示
- ツールチップで全出演者と役割を表示

### 出演者から契約を検索
- 出演者マスタから該当出演者の契約を表示
- 「この出演者が出演する番組」の一覧表示

### 出演者の自動提案
- 番組の過去の契約から出演者を自動提案
- レギュラー出演者の検出と提案

### 出演費の自動計算
- 出演者ごとの単価設定
- 出演回数に応じた自動計算

---

**作成日**: 2025-01-08
**作成者**: Claude Code
**バージョン**: 1.0
