# ラジオ局支払い・費用管理システム (BillingManager2.0)
## システム構造・機能概要書

**作成日**: 2025-11-05
**最終更新**: 2025-11-07
**バージョン**: 2.0.1
**ステータス**: 運用中

---

## 📋 目次

1. [システム概要](#システム概要)
2. [システムの2大機能](#システムの2大機能)
3. [データベース構造](#データベース構造)
4. [UI構成](#ui構成)
5. [データフロー](#データフロー)
6. [実装済み機能一覧](#実装済み機能一覧)
7. [最近の更新履歴](#最近の更新履歴)
8. [要件定義との差異](#要件定義との差異)

---

## システム概要

### システム名称
**ラジオ局支払い・費用管理システム (BillingManager2.0)**

### 開発環境
- **言語**: Python 3.7+
- **UIフレームワーク**: PyQt5
- **データベース**: SQLite3
- **外部連携**: Gmail API (IMAP)

### システムの目的
ラジオ局における以下の業務を一元管理するシステム:
1. 支払予定の管理と実績との照合
2. 発注書・契約書の作成と管理
3. レギュラー契約の自動延長
4. 番組・出演者・取引先のマスター管理

---

## システムの2大機能

### ✅ 機能A: 発注書と支払いの照合機能

#### 概要
発注マスターに基づいて月次支払予定を生成し、実際の支払データ(CSV)と照合することで、未処理・未払い項目を検出する機能。

#### 関連タブ
1. **支払い情報タブ**
   - CSVファイルから支払データを自動インポート
   - 支払ステータス管理（未処理/処理中/処理済/照合済）
   - 色分け表示で視認性向上
   - フィルター・検索機能

2. **支払い・発注チェックタブ**
   - 発注マスターから月次支払予定を自動生成
   - 実際の支払データと照合
   - 不足項目の検出:
     - 発注書類の未作成
     - 受領確認の未完了
     - 支払実績の未記録
   - ダッシュボードで統計表示
   - 問題項目のフィルタリング

3. **データ管理タブ > 発注・支払照合サブタブ**
   - 年月を指定して照合実行
   - 照合サマリー表示:
     - 発注件数・発注総額
     - 支払済件数・支払済金額
     - 未払い件数・未払い金額
     - 金額相違件数・相違合計
   - レポート出力機能

#### データソース
- **発注データ**: order_contracts テーブル（レギュラー契約から自動生成）
- **支払データ**: payments テーブル（CSVインポート）

#### ビジネス価値
- 支払漏れの防止
- 支払遅延の早期検出
- 月次決算業務の効率化
- 取引先とのトラブル回避

---

### ✅ 機能B: 契約の整理・管理機能

#### 概要
レギュラー契約（継続的な発注）と単発発注を統合管理し、契約情報を一元的に整理する機能。レギュラー出演契約では自動延長機能も提供。

#### 関連タブ

1. **発注管理タブ**

   発注書・契約書を統合管理するメインタブ。以下の4種類の契約形態に対応:

   | 契約形態 | 発注種別 | 業務種別 | 書類タイプ | 特徴 |
   |---------|---------|---------|-----------|-----|
   | レギュラー出演契約 | レギュラー | 出演 | **契約書** | 自動延長機能あり |
   | レギュラー制作発注 | レギュラー | 制作 | 発注書 | 月額固定/回数ベース |
   | 単発出演発注 | 単発 | 出演 | 発注書 | スポット金額 |
   | 単発制作発注 | 単発 | 制作 | 発注書 | スポット金額 |

   **主要機能**:
   - 発注書・契約書の新規作成・編集・削除
   - 番組（productions）と案件（projects）の選択
   - 取引先（partners）の選択
   - 契約条件の設定:
     - レギュラー: 開始日・終了日、期間タイプ、支払方法
     - 単発: 実施日、スポット金額
   - PDFファイルの添付
   - 発注ステータス管理（未完了/完了）
   - CSV一括インポート/エクスポート
   - 契約自動延長（レギュラー出演契約のみ）

   **契約自動延長機能**:
   - 対象: レギュラー出演契約書のみ
   - 仕組み:
     - 終了日の1ヶ月前までに終了通知がない場合、自動延長
     - 延長期間は設定可能（デフォルト3ヶ月）
     - 延長履歴を contract_renewal_history に記録
   - 通知:
     - 起動時に延長対象契約をチェック
     - 確認ダイアログで延長実行

2. **マスター管理タブ**

   契約管理に必要なマスターデータを管理するタブ。以下の5つのサブタブで構成:

   **サブタブ1: タイムライン**
   - 番組の放送期間をガントチャート表示
   - 契約の開始・終了日を視覚的に管理
   - 番組のステータス（放送中/終了）を一覧表示

   **サブタブ2: 取引先マスター**
   - 統合取引先マスター（partners テーブル）
   - 取引先区分による管理:
     - 発注先: 発注管理でのみ使用
     - 支払先: 支払管理でのみ使用
     - 両方: 両機能で使用（デフォルト）
   - 取引先情報:
     - 取引先名、コード、担当者
     - メールアドレス、電話番号、住所
     - 備考
   - 検索・フィルタリング機能
   - 新規追加・編集・削除

   **サブタブ3: 出演者マスター**
   - 出演者情報の管理（cast テーブル）
   - 所属事務所との紐付け（partners連携）
   - 表示形式: 「出演者名（所属事務所名）」
   - 番組マスターとの連携
   - 検索機能
   - 新規追加・編集・削除

   **サブタブ4: 番組・イベント管理**
   - 番組基本情報の管理（productions テーブル）
   - 番組情報:
     - 番組名、種別（レギュラー番組/イベント/特番）
     - 開始日・終了日
     - 放送時間、放送曜日
     - ステータス（放送中/終了）
   - 出演者リスト管理:
     - 出演者マスターから複数選択
     - 役割設定（MC、アシスタント等）
     - 表示: 「出演者名（所属事務所）- 役割」
   - 制作会社リスト管理:
     - 取引先マスターから複数選択
   - 階層構造対応（親番組・子案件）
   - 検索・ステータスフィルター
   - 新規追加・編集・削除

   **サブタブ5: 設定**
   - Gmail IMAP設定
   - メール署名設定
   - システム設定

#### データ構造

**番組・案件の階層構造**:
```
番組 (productions, parent_production_id = NULL)
└─ 案件 (productions, parent_production_id = 番組ID)
   └─ 発注書 (order_contracts, production_id = 番組ID, project_id = 案件ID)
```

**例**:
```
番組A (レギュラー番組)
├─ レギュラー出演契約: 田中太郎 (契約書、自動延長あり)
├─ レギュラー制作発注: 制作会社X (発注書)
└─ 夏季イベント (案件)
   ├─ 単発出演発注: ゲスト佐藤 (発注書)
   └─ 単発制作発注: イベント制作費 (発注書)
```

#### ビジネス価値
- 契約情報の一元管理
- レギュラー契約の自動延長による業務効率化
- 番組・出演者・取引先の関係性の可視化
- 契約漏れ・更新漏れの防止

---

## データベース構造

### データベースファイル

| ファイル名 | 用途 | 主要テーブル |
|-----------|------|-------------|
| **billing.db** | 支払データ管理 | payments |
| **order_management.db** | 発注・契約管理 | order_contracts, productions, partners, cast, expenses_order |
| **payee_master.db** | 旧支払先マスター（互換性のため残存） | - |

### 主要テーブル詳細

#### 1. payments (billing.db)
**用途**: CSV連携から取り込んだ支払データ

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| subject | TEXT | 件名 |
| project_name | TEXT | 案件名 |
| payee | TEXT | 支払先名 |
| payee_code | TEXT | 支払先コード |
| amount | REAL | 金額 |
| payment_date | TEXT | 支払日 |
| status | TEXT | ステータス（未処理/処理中/処理済/照合済） |
| type | TEXT | 種別 |
| client_name | TEXT | クライアント名 |
| department | TEXT | 部署 |
| project_status | TEXT | 案件ステータス |
| project_start_date | TEXT | 案件開始日 |
| project_end_date | TEXT | 案件終了日 |
| budget | REAL | 予算 |
| approver | TEXT | 承認者 |
| urgency_level | TEXT | 緊急度 |

#### 2. order_contracts (order_management.db)
**用途**: 発注書・契約書の統合管理

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| production_id | INTEGER | 番組ID (productions参照、NULL許可) |
| project_id | INTEGER | 案件ID (productions参照、NULL許可) |
| partner_id | INTEGER | 取引先ID (partners参照) |
| item_name | TEXT | 費用項目名 |
| contract_start_date | DATE | 開始日 |
| contract_end_date | DATE | 終了日 |
| contract_period_type | TEXT | 期間タイプ（3ヶ月/半年/1年） |
| order_type | TEXT | 書類タイプ（契約書/発注書） |
| order_status | TEXT | 発注ステータス（未完了/完了） |
| order_category | TEXT | 発注区分（レギュラー/単発） |
| work_type | TEXT | 業務種別（制作/出演） |
| payment_type | TEXT | 支払方法（月額固定/回数ベース） |
| unit_price | REAL | 単価 |
| payment_timing | TEXT | 支払タイミング（翌月末払い/当月末払い） |
| implementation_date | DATE | 実施日（単発用） |
| spot_amount | REAL | スポット金額（単発用） |
| auto_renewal_enabled | INTEGER | 自動延長有効フラグ（1/0） |
| renewal_period_months | INTEGER | 延長期間（月数） |
| termination_notice_date | DATE | 終了通知受領日 |
| last_renewal_date | DATE | 最終延長日 |
| renewal_count | INTEGER | 延長回数 |
| pdf_file_path | TEXT | PDFファイルパス |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 3. productions (order_management.db)
**用途**: 番組・イベント・案件マスター（階層構造対応）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| name | TEXT | 番組名・案件名 |
| description | TEXT | 備考 |
| production_type | TEXT | 種別（レギュラー番組/イベント/特番） |
| start_date | DATE | 開始日 |
| end_date | DATE | 終了日 |
| start_time | TEXT | 開始時刻 |
| end_time | TEXT | 終了時刻 |
| broadcast_time | TEXT | 放送時間 |
| broadcast_days | TEXT | 放送曜日（カンマ区切り） |
| status | TEXT | ステータス（放送中/終了） |
| parent_production_id | INTEGER | 親番組ID（階層用、NULL許可） |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 4. partners (order_management.db)
**用途**: 統合取引先マスター（旧 suppliers + 旧 payee_master を統合）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| name | TEXT | 取引先名 |
| code | TEXT | 取引先コード（ユニーク） |
| contact_person | TEXT | 担当者名 |
| email | TEXT | メールアドレス |
| phone | TEXT | 電話番号 |
| address | TEXT | 住所 |
| partner_type | TEXT | 取引先区分（発注先/支払先/両方） |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5. cast (order_management.db)
**用途**: 出演者マスター

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| name | TEXT | 出演者名（ユニーク） |
| partner_id | INTEGER | 所属事務所ID (partners参照) |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 6. production_cast (order_management.db)
**用途**: 番組-出演者紐付け

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| production_id | INTEGER | 番組ID (productions参照) |
| cast_id | INTEGER | 出演者ID (cast参照) |
| role | TEXT | 役割（MC、アシスタント等） |
| created_at | TIMESTAMP | 作成日時 |

#### 7. production_producers (order_management.db)
**用途**: 番組-制作会社紐付け

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| production_id | INTEGER | 番組ID (productions参照) |
| partner_id | INTEGER | 制作会社ID (partners参照) |
| created_at | TIMESTAMP | 作成日時 |

#### 8. contract_renewal_history (order_management.db)
**用途**: 契約自動延長履歴

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| contract_id | INTEGER | 契約ID (order_contracts参照) |
| previous_end_date | DATE | 旧終了日 |
| new_end_date | DATE | 新終了日 |
| renewal_date | TIMESTAMP | 延長実行日時 |
| renewal_reason | TEXT | 延長理由 |
| executed_by | TEXT | 実行者 |
| notes | TEXT | 備考 |

#### 9. expenses_order (order_management.db)
**用途**: 発注費用項目（旧発注管理機能の名残、現在は order_contracts に統合）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| production_id | INTEGER | 番組ID (productions参照) |
| item_name | TEXT | 項目名 |
| amount | REAL | 金額 |
| supplier_id | INTEGER | 発注先ID |
| status | TEXT | ステータス |
| order_number | TEXT | 発注番号 |
| order_date | DATE | 発注日 |
| implementation_date | DATE | 実施日 |
| invoice_received_date | DATE | 請求書受領日 |
| payment_scheduled_date | DATE | 支払予定日 |
| payment_date | DATE | 支払日 |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### ER図（主要テーブルの関係）

```
payments (支払データ)
  [独立したテーブル、照合時に order_contracts と突合]

order_contracts (発注書・契約書)
  ├─ production_id → productions (番組)
  ├─ project_id → productions (案件)
  └─ partner_id → partners (取引先)

productions (番組・案件)
  ├─ parent_production_id → productions (親番組)
  ├─ production_cast ← cast (出演者)
  └─ production_producers ← partners (制作会社)

cast (出演者)
  └─ partner_id → partners (所属事務所)

partners (統合取引先)
  [取引先区分: 発注先/支払先/両方]
```

---

## UI構成

### メインタブ構成

アプリケーションは5つのメインタブで構成されています:

```
┌─────────────────────────────────────────────────────────┐
│ [支払い情報] [支払い・発注チェック] [発注管理] [マスター管理] [データ管理] │
└─────────────────────────────────────────────────────────┘
```

### 1. 支払い情報タブ
**ファイル**: `payment_tab.py`

**機能**:
- CSVファイルから支払データを自動インポート
- 支払データ一覧表示（ツリー表示）
- ステータス管理（未処理/処理中/処理済/照合済）
- 色分け表示:
  - 照合済み: ライトグリーン
  - 処理済み: ライトブルー
  - 処理中: 薄い黄色
  - 未処理: オフホワイト
- フィルター機能（ステータス、年月、案件）
- 検索機能（支払先名、案件名）
- データ更新・手動インポート

**使用シーン**: 毎日、CSV連携で支払データを確認・処理

---

### 2. 支払い・発注チェックタブ
**ファイル**: `payment_order_check_tab.py`

**機能**:
- 発注マスター（order_contracts）から月次支払予定を自動生成
- 実際の支払データ（payments）との照合
- 不足項目の検出:
  - 発注書類の未作成
  - 受領確認の未完了
  - 支払実績の未記録
- ダッシュボード統計表示:
  - 発注書類完備率
  - 受領確認完了率
  - 支払実績確認率
  - 問題件数
- フィルター機能（全て/問題あり/完了済み）
- 検索機能（取引先名、費用項目）
- 年月選択

**使用シーン**: 毎日/月次、支払手続きの進捗確認

---

### 3. 発注管理タブ
**ファイル**: `order_management/ui/order_contract_widget.py`

**機能**:
- 発注書・契約書の統合管理
- 4種類の契約形態に対応:
  - レギュラー出演契約書（自動延長あり）
  - レギュラー制作発注書
  - 単発出演発注書
  - 単発制作発注書
- 発注書一覧表示（テーブル表示）
- フィルター機能:
  - 発注ステータス（未完了/完了）
  - 発注種別（契約書/発注書）
  - 業務種別（制作/出演）
- 検索機能（番組名、取引先名、費用項目）
- 発注書編集ダイアログ:
  - 番組・案件選択
  - 取引先選択
  - 契約条件入力
  - PDFファイル添付
- CSV一括インポート/エクスポート
- 契約自動延長機能（レギュラー出演契約のみ）

**使用シーン**: 契約作成時、契約更新時、発注管理

---

### 4. マスター管理タブ
**ファイル**: `master_management_tab.py`

5つのサブタブで構成:

#### サブタブ1: タイムライン
**ファイル**: `order_management/ui/production_timeline_widget.py`

**機能**:
- 番組の放送期間をガントチャート表示
- 契約の開始・終了日を視覚的に管理
- 番組ステータス（放送中/終了）を一覧表示
- 月選択による期間フィルタリング（年・月のコンボボックス）
- 契約由来の費用項目を自動表示
- 番組合計額の計算（実際に表示される費用項目の合計）
- CSV出力・印刷機能
- 費用項目の直接編集機能

#### サブタブ2: 取引先マスター
**ファイル**: `order_management/ui/partner_master_widget.py`

**機能**:
- 統合取引先マスター管理
- 取引先区分フィルター（発注先/支払先/両方）
- 取引先情報の登録・編集・削除
- 検索機能
- 統計情報表示（発注先/支払先/両方の件数）

#### サブタブ3: 出演者マスター
**ファイル**: `order_management/ui/cast_master_widget.py`

**機能**:
- 出演者情報の管理
- 所属事務所との紐付け
- 出演者一覧表示（出演者名、所属事務所名、コード）
- 検索機能
- 新規追加・編集・削除

#### サブタブ4: 番組・イベント管理
**ファイル**: `order_management/ui/production_master_widget.py`

**機能**:
- 番組基本情報の管理
- タブ形式の入力画面（基本情報・出演者・制作会社）
- 出演者リスト管理
- 制作会社リスト管理
- 番組一覧表示
- ステータスフィルター（全て/放送中/終了）
- 検索機能
- 新規追加・編集・削除
- 契約との完全連携（番組に紐づく契約の自動表示）
- 費用項目の直接編集機能
- CSV一括インポート/エクスポート

#### サブタブ5: 設定
**ファイル**: `order_management/ui/settings_widget.py`

**機能**:
- Gmail IMAP設定
- メール署名設定
- システム設定

**使用シーン**: マスターデータのメンテナンス時

---

### 5. データ管理タブ
**ファイル**: `data_management_tab.py`

4つのサブタブで構成:

#### サブタブ1: 費用管理
**ファイル**: `expense_tab.py`

**機能**:
- 案件ごとの費用項目管理
- 費用項目の登録・編集・削除
- 検索・フィルター機能

#### サブタブ2: 費用マスター
**ファイル**: `master_tab.py`

**機能**:
- 費用項目マスターの管理
- 費用項目テンプレートの作成

#### サブタブ3: 発注チェック
**ファイル**: `order_check_tab.py`

**機能**:
- 発注状況の一覧表示
- 発注漏れチェック

#### サブタブ4: 発注・支払照合
**ファイル**: `order_payment_reconciliation_tab.py`

**機能**:
- 年月を指定して照合実行
- 照合サマリー表示:
  - 発注件数・発注総額
  - 支払済件数・支払済金額
  - 未払い件数・未払い金額
  - 金額相違件数・相違合計
- テーブル表示（取引先、番組、費用項目、発注金額、支払予定日、支払タイミング、ステータス）
- レポート出力機能

**使用シーン**: たまに使用、月次決算時

---

## データフロー

### フロー1: 支払データの取り込みと処理

```
┌──────────────┐
│ CSV ファイル  │ (data/ フォルダ)
└──────┬───────┘
       │ 起動時 / 手動インポート
       ↓
┌──────────────┐
│ payments     │ (billing.db)
│ テーブル      │
└──────┬───────┘
       │ 状態管理
       ↓
┌──────────────────────┐
│ 支払い情報タブ        │
│ - 未処理 → 処理中      │
│ - 処理中 → 処理済      │
│ - 処理済 → 照合済      │
└──────────────────────┘
```

### フロー2: 発注書作成から支払まで

```
┌─────────────────┐
│ 番組マスター     │ (productions)
│ 取引先マスター    │ (partners)
└────────┬────────┘
         │ 選択
         ↓
┌─────────────────┐
│ 発注書作成       │ (発注管理タブ)
│ - レギュラー契約  │
│ - 単発発注       │
└────────┬────────┘
         │ 保存
         ↓
┌─────────────────┐
│ order_contracts │ (order_management.db)
└────────┬────────┘
         │ 月次で自動生成
         ↓
┌─────────────────┐
│ 支払予定リスト   │ (支払い・発注チェックタブ)
└────────┬────────┘
         │ 照合
         ↓
┌─────────────────┐
│ 実際の支払データ │ (payments)
└─────────────────┘
```

### フロー3: レギュラー契約の自動延長

```
┌─────────────────┐
│ レギュラー出演   │ (order_contracts)
│ 契約書          │ auto_renewal_enabled = 1
└────────┬────────┘
         │ 起動時チェック
         ↓
┌──────────────────────────┐
│ 終了日の1ヶ月前?          │
│ 終了通知受領日 = NULL?    │
└────────┬─────────────────┘
         │ YES
         ↓
┌──────────────────────────┐
│ 確認ダイアログ表示         │
│ - 対象契約一覧             │
│ - 延長期間確認             │
└────────┬─────────────────┘
         │ ユーザー承認
         ↓
┌──────────────────────────┐
│ 契約終了日を延長           │
│ contract_renewal_history  │
│ に履歴を記録               │
└──────────────────────────┘
```

---

## 実装済み機能一覧

### ✅ 発注・契約管理機能

| 機能 | 実装状況 | ファイル |
|-----|---------|---------|
| 発注書・契約書の統合管理 | ✅ | order_contract_widget.py |
| 4種類の契約形態対応 | ✅ | order_contract_edit_dialog.py |
| CSV一括インポート/エクスポート | ✅ | order_contract_widget.py |
| 契約自動延長（レギュラー出演） | ✅ | database_manager.py, app.py |
| PDFファイル添付 | ✅ | order_contract_edit_dialog.py |
| 発注番号自動採番 | ✅ | order_number_generator.py |
| Gmail連携（下書き作成） | ✅ | gmail_manager.py |

### ✅ マスター管理機能

| 機能 | 実装状況 | ファイル |
|-----|---------|---------|
| 番組マスター | ✅ | production_master_widget.py |
| 出演者マスター | ✅ | cast_master_widget.py |
| 統合取引先マスター | ✅ | partner_master_widget.py |
| 番組-出演者紐付け | ✅ | production_cast テーブル |
| 番組-制作会社紐付け | ✅ | production_producers テーブル |
| タイムライン表示 | ✅ | production_timeline_widget.py |
| タイムライン月選択フィルタ | ✅ | production_timeline_widget.py |
| 契約由来費用項目の自動表示 | ✅ | production_timeline_widget.py |
| 番組・契約の完全連携 | ✅ | production_master_widget.py, order_contract_widget.py |

### ✅ 支払照合機能

| 機能 | 実装状況 | ファイル |
|-----|---------|---------|
| CSVインポート | ✅ | payment_tab.py |
| 支払ステータス管理 | ✅ | payment_tab.py |
| 支払い・発注チェック | ✅ | payment_order_check_tab.py |
| 月次照合 | ✅ | order_payment_reconciliation_tab.py |
| ダッシュボード統計 | ✅ | payment_order_check_tab.py |

### ✅ その他機能

| 機能 | 実装状況 | ファイル |
|-----|---------|---------|
| ファイル監視機能 | ✅ | monitoring_tab.py |
| 費用管理 | ✅ | expense_tab.py |
| 費用マスター | ✅ | master_tab.py |
| 発注チェック | ✅ | order_check_tab.py |

---

## 最近の更新履歴

### 2025-11-07 更新内容

#### タイムライン機能の拡張
- **月選択フィルタの追加**: 年・月のコンボボックスによる期間フィルタリング機能を実装
- **契約由来費用項目の自動表示**: order_contractsテーブルから費用項目を自動取得・表示
- **番組合計額の計算改善**: 実際に表示される費用項目の合計で計算するロジックに修正

**コミット**:
- `44fa95d` - タイムラインの番組合計額を実際に表示される費用項目の合計で計算するように修正
- `abb9ddb` - タイムラインの期間選択を月選択に変更
- `c2cc6e8` - レギュラー番組タイムラインでの契約由来費用項目表示を修正
- `f32c9f9` - タイムラインに契約由来の費用項目を反映

#### 番組・イベント管理の改善
- **タブ形式入力画面**: 番組編集ダイアログをタブ形式に改善（基本情報・出演者・制作会社）
- **番組・契約の完全連携**: 番組マスターと契約管理の双方向連携を実装
- **費用項目編集機能**: 番組・イベント管理画面から費用項目を直接編集可能に
- **CSV一括処理**: 番組データのCSVインポート/エクスポート機能を追加

**コミット**:
- `2f6d5b1` - 番組・イベント管理と契約の完全連携機能を実装（完成）
- `2e06d06` - 番組・イベント管理と契約の連携機能を実装（中間コミット）
- `3f27cce` - 番組・イベント管理の入力画面をタブ形式に改善
- `e33339e` - 番組・イベント管理とタイムラインに費用項目編集機能を追加

#### UI/UX改善
- **カスタム日付入力**: ImprovedDateEditウィジェットを導入し、日付入力を全面改善
- **出演者編集**: 所属事務所選択機能のバグを修正
- **発注管理CSV**: 「制作物名」を「番組・イベント名」に変更してわかりやすく

**コミット**:
- `53436cf` - 日付入力UIを全面改善：カスタムDateEditウィジェットを導入
- `1361f5b` - 出演者編集ダイアログの所属事務所選択機能を修正
- `cbdaf70` - 発注管理CSV：「制作物名」を「番組・イベント名」に変更

#### バグ修正
- **契約保存バグ**: 契約保存時のproduction_id設定バグを修正
- **契約追加エラー**: 「契約が選択されていません」エラーを修正
- **CSVフリーズ問題**: CSV読み込み時のデッドロック問題を解消
- **レコード更新問題**: 発注管理レコード更新時の保存失敗問題を修正

**コミット**:
- `4467894` - 契約保存時のproduction_id設定バグを修正
- `ffaf427` - 契約追加時の「契約が選択されていません」エラーを修正
- `f3a23a4` - CSV読み込み時のフリーズ問題を修正（デッドロック解消）
- `1c90e63` - 番組・イベント管理のCSV読み込み機能を修正
- `12520cf` - 発注管理レコード更新時の保存失敗問題を修正

#### システムクリーンアップ
- **未使用テーブル削除**: projectsテーブル等の未使用テーブルを削除
- **ドキュメント整備**: システム構造・機能概要書を作成（`fe0e7e4`）

**コミット**:
- `9991617` - システムクリーンアップ: 未使用のテーブル・ファイルを削除
- `2963b80` - expenses_orderテーブルの記載を修正
- `fe0e7e4` - システム構造・機能概要書を作成

---

## 要件定義との差異

### 変更点・統合された機能

#### 1. 発注管理機能の統合
**当初の要件**: `expenses_order` テーブルを中心とした発注管理

**現状**: `order_contracts` テーブルに統合
- レギュラー契約と単発発注を統一管理
- 業務種別（制作/出演）と発注種別（レギュラー/単発）の組み合わせで4種類の契約形態に対応
- expenses_orderは互換性のため残存

**理由**: 契約管理の一元化により、業務フローがシンプルに

#### 2. 取引先マスターの統合
**当初の要件**:
- 発注先マスター (`suppliers`)
- 支払先マスター (`payee_master.db`)

**現状**: `partners` テーブルに統合
- 取引先区分（発注先/支払先/両方）で管理
- 番組マスター・出演者マスターとも連携

**理由**: データの一元管理、メンテナンス性向上

#### 3. 番組マスターの拡張
**当初の要件**: 番組基本情報のみ

**現状**: 出演者・制作会社との紐付けを含む包括的な番組管理
- production_cast テーブル追加
- production_producers テーブル追加
- 階層構造対応（親番組・子案件）

**理由**: 番組の全体像を一元管理するため

#### 4. 契約自動延長機能の追加
**当初の要件**: 記載なし

**現状**: レギュラー出演契約書に自動延長機能を実装
- 終了日の1ヶ月前チェック
- 延長履歴の記録
- 起動時通知

**理由**: レギュラー出演契約の更新漏れ防止

#### 5. 支払照合機能の強化
**当初の要件**: 基本的な照合機能

**現状**: 3つのタブで段階的に照合
1. 支払い情報タブ: 日次の支払データ管理
2. 支払い・発注チェックタブ: 月次の進捗チェック
3. 発注・支払照合タブ: 月次決算時の詳細照合

**理由**: 業務フローに合わせた段階的なチェック

### 廃止された機能

#### 1. Gmail送信機能の自動化
**当初の要件**: 発注メールの自動送信

**現状**: 下書き作成のみ
- IMAPで下書きを作成
- ブラウザでGmailを開いてユーザーが送信

**理由**: セキュリティリスク、手動確認の重要性

#### 2. アラート機能
**当初の要件**: 請求書未着・下書き未送信のアラート

**現状**: 実装済みだが、主機能ではない

**理由**: 支払照合機能で代替可能

### 追加された機能

#### 1. タイムライン表示
**当初の要件**: なし

**現状**: 番組の放送期間をガントチャート表示
- 月選択による期間フィルタリング
- 契約由来の費用項目の自動表示
- 費用項目の直接編集機能

**理由**: 契約の可視化、管理の容易化

#### 2. CSV一括インポート/エクスポート
**当初の要件**: なし

**現状**: 発注書の一括登録・出力が可能

**理由**: 大量データの効率的な管理

#### 3. 統計ダッシュボード
**当初の要件**: なし

**現状**: 支払い・発注チェックタブにダッシュボード追加

**理由**: 支払手続きの進捗を一目で把握

---

## 今後の拡張予定

### 高優先度
- 支払照合の自動化（マッチングアルゴリズムの改善）
- レポート機能の拡充（Excel出力、グラフ表示）
- タイムラインの機能強化（ドラッグ&ドロップによる日付変更）

### 中優先度
- 請求書PDFの自動取り込み
- 発注メール送信の完全自動化（オプション）
- 複数ユーザー対応
- モバイル対応

### 低優先度
- 権限管理
- 監査ログ
- API連携

### 完了済み（2025-11-07時点）
- ✅ タイムライン月選択フィルタ
- ✅ 契約由来費用項目の自動表示
- ✅ 番組・契約の完全連携
- ✅ タブ形式入力画面
- ✅ カスタム日付入力ウィジェット
- ✅ CSV一括処理機能の強化

---

**ドキュメント作成日**: 2025-11-05
**最終更新**: 2025-11-07
**作成者**: Claude (with User)
**バージョン**: 2.0.1
