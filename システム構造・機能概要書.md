# ラジオ局支払い・費用管理システム (BillingManager2.0)
## システム構造・機能概要書

**作成日**: 2025-11-05
**最終更新**: 2025-11-16
**バージョン**: 2.1.0
**ステータス**: 運用中

---

## 📋 目次

1. [システム概要](#システム概要)
2. [システムの主要機能](#システムの主要機能)
3. [データベース構造](#データベース構造)
4. [UI構成](#ui構成)
5. [データフロー](#データフロー)
6. [実装済み機能一覧](#実装済み機能一覧)
7. [最近の更新履歴](#最近の更新履歴)
8. [アーキテクチャの変遷](#アーキテクチャの変遷)

---

## システム概要

### システム名称
**ラジオ局支払い・費用管理システム (BillingManager2.0)**

### 開発環境
- **言語**: Python 3.7+
- **UIフレームワーク**: PyQt5
- **データベース**: SQLite3
- **外部連携**: Gmail API (IMAP)

### システムの目的
ラジオ局における以下の業務を一元管理するシステム:
1. 番組・イベントごとの費用項目管理
2. 支払予定の管理と実績との照合
3. 番組・出演者・取引先のマスター管理
4. テンプレートベースの費用項目自動生成

---

## システムの主要機能

### ✅ 機能A: 費用項目管理機能

#### 概要
番組・イベントごとに発生する費用項目（出演料・制作費等）を一元管理し、テンプレートから自動生成する機能。

#### 関連タブ
1. **費用項目管理タブ**
   - 全費用項目の一覧表示とフィルタリング
   - 費用項目の新規作成・編集・削除
   - ステータス管理（発注予定/発注済/支払済等）
   - 支払ステータス管理（未払い/支払済等）
   - フィルター機能:
     - 番組別フィルター
     - ステータス別フィルター
     - 業務種別フィルター（制作/出演）
     - 期間フィルター
   - 検索機能（費用項目名、取引先名）
   - CSV一括インポート/エクスポート
   - 詳細情報の表示と編集

2. **番組別費用詳細タブ**
   - 番組・イベントごとの費用項目サマリー
   - レギュラー番組/単発番組の切り替え表示
   - 月別費用集計
   - 費用項目の内訳表示
   - 番組詳細へのナビゲーション

3. **番組詳細タブ**
   - 選択した番組の詳細情報表示
   - 表示モード/編集モードの切り替え
   - 番組基本情報:
     - 番組名、種別、放送期間
     - 放送時間、放送曜日（曜日別設定可能）
     - ステータス（放送中/終了）
   - 出演者リスト（所属事務所表示）
   - 制作会社リスト
   - 費用項目リスト（出演者別・制作会社別）:
     - 費用項目名、金額、期間
     - 支払タイミング、単価
     - 実施回数、曜日設定
   - 費用項目の直接編集機能

#### データソース
- **費用テンプレート**: contracts テーブル（レギュラー番組用）
- **実費用データ**: expense_items テーブル（全番組・イベント）

#### ビジネス価値
- 費用項目の一元管理
- テンプレートからの自動生成による工数削減
- 番組ごとの費用把握の容易化
- 支払漏れの防止

---

### ✅ 機能B: 支払いデータ照合機能

#### 概要
費用項目（expense_items）に基づいて支払予定を管理し、実際の支払データ(CSV)と自動照合することで、未処理・未払い項目を検出する機能。

#### 関連タブ

1. **支払い情報タブ**
   - CSVファイルから支払データを自動インポート
   - 支払ステータス管理（未処理/処理中/処理済/照合済）
   - 色分け表示で視認性向上
   - フィルター・検索機能
   - 手動照合機能

2. **データ管理タブ > 発注・支払照合サブタブ**
   - 年月を指定して照合実行
   - 照合サマリー表示:
     - 発注件数・発注総額
     - 支払済件数・支払済金額
     - 未払い件数・未払い金額
     - 金額相違件数・相違合計
   - レポート出力機能

#### データソース
- **費用データ**: expense_items テーブル（支払予定）
- **支払データ**: payments テーブル（CSVインポート）

#### ビジネス価値
- 支払漏れの防止
- 支払遅延の早期検出
- 月次決算業務の効率化
- 取引先とのトラブル回避

---

### ✅ 機能C: 番組・マスター管理機能

#### 概要
番組・イベント、出演者、取引先などのマスターデータを統合管理する機能。

#### 関連タブ

1. **番組・イベント管理タブ**

   番組・イベントのマスター情報を管理するメインタブ。

   **主要機能**:
   - 番組・イベントの新規作成・編集・削除
   - 番組基本情報の管理:
     - 番組名、種別（レギュラー番組/イベント/特番/コーナー）
     - 開始日・終了日
     - 放送時間、放送曜日（曜日別の時間設定可能）
     - ステータス（放送中/終了）
   - 出演者リスト管理:
     - 出演者マスターから複数選択
     - 役割設定（MC、アシスタント等）
     - 表示: 「出演者名（所属事務所）- 役割」
   - 制作会社リスト管理:
     - 取引先マスターから複数選択
   - 階層構造対応（親番組・子コーナー/イベント）
   - 検索・ステータスフィルター
   - CSV一括インポート/エクスポート

2. **マスター管理タブ**

   マスターデータを管理するタブ。以下の5つのサブタブで構成:

   **サブタブ1: タイムライン**
   - 番組の放送期間をガントチャート表示
   - 費用項目の時系列表示
   - 番組のステータス（放送中/終了）を一覧表示

   **サブタブ2: 取引先マスター**
   - 統合取引先マスター（partners テーブル）
   - 取引先区分による管理:
     - 発注先: 発注管理でのみ使用
     - 支払先: 支払管理でのみ使用
     - 両方: 両機能で使用（デフォルト）
   - 取引先情報:
     - 取引先名、コード、担当者
     - メールアドレス、電話番号、住所
     - 備考
   - 検索・フィルタリング機能
   - 新規追加・編集・削除

   **サブタブ3: 出演者マスター**
   - 出演者情報の管理（cast テーブル）
   - 所属事務所との紐付け（partners連携）
   - 表示形式: 「出演者名（所属事務所名）」
   - 番組マスターとの連携
   - 検索機能
   - 新規追加・編集・削除

   **サブタブ4: アラート**
   - システムアラート機能（未実装予定）

   **サブタブ5: 設定**
   - Gmail IMAP設定
   - メール署名設定
   - システム設定

#### データ構造

**番組・コーナー/イベントの階層構造**:
```
番組 (productions, parent_production_id = NULL)
└─ コーナー/イベント (productions, parent_production_id = 番組ID)
   └─ 費用項目 (expense_items, production_id = コーナー/イベントID)
```

**例**:
```
番組A (レギュラー番組)
├─ 出演者費用項目: 田中太郎 出演料
├─ 制作費用項目: 制作会社X 制作費
└─ 夏季イベント (子イベント)
   ├─ 出演者費用項目: ゲスト佐藤 出演料
   └─ 制作費用項目: イベント制作費
```

#### ビジネス価値
- マスターデータの一元管理
- 番組・出演者・取引先の関係性の可視化
- データ整合性の確保

---

## データベース構造

### データベースファイル

| ファイル名 | 用途 | 主要テーブル |
|-----------|------|-------------|
| **billing.db** | 支払データ管理 | payments |
| **order_management.db** | 費用・番組・マスター管理 | expense_items, contracts, productions, partners, cast |

### 主要テーブル詳細

#### 1. payments (billing.db)
**用途**: CSV連携から取り込んだ支払データ

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| subject | TEXT | 件名 |
| project_name | TEXT | 案件名 |
| payee | TEXT | 支払先名 |
| payee_code | TEXT | 支払先コード |
| amount | REAL | 金額 |
| payment_date | TEXT | 支払日 |
| status | TEXT | ステータス（未処理/処理中/処理済/照合済） |
| type | TEXT | 種別 |
| client_name | TEXT | クライアント名 |
| department | TEXT | 部署 |
| project_status | TEXT | 案件ステータス |
| project_start_date | TEXT | 案件開始日 |
| project_end_date | TEXT | 案件終了日 |
| budget | REAL | 予算 |
| approver | TEXT | 承認者 |
| urgency_level | TEXT | 緊急度 |

#### 2. expense_items (order_management.db)
**用途**: 実際の費用項目データ（全番組・イベント）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| contract_id | INTEGER | テンプレート契約ID (contracts参照、NULL許可) |
| production_id | INTEGER | 番組ID (productions参照、必須) |
| partner_id | INTEGER | 取引先ID (partners参照) |
| item_name | TEXT | 費用項目名 |
| amount | REAL | 金額 |
| work_type | TEXT | 業務種別（制作/出演） |
| implementation_date | DATE | 実施日 |
| order_number | TEXT | 発注番号（ユニーク） |
| order_date | DATE | 発注日 |
| status | TEXT | ステータス（発注予定/発注済等） |
| invoice_received_date | DATE | 請求書受領日 |
| expected_payment_date | DATE | 支払予定日 |
| expected_payment_amount | REAL | 支払予定額 |
| payment_scheduled_date | DATE | 支払スケジュール日 |
| payment_date | DATE | 実際の支払日 |
| actual_payment_date | DATE | 実際の支払日（別名） |
| payment_status | TEXT | 支払ステータス（未払い/支払済） |
| payment_verified_date | DATE | 支払確認日 |
| payment_matched_id | INTEGER | 照合済み支払ID |
| payment_difference | REAL | 支払差額 |
| payment_amount | REAL | 支払金額 |
| payment_method | TEXT | 支払方法 |
| invoice_number | TEXT | 請求書番号 |
| invoice_file_path | TEXT | 請求書ファイルパス |
| withholding_tax | REAL | 源泉徴収税額 |
| consumption_tax | REAL | 消費税額 |
| gmail_draft_id | TEXT | Gmail下書きID |
| gmail_message_id | TEXT | GmailメッセージID |
| email_sent_at | TIMESTAMP | メール送信日時 |
| contact_person | TEXT | 担当者 |
| approver | TEXT | 承認者 |
| approval_date | DATE | 承認日 |
| amount_pending | INTEGER | 保留フラグ（0/1） |
| archived | INTEGER | アーカイブフラグ（0/1） |
| archived_date | DATE | アーカイブ日 |
| corner_id | INTEGER | コーナーID (productions参照) |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 3. contracts (order_management.db)
**用途**: 費用項目テンプレート（レギュラー番組用、月次自動生成に使用）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| production_id | INTEGER | 番組ID (productions参照) |
| project_id | INTEGER | プロジェクトID (productions参照、NULL許可) |
| partner_id | INTEGER | 取引先ID (partners参照) |
| work_type | TEXT | 業務種別（制作/出演） |
| item_name | TEXT | 費用項目名 |
| contract_type | TEXT | 契約タイプ（regular_fixed/regular_per_broadcast等） |
| contract_start_date | DATE | 契約開始日 |
| contract_end_date | DATE | 契約終了日 |
| contract_period_type | TEXT | 契約期間タイプ（3ヶ月/半年/1年） |
| payment_type | TEXT | 支払方法（月額固定/回数ベース） |
| unit_price | REAL | 単価 |
| spot_amount | REAL | スポット金額 |
| payment_timing | TEXT | 支払タイミング（翌月末払い/当月末払い） |
| implementation_date | DATE | 実施日（単発用） |
| document_type | TEXT | 書類タイプ（発注書/契約書） |
| document_status | TEXT | 書類ステータス（未/完了） |
| pdf_file_path | TEXT | PDFファイルパス |
| pdf_status | TEXT | PDF配布ステータス（未配布/配布済） |
| pdf_distributed_date | DATE | PDF配布日 |
| email_to | TEXT | 送信先メールアドレス |
| email_subject | TEXT | メール件名 |
| email_body | TEXT | メール本文 |
| email_sent_date | DATE | メール送信日 |
| auto_renewal_enabled | INTEGER | 自動延長有効フラグ（1/0） |
| renewal_period_months | INTEGER | 延長期間（月数） |
| termination_notice_date | DATE | 終了通知受領日 |
| last_renewal_date | DATE | 最終延長日 |
| renewal_count | INTEGER | 延長回数 |
| order_category | TEXT | 発注区分（レギュラー制作発注書等） |
| project_name_type | TEXT | プロジェクト名タイプ（program等） |
| amount_pending | INTEGER | 保留フラグ（0/1） |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 4. productions (order_management.db)
**用途**: 番組・イベント・コーナーマスター（階層構造対応）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| name | TEXT | 番組名・イベント名 |
| description | TEXT | 備考 |
| production_type | TEXT | 種別（レギュラー番組/イベント/特番/コーナー） |
| start_date | DATE | 開始日 |
| end_date | DATE | 終了日 |
| start_time | TEXT | 開始時刻 |
| end_time | TEXT | 終了時刻 |
| broadcast_time | TEXT | 放送時間 |
| broadcast_days | TEXT | 放送曜日（JSON形式：曜日別時間設定） |
| location | TEXT | 場所・スタジオ |
| status | TEXT | ステータス（放送中/終了） |
| parent_production_id | INTEGER | 親番組ID（階層用、NULL許可） |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

**broadcast_days のJSON形式例**:
```json
{
  "月": {"start": "10:00", "end": "11:00"},
  "水": {"start": "14:00", "end": "15:00"},
  "金": {"start": "18:00", "end": "19:00"}
}
```

#### 5. partners (order_management.db)
**用途**: 統合取引先マスター（発注先・支払先・事務所）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| name | TEXT | 取引先名 |
| code | TEXT | 取引先コード（ユニーク） |
| contact_person | TEXT | 担当者名 |
| email | TEXT | メールアドレス |
| phone | TEXT | 電話番号 |
| address | TEXT | 住所 |
| partner_type | TEXT | 取引先区分（発注先/支払先/両方） |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 6. cast (order_management.db)
**用途**: 出演者マスター

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| name | TEXT | 出演者名（ユニーク） |
| partner_id | INTEGER | 所属事務所ID (partners参照) |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 7. production_cast (order_management.db)
**用途**: 番組-出演者紐付け

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| production_id | INTEGER | 番組ID (productions参照) |
| cast_id | INTEGER | 出演者ID (cast参照) |
| role | TEXT | 役割（MC、アシスタント等） |
| created_at | TIMESTAMP | 作成日時 |

#### 8. production_producers (order_management.db)
**用途**: 番組-制作会社紐付け

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| production_id | INTEGER | 番組ID (productions参照) |
| partner_id | INTEGER | 制作会社ID (partners参照) |
| created_at | TIMESTAMP | 作成日時 |

#### 9. contract_renewal_history (order_management.db)
**用途**: 契約自動延長履歴（参照用、現在は使用頻度低い）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| contract_id | INTEGER | 契約ID (contracts参照) |
| previous_end_date | DATE | 旧終了日 |
| new_end_date | DATE | 新終了日 |
| renewal_date | TIMESTAMP | 延長実行日時 |
| renewal_reason | TEXT | 延長理由 |
| executed_by | TEXT | 実行者 |
| notes | TEXT | 備考 |

#### 10. expenses_order (order_management.db)
**用途**: 旧発注費用項目（互換性のため残存、新規では使用しない）

### ER図（主要テーブルの関係）

```
payments (支払データ)
  [独立したテーブル、照合時に expense_items と突合]

expense_items (費用項目データ)
  ├─ contract_id → contracts (テンプレート契約)
  ├─ production_id → productions (番組)
  ├─ partner_id → partners (取引先)
  └─ corner_id → productions (コーナー)

contracts (費用テンプレート)
  ├─ production_id → productions (番組)
  └─ partner_id → partners (取引先)

productions (番組・イベント・コーナー)
  ├─ parent_production_id → productions (親番組)
  ├─ production_cast ← cast (出演者)
  └─ production_producers ← partners (制作会社)

cast (出演者)
  └─ partner_id → partners (所属事務所)

partners (統合取引先)
  [取引先区分: 発注先/支払先/両方]
```

---

## UI構成

### メインタブ構成

アプリケーションは7つのメインタブで構成されています（使用頻度順）:

```
┌────────────────────────────────────────────────────────────────────────┐
│ [費用項目管理] [支払い情報] [番組別費用詳細] [番組・イベント管理]      │
│ [番組詳細] [マスター管理] [データ管理]                                 │
└────────────────────────────────────────────────────────────────────────┘
```

### 1. 📺 費用項目管理タブ
**ファイル**: `order_management/ui/expense_items_widget.py`

**機能**:
- 全費用項目の一覧表示（テーブル表示）
- フィルター機能:
  - 番組別フィルター（ドロップダウン）
  - ステータス別フィルター（発注予定/発注済/請求書受領等）
  - 支払ステータス別フィルター（未払い/支払済）
  - 業務種別フィルター（制作/出演）
  - 期間フィルター（年月選択）
- 検索機能（費用項目名、取引先名）
- 費用項目の新規作成・編集・削除
- CSV一括インポート/エクスポート
- 発注番号の自動生成
- Gmail連携（下書き作成）
- ダブルクリックで詳細編集

**使用シーン**: 毎日、費用項目の管理・確認

---

### 2. 💰 支払い情報タブ
**ファイル**: `payment_tab.py`

**機能**:
- CSVファイルから支払データを自動インポート
- 支払データ一覧表示（ツリー表示）
- ステータス管理（未処理/処理中/処理済/照合済）
- 色分け表示:
  - 照合済み: ライトグリーン
  - 処理済み: ライトブルー
  - 処理中: 薄い黄色
  - 未処理: オフホワイト
- フィルター機能（ステータス、年月、案件）
- 検索機能（支払先名、案件名）
- データ更新・手動インポート
- 手動照合機能（費用項目との紐付け）

**使用シーン**: 毎日、CSV連携で支払データを確認・処理

---

### 3. 📊 番組別費用詳細タブ
**ファイル**: `order_management/ui/production_expense_detail_widget.py`

**機能**:
- レギュラー番組/単発番組の切り替え表示（ラジオボタン）
- 番組・イベントごとの費用サマリー表示
- 月別費用集計:
  - 月ごとの総額表示
  - 費用項目数のカウント
- 費用項目の内訳表示（展開/折りたたみ）
- 番組詳細画面へのナビゲーション（ダブルクリック）
- ツリー表示による階層構造の可視化

**使用シーン**: 毎日、番組ごとの費用状況を確認

---

### 4. 📺 番組・イベント管理タブ
**ファイル**: `order_management/ui/production_master_widget.py`

**機能**:
- 番組・イベントの一覧表示（テーブル表示）
- レギュラー番組/単発番組/コーナーの切り替え表示
- 番組基本情報の管理:
  - 番組名、種別、放送期間
  - 放送時間、放送曜日（曜日別時間設定可能）
  - ステータス（放送中/終了）
- 出演者リスト管理
- 制作会社リスト管理
- 階層構造対応（親番組・子コーナー/イベント）
- 検索・ステータスフィルター
- 新規作成・編集・削除
- CSV一括インポート/エクスポート
- 番組詳細へのナビゲーション

**使用シーン**: 毎日、番組マスターの管理

---

### 5. 📋 番組詳細タブ
**ファイル**: `order_management/ui/production_detail_widget.py`

**機能**:
- 選択した番組の詳細情報表示
- 表示モード/編集モードの切り替え
- 番組基本情報:
  - 番組名、種別、放送期間
  - 放送時間、放送曜日（曜日別の詳細表示）
  - ステータス、場所
- 出演者リスト:
  - 出演者名（所属事務所）
  - 役割
- 制作会社リスト
- 費用項目リスト:
  - 出演者別費用項目
  - 制作会社別費用項目
  - 費用項目の詳細情報（期間、単価、実施回数、曜日等）
- 費用項目の直接編集機能（編集モード）
- 新規費用項目の追加
- 費用項目の削除
- 番組情報の保存

**使用シーン**: 毎日、番組の詳細確認・費用項目の管理

---

### 6. ⚙️ マスター管理タブ
**ファイル**: `master_management_tab.py`

5つのサブタブで構成:

#### サブタブ1: タイムライン
**ファイル**: `order_management/ui/production_timeline_widget.py`

**機能**:
- 番組の放送期間をガントチャート表示
- 費用項目の時系列表示
- 番組ステータス（放送中/終了）を一覧表示
- CSV出力・印刷機能

#### サブタブ2: 取引先マスター
**ファイル**: `order_management/ui/partner_master_widget.py`

**機能**:
- 統合取引先マスター管理
- 取引先区分フィルター（発注先/支払先/両方）
- 取引先情報の登録・編集・削除
- 検索機能
- 統計情報表示（発注先/支払先/両方の件数）

#### サブタブ3: 出演者マスター
**ファイル**: `order_management/ui/cast_master_widget.py`

**機能**:
- 出演者情報の管理
- 所属事務所との紐付け
- 出演者一覧表示（出演者名、所属事務所名、コード）
- 検索機能
- 新規追加・編集・削除

#### サブタブ4: アラート
**ファイル**: `order_management/ui/alert_widget.py`

**機能**:
- システムアラート機能（未実装予定）

#### サブタブ5: 設定
**ファイル**: `order_management/ui/settings_widget.py`

**機能**:
- Gmail IMAP設定
- メール署名設定
- システム設定

**使用シーン**: たまに使用、マスターデータのメンテナンス時

---

### 7. 📁 データ管理タブ
**ファイル**: `data_management_tab.py`

4つのサブタブで構成:

#### サブタブ1: 費用管理
**ファイル**: `expense_tab.py`

**機能**:
- 案件ごとの費用項目管理（旧機能）
- 費用項目の登録・編集・削除
- 検索・フィルター機能

#### サブタブ2: 費用マスター
**ファイル**: `master_tab.py`

**機能**:
- 費用項目マスターの管理
- 費用項目テンプレートの作成

#### サブタブ3: 発注チェック
**ファイル**: `order_check_tab.py`

**機能**:
- 発注状況の一覧表示
- 発注漏れチェック

#### サブタブ4: 発注・支払照合
**ファイル**: `order_payment_reconciliation_tab.py`

**機能**:
- 年月を指定して照合実行
- 照合サマリー表示:
  - 発注件数・発注総額
  - 支払済件数・支払済金額
  - 未払い件数・未払い金額
  - 金額相違件数・相違合計
- テーブル表示（取引先、番組、費用項目、発注金額、支払予定日、支払タイミング、ステータス）
- レポート出力機能

**使用シーン**: たまに使用、月次決算時

---

## データフロー

### フロー1: 支払データの取り込みと処理

```
┌──────────────┐
│ CSV ファイル  │ (data/ フォルダ)
└──────┬───────┘
       │ 起動時 / 手動インポート
       ↓
┌──────────────┐
│ payments     │ (billing.db)
│ テーブル      │
└──────┬───────┘
       │ 状態管理
       ↓
┌──────────────────────┐
│ 支払い情報タブ        │
│ - 未処理 → 処理中      │
│ - 処理中 → 処理済      │
│ - 処理済 → 照合済      │
└──────────────────────┘
```

### フロー2: テンプレートから費用項目生成

```
┌─────────────────┐
│ 番組マスター     │ (productions)
│ 取引先マスター    │ (partners)
└────────┬────────┘
         │ 選択
         ↓
┌─────────────────┐
│ テンプレート作成 │ (contracts)
│ - 契約期間設定    │
│ - 単価設定       │
│ - 支払タイミング  │
└────────┬────────┘
         │ 月次で自動生成
         ↓
┌─────────────────┐
│ expense_items   │ (order_management.db)
│ - 実施日設定     │
│ - 支払予定日設定 │
└────────┬────────┘
         │ 照合
         ↓
┌─────────────────┐
│ 実際の支払データ │ (payments)
└─────────────────┘
```

### フロー3: 費用項目の自動照合

```
┌─────────────────┐
│ expense_items   │ (費用項目)
│ - 支払予定日     │
│ - 支払予定額     │
│ - 取引先         │
└────────┬────────┘
         │ 起動時に自動照合
         ↓
┌──────────────────────────┐
│ 照合条件チェック          │
│ - 取引先名の一致          │
│ - 金額の一致              │
│ - 支払日の近接性          │
└────────┬─────────────────┘
         │ 一致する場合
         ↓
┌──────────────────────────┐
│ 自動更新                  │
│ - payment_status = 支払済 │
│ - payment_matched_id 設定 │
│ - payment_verified_date設定│
└──────────────────────────┘
```

---

## 実装済み機能一覧

### ✅ 費用項目管理機能

| 機能 | 実装状況 | ファイル |
|-----|---------|---------|
| 費用項目一覧表示 | ✅ | expense_items_widget.py |
| 費用項目の新規作成・編集・削除 | ✅ | expense_items_widget.py |
| フィルタリング機能 | ✅ | expense_items_widget.py |
| 検索機能 | ✅ | expense_items_widget.py |
| CSV一括インポート/エクスポート | ✅ | expense_items_widget.py |
| テンプレートからの自動生成 | ✅ | expense_auto_generator.py |
| 番組別費用詳細表示 | ✅ | production_expense_detail_widget.py |
| 番組詳細表示・編集 | ✅ | production_detail_widget.py |

### ✅ 番組・マスター管理機能

| 機能 | 実装状況 | ファイル |
|-----|---------|---------|
| 番組マスター | ✅ | production_master_widget.py |
| 出演者マスター | ✅ | cast_master_widget.py |
| 統合取引先マスター | ✅ | partner_master_widget.py |
| 番組-出演者紐付け | ✅ | production_cast テーブル |
| 番組-制作会社紐付け | ✅ | production_producers テーブル |
| タイムライン表示 | ✅ | production_timeline_widget.py |
| 曜日別放送時間設定 | ✅ | production_master_widget.py |

### ✅ 支払照合機能

| 機能 | 実装状況 | ファイル |
|-----|---------|---------|
| CSVインポート | ✅ | payment_tab.py |
| 支払ステータス管理 | ✅ | payment_tab.py |
| 自動照合 | ✅ | database_manager.py |
| 手動照合 | ✅ | payment_tab.py |
| 月次照合 | ✅ | order_payment_reconciliation_tab.py |

### ✅ その他機能

| 機能 | 実装状況 | ファイル |
|-----|---------|---------|
| ファイル監視機能 | ✅ | monitoring_tab.py |
| Gmail連携（下書き作成） | ✅ | order_management/gmail_manager.py |

---

## 最近の更新履歴

### 2025-11-16 更新内容（最新）

#### システムアーキテクチャの大幅変更
- **契約機能の完全削除**: order_contractsテーブルを削除し、contractsテーブルをテンプレート用途に特化
- **テンプレートベース費用生成への移行**: contractsからexpense_itemsを月次自動生成する仕組みに変更
- **データベース構造の簡素化**: 契約管理の複雑性を排除し、費用項目管理に集中

**コミット**:
- `54c9178` - 契約機能の完全削除とテンプレートベース費用生成への移行
- `db85ddd` - 契約機能への参照を削除し、テンプレートベース費用生成に移行

#### 番組詳細画面の改善
- **表示/編集モードの切り替え機能**: 番組詳細画面に表示モードと編集モードを実装
- **曜日別放送時間の表示**: 曜日ごとに異なる放送時間を詳細表示
- **費用項目の完全な保存機能**: 出演者費用・制作費用の保存機能を実装
- **行間調整とデザイン改善**: 見やすいレイアウトに調整

**コミット**:
- `f13a10e` - レギュラー番組の費用データ保存問題を修正
- `ff6319b` - 番組詳細画面に表示/編集モード切替機能を実装
- `f72c31f` - 番組詳細画面の行間調整と編集機能を追加
- `4d0dc71` - 番組詳細画面を新デザインに対応

#### 曜日別放送時間機能の実装
- **曜日別の放送時間と期間管理**: 番組ごとに曜日別の放送時間を設定可能に
- **JSON形式でのデータ保存**: broadcast_daysカラムにJSON形式で曜日別情報を保存

**コミット**:
- `e70698b` - レギュラー番組の曜日別放送時間と期間管理機能を実装

#### 番組別費用詳細表示の改善
- **レギュラー/単発番組の切り替え表示**: ラジオボタンによる表示切り替え機能
- **コーナーの除外フィルター**: 単発番組フィルタからコーナーを除外
- **自動再読み込み機能**: ラジオボタン切り替え時の自動再読み込みを実装

**コミット**:
- `41bdd98` - ラジオボタン切り替え時の自動再読み込みを実装
- `f1d12d0` - 単発番組フィルタからコーナーを除外

#### UI/UX改善
- **出演者名の正しい表示**: 番組詳細画面で出演者名（cast.name）を正しく表示
- **費用項目読み込みの改善**: 辞書/タプル両方のデータ形式に対応

**コミット**:
- `9a1a330` - 出演者名（cast.name）を表示するように修正
- `65f5970` - レギュラー番組詳細で出演者名を正しく表示するように修正
- `3205e62` - 番組編集ダイアログの費用項目読み込みを辞書/タプル両対応に修正
- `8bd60c7` - レギュラー番組詳細表示の改善：出演者名表示とレイアウト調整

#### データクリーンアップ
- **不要データの削除**: 誤って登録された費用項目の削除
- **日付表示の削除**: レギュラー番組一覧から日付表示を削除

**コミット**:
- `92b607b` - 誤って登録された「ちょめラジ・安齋肇出演料」費用項目を削除
- `e37675e` - レギュラー番組一覧から日付表示を削除

#### ドキュメント整備
- **データベース構造ドキュメントの追加**: データベース構造を詳細に記載

**コミット**:
- `8aa8339` - データベース構造ドキュメントを追加

---

## アーキテクチャの変遷

### 変更点・統合された機能

#### 1. 契約管理機能のアーキテクチャ変更（2025-11-16）
**旧アーキテクチャ**: `order_contracts` テーブルで契約と費用を一元管理

**新アーキテクチャ**:
- `contracts` テーブル: 費用項目テンプレート（レギュラー番組用）
- `expense_items` テーブル: 実際の費用データ（全番組・イベント）

**理由**: 契約管理の複雑性を排除し、費用項目管理に集中するため

#### 2. 取引先マスターの統合（過去）
**当初の要件**:
- 発注先マスター (`suppliers`)
- 支払先マスター (`payee_master.db`)

**現状**: `partners` テーブルに統合
- 取引先区分（発注先/支払先/両方）で管理
- 番組マスター・出演者マスターとも連携

**理由**: データの一元管理、メンテナンス性向上

#### 3. 番組マスターの拡張（過去）
**当初の要件**: 番組基本情報のみ

**現状**: 出演者・制作会社との紐付けを含む包括的な番組管理
- production_cast テーブル追加
- production_producers テーブル追加
- 階層構造対応（親番組・子コーナー/イベント）
- 曜日別放送時間設定（JSON形式）

**理由**: 番組の全体像を一元管理するため

#### 4. UI構成の変更（2025-11-16）
**旧構成**:
- 支払い情報
- 支払い・発注チェック
- 発注管理
- マスター管理
- データ管理

**新構成**:
- 費用項目管理（新）
- 支払い情報
- 番組別費用詳細（新）
- 番組・イベント管理
- 番組詳細（新）
- マスター管理
- データ管理

**理由**: 費用項目管理を中心とした業務フローに最適化

### 廃止された機能

#### 1. 発注管理タブ
**当初の要件**: 発注書・契約書の統合管理

**現状**: 廃止（費用項目管理タブに統合）

**理由**: 契約機能の削除に伴い、シンプルな費用項目管理に移行

#### 2. 契約自動延長機能
**当初の要件**: レギュラー契約の自動延長

**現状**: 廃止（テンプレートベースの自動生成に移行）

**理由**: 契約管理から費用項目管理へのアーキテクチャ変更

### 追加された機能

#### 1. 番組詳細画面（2025-11-16）
**当初の要件**: なし

**現状**: 番組の詳細情報を一画面で表示・編集
- 表示/編集モードの切り替え
- 曜日別放送時間の詳細表示
- 費用項目の直接編集

**理由**: 番組管理の効率化、情報の一元表示

#### 2. 番組別費用詳細画面（2025-11-16）
**当初の要件**: なし

**現状**: 番組ごとの費用サマリーを月別に表示
- レギュラー/単発番組の切り替え
- 月別費用集計
- ツリー表示による階層構造の可視化

**理由**: 番組ごとの費用状況を一目で把握

#### 3. 曜日別放送時間設定（2025-11-16）
**当初の要件**: なし

**現状**: 番組ごとに曜日別の放送時間を設定可能
- JSON形式でのデータ保存
- 番組詳細画面での詳細表示

**理由**: より柔軟な番組管理

---

## 今後の拡張予定

### 高優先度
- テンプレート管理機能の強化（UI改善）
- 支払照合の自動化（マッチングアルゴリズムの改善）
- レポート機能の拡充（Excel出力、グラフ表示）

### 中優先度
- 請求書PDFの自動取り込み
- 複数ユーザー対応
- モバイル対応

### 低優先度
- 権限管理
- 監査ログ
- API連携

### 完了済み（2025-11-16時点）
- ✅ 契約機能の完全削除
- ✅ テンプレートベース費用生成への移行
- ✅ 番組詳細画面の実装
- ✅ 番組別費用詳細画面の実装
- ✅ 曜日別放送時間機能の実装
- ✅ 表示/編集モード切り替え機能
- ✅ 費用項目の完全な保存機能

---

**ドキュメント作成日**: 2025-11-05
**最終更新**: 2025-11-16
**作成者**: Claude (with User)
**バージョン**: 2.1.0
