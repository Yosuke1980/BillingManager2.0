// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentView = 'payments';
let allData = {
  payments: [],
  expenses: [],
  masters: []
};
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 20;

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
});

function initializeApp() {
  console.log('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
  
  // ã‚¨ãƒ©ãƒ¼è©³ç´°ãƒ­ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ 
  window.addEventListener('error', function(e) {
    console.error('JavaScript ã‚¨ãƒ©ãƒ¼:', e.error);
    showError('JavaScript ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
  });
  
  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
  document.querySelectorAll('.nav-link').forEach(tab => {
    tab.addEventListener('click', function(e) {
      e.preventDefault();
      const targetView = this.getAttribute('href').substring(1);
      switchView(targetView);
    });
  });

  // ãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
  setupFormEvents();
  
  // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  loadData();
}

function setupFormEvents() {
  // æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³
  const addBtn = document.getElementById('addBtn');
  if (addBtn) {
    addBtn.addEventListener('click', showAddModal);
  }

  // æ¤œç´¢ãƒœã‚¿ãƒ³
  const searchBtn = document.getElementById('searchBtn');
  if (searchBtn) {
    searchBtn.addEventListener('click', performSearch);
  }

  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
  const clearBtn = document.getElementById('clearBtn');
  if (clearBtn) {
    clearBtn.addEventListener('click', clearFilters);
  }

  // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  const exportBtn = document.getElementById('exportBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', exportCSV);
  }

  // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  const importBtn = document.getElementById('importBtn');
  if (importBtn) {
    importBtn.addEventListener('click', () => document.getElementById('csvFile').click());
  }

  const csvFile = document.getElementById('csvFile');
  if (csvFile) {
    csvFile.addEventListener('change', handleCSVImport);
  }
}

// ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
function switchView(view) {
  currentView = view;
  
  // ã‚¿ãƒ–ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
  document.querySelectorAll('.nav-link').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector(`[href="#${view}"]`).classList.add('active');

  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  loadData();
  updateUI();
}

// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
function loadData() {
  console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ - ãƒ“ãƒ¥ãƒ¼:', currentView);
  showLoading(true);
  
  let functionName;
  switch(currentView) {
    case 'payments':
      functionName = 'getPaymentData';
      break;
    case 'expenses':
      functionName = 'getExpenseData';
      break;
    case 'masters':
      functionName = 'getMasterData';
      break;
    default:
      functionName = 'getPaymentData';
  }
  
  console.log('å‘¼ã³å‡ºã—é–¢æ•°:', functionName);

  google.script.run
    .withSuccessHandler(function(result) {
      console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ:', result);
      if (result && result.success) {
        allData[currentView] = result.data || [];
        filteredData = [...allData[currentView]];
        currentPage = 1;
        updateDataTable();
        showLoading(false);
      } else {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', result);
        showLoading(false);
        showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result ? result.error : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
      }
    })
    .withFailureHandler(function(error) {
      console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      showLoading(false);
      showError('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    })[functionName]();
}

// UIæ›´æ–°
function updateUI() {
  const viewTitle = document.getElementById('viewTitle');
  const addBtnText = document.getElementById('addBtn');
  
  const titles = {
    'payments': 'æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ç®¡ç†',
    'expenses': 'è²»ç”¨ãƒ‡ãƒ¼ã‚¿ç®¡ç†', 
    'masters': 'ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†'
  };
  
  const addTexts = {
    'payments': 'æ–°è¦æ”¯æ‰•ã„è¿½åŠ ',
    'expenses': 'æ–°è¦è²»ç”¨è¿½åŠ ',
    'masters': 'æ–°è¦ãƒã‚¹ã‚¿ãƒ¼è¿½åŠ '
  };

  if (viewTitle) viewTitle.textContent = titles[currentView];
  if (addBtnText) addBtnText.textContent = addTexts[currentView];
}

// ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
function updateDataTable() {
  const tableBody = document.getElementById('dataTableBody');
  if (!tableBody) return;

  // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageData = filteredData.slice(startIndex, endIndex);

  // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
  updateTableHeaders();

  // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“æ›´æ–°
  tableBody.innerHTML = '';
  
  if (pageData.length === 0) {
    const row = tableBody.insertRow();
    const cell = row.insertCell();
    cell.colSpan = getColumnCount();
    cell.innerHTML = '<div class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  pageData.forEach((item, index) => {
    const row = tableBody.insertRow();
    populateTableRow(row, item, startIndex + index);
  });

  updatePagination();
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
function updateTableHeaders() {
  const tableHead = document.getElementById('dataTableHead');
  if (!tableHead) return;

  const headers = getTableHeaders();
  tableHead.innerHTML = '';
  
  const row = tableHead.insertRow();
  headers.forEach(header => {
    const th = document.createElement('th');
    th.textContent = header;
    th.scope = 'col';
    row.appendChild(th);
  });
  
  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ—
  const actionTh = document.createElement('th');
  actionTh.textContent = 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³';
  actionTh.scope = 'col';
  actionTh.style.width = '120px';
  row.appendChild(actionTh);
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼å–å¾—
function getTableHeaders() {
  const headers = {
    'payments': ['ä»¶å', 'æ¡ˆä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'é‡‘é¡', 'æ”¯æ‰•æ—¥', 'çŠ¶æ…‹'],
    'expenses': ['æ¡ˆä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'é‡‘é¡', 'æ”¯æ‰•æ—¥', 'çŠ¶æ…‹'],
    'masters': ['æ¡ˆä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'é‡‘é¡', 'ç¨®åˆ¥']
  };
  return headers[currentView] || [];
}

// ã‚«ãƒ©ãƒ æ•°å–å¾—
function getColumnCount() {
  return getTableHeaders().length + 1; // +1 for action column
}

// ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œãƒ‡ãƒ¼ã‚¿è¨­å®š
function populateTableRow(row, item, index) {
  switch(currentView) {
    case 'payments':
      populatePaymentRow(row, item, index);
      break;
    case 'expenses':
      populateExpenseRow(row, item, index);
      break;
    case 'masters':
      populateMasterRow(row, item, index);
      break;
  }
}

// æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿è¡Œ
function populatePaymentRow(row, item, index) {
  row.insertCell().textContent = item['ä»¶å'] || '';
  row.insertCell().textContent = item['æ¡ˆä»¶å'] || '';
  row.insertCell().textContent = item['æ”¯æ‰•ã„å…ˆ'] || '';
  row.insertCell().textContent = formatCurrency(item['é‡‘é¡']);
  row.insertCell().textContent = formatDate(item['æ”¯æ‰•æ—¥']);
  
  const statusCell = row.insertCell();
  statusCell.innerHTML = `<span class="badge ${getStatusBadgeClass(item['çŠ¶æ…‹'])}">${item['çŠ¶æ…‹'] || ''}</span>`;
  
  addActionButtons(row, item, index);
}

// è²»ç”¨ãƒ‡ãƒ¼ã‚¿è¡Œ
function populateExpenseRow(row, item, index) {
  row.insertCell().textContent = item['æ¡ˆä»¶å'] || '';
  row.insertCell().textContent = item['æ”¯æ‰•ã„å…ˆ'] || '';
  row.insertCell().textContent = formatCurrency(item['é‡‘é¡']);
  row.insertCell().textContent = formatDate(item['æ”¯æ‰•æ—¥']);
  
  const statusCell = row.insertCell();
  statusCell.innerHTML = `<span class="badge ${getStatusBadgeClass(item['çŠ¶æ…‹'])}">${item['çŠ¶æ…‹'] || ''}</span>`;
  
  addActionButtons(row, item, index);
}

// ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿è¡Œ
function populateMasterRow(row, item, index) {
  row.insertCell().textContent = item['æ¡ˆä»¶å'] || '';
  row.insertCell().textContent = item['æ”¯æ‰•ã„å…ˆ'] || '';
  row.insertCell().textContent = formatCurrency(item['é‡‘é¡']);
  row.insertCell().textContent = item['ç¨®åˆ¥'] || '';
  
  addActionButtons(row, item, index);
}

// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³è¿½åŠ 
function addActionButtons(row, item, index) {
  const actionCell = row.insertCell();
  actionCell.innerHTML = `
    <div class="btn-group btn-group-sm">
      <button class="btn btn-outline-primary" onclick="editItem(${index})">
        <i class="fas fa-edit"></i>
      </button>
      <button class="btn btn-outline-danger" onclick="deleteItem(${index})">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã‚¯ãƒ©ã‚¹å–å¾—
function getStatusBadgeClass(status) {
  const statusClasses = {
    'æœªå‡¦ç†': 'bg-warning',
    'å‡¦ç†ä¸­': 'bg-info',
    'å®Œäº†': 'bg-success',
    'ä¿ç•™': 'bg-secondary',
    'ã‚¨ãƒ©ãƒ¼': 'bg-danger'
  };
  return statusClasses[status] || 'bg-secondary';
}

// é€šè²¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatCurrency(amount) {
  if (!amount) return 'Â¥0';
  return 'Â¥' + Number(amount).toLocaleString('ja-JP');
}

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDate(date) {
  if (!date) return '';
  if (typeof date === 'string') {
    return date;
  }
  return new Date(date).toLocaleDateString('ja-JP');
}

// ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
function updatePagination() {
  const pagination = document.getElementById('pagination');
  if (!pagination) return;

  const totalPages = Math.ceil(filteredData.length / itemsPerPage);
  
  pagination.innerHTML = '';
  
  if (totalPages <= 1) return;

  // å‰ã¸ãƒœã‚¿ãƒ³
  const prevLi = document.createElement('li');
  prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
  prevLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + (currentPage - 1) + ')">å‰ã¸</a>';
  pagination.appendChild(prevLi);

  // ãƒšãƒ¼ã‚¸ç•ªå·
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);

  for (let i = startPage; i <= endPage; i++) {
    const li = document.createElement('li');
    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
    li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
    pagination.appendChild(li);
  }

  // æ¬¡ã¸ãƒœã‚¿ãƒ³
  const nextLi = document.createElement('li');
  nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
  nextLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + (currentPage + 1) + ')">æ¬¡ã¸</a>';
  pagination.appendChild(nextLi);

  // ä»¶æ•°è¡¨ç¤º
  updateRecordInfo();
}

// ä»¶æ•°æƒ…å ±æ›´æ–°
function updateRecordInfo() {
  const recordInfo = document.getElementById('recordInfo');
  if (!recordInfo) return;

  const startIndex = (currentPage - 1) * itemsPerPage + 1;
  const endIndex = Math.min(currentPage * itemsPerPage, filteredData.length);
  
  recordInfo.textContent = `${startIndex}-${endIndex} / ${filteredData.length}ä»¶`;
}

// ãƒšãƒ¼ã‚¸å¤‰æ›´
function changePage(page) {
  const totalPages = Math.ceil(filteredData.length / itemsPerPage);
  if (page < 1 || page > totalPages) return;
  
  currentPage = page;
  updateDataTable();
}

// æ¤œç´¢å®Ÿè¡Œ
function performSearch() {
  const searchText = document.getElementById('searchText')?.value || '';
  const statusFilter = document.getElementById('statusFilter')?.value || '';
  const amountMin = document.getElementById('amountMin')?.value || '';
  const amountMax = document.getElementById('amountMax')?.value || '';
  const dateFrom = document.getElementById('dateFrom')?.value || '';
  const dateTo = document.getElementById('dateTo')?.value || '';

  filteredData = allData[currentView].filter(item => {
    // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
    if (searchText) {
      const searchLower = searchText.toLowerCase();
      const searchableFields = ['ä»¶å', 'æ¡ˆä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'æ”¯æ‰•ã„å…ˆã‚³ãƒ¼ãƒ‰', 'ç¨®åˆ¥'];
      const matches = searchableFields.some(field => 
        String(item[field] || '').toLowerCase().includes(searchLower)
      );
      if (!matches) return false;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
    if (statusFilter && item['çŠ¶æ…‹'] !== statusFilter) {
      return false;
    }

    // é‡‘é¡ãƒ•ã‚£ãƒ«ã‚¿
    const amount = Number(item['é‡‘é¡']) || 0;
    if (amountMin && amount < Number(amountMin)) return false;
    if (amountMax && amount > Number(amountMax)) return false;

    // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿
    const itemDate = new Date(item['æ”¯æ‰•æ—¥']);
    if (dateFrom && itemDate < new Date(dateFrom)) return false;
    if (dateTo && itemDate > new Date(dateTo)) return false;

    return true;
  });

  currentPage = 1;
  updateDataTable();
}

// ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
function clearFilters() {
  document.getElementById('searchText').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('amountMin').value = '';
  document.getElementById('amountMax').value = '';
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';

  filteredData = [...allData[currentView]];
  currentPage = 1;
  updateDataTable();
}

// æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showAddModal() {
  const modal = new bootstrap.Modal(document.getElementById('editModal'));
  setupModalForAdd();
  modal.show();
}

// ç·¨é›†
function editItem(index) {
  const item = filteredData[index];
  const modal = new bootstrap.Modal(document.getElementById('editModal'));
  setupModalForEdit(item);
  modal.show();
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«æ–°è¦è¿½åŠ ç”¨è¨­å®š
function setupModalForAdd() {
  document.getElementById('editModalLabel').textContent = `æ–°è¦${getCurrentViewLabel()}è¿½åŠ `;
  document.getElementById('editForm').reset();
  document.getElementById('editForm').setAttribute('data-mode', 'add');
  populateFormFields({});
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ç·¨é›†ç”¨è¨­å®š
function setupModalForEdit(item) {
  document.getElementById('editModalLabel').textContent = `${getCurrentViewLabel()}ç·¨é›†`;
  document.getElementById('editForm').setAttribute('data-mode', 'edit');
  document.getElementById('editForm').setAttribute('data-id', item['ID'] || '');
  populateFormFields(item);
}

// ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ãƒ©ãƒ™ãƒ«å–å¾—
function getCurrentViewLabel() {
  const labels = {
    'payments': 'æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿',
    'expenses': 'è²»ç”¨ãƒ‡ãƒ¼ã‚¿',
    'masters': 'ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿'
  };
  return labels[currentView] || '';
}

// ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®š
function populateFormFields(item) {
  const fields = getFormFields();
  fields.forEach(field => {
    const element = document.getElementById(field);
    if (element) {
      element.value = item[field] || '';
    }
  });
}

// ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å–å¾—
function getFormFields() {
  const fields = {
    'payments': ['ä»¶å', 'æ¡ˆä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'æ”¯æ‰•ã„å…ˆã‚³ãƒ¼ãƒ‰', 'é‡‘é¡', 'æ”¯æ‰•æ—¥', 'çŠ¶æ…‹'],
    'expenses': ['æ¡ˆä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'æ”¯æ‰•ã„å…ˆã‚³ãƒ¼ãƒ‰', 'é‡‘é¡', 'æ”¯æ‰•æ—¥', 'çŠ¶æ…‹'],
    'masters': ['æ¡ˆä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'æ”¯æ‰•ã„å…ˆã‚³ãƒ¼ãƒ‰', 'é‡‘é¡', 'ç¨®åˆ¥']
  };
  return fields[currentView] || [];
}

// ãƒ•ã‚©ãƒ¼ãƒ ä¿å­˜
function saveForm() {
  const form = document.getElementById('editForm');
  const mode = form.getAttribute('data-mode');
  const id = form.getAttribute('data-id');

  const formData = {};
  getFormFields().forEach(field => {
    const element = document.getElementById(field);
    if (element) {
      formData[field] = element.value;
    }
  });

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!validateFormData(formData)) {
    return;
  }

  showLoading(true);

  let functionName, successMessage;
  if (mode === 'add') {
    functionName = `add${currentView.charAt(0).toUpperCase() + currentView.slice(1, -1)}`;
    successMessage = 'æ–°è¦è¿½åŠ ãŒå®Œäº†ã—ã¾ã—ãŸ';
  } else {
    functionName = `update${currentView.charAt(0).toUpperCase() + currentView.slice(1, -1)}`;
    formData['ID'] = id;
    successMessage = 'æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ';
  }

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess(successMessage);
        const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        modal.hide();
        loadData();
      } else {
        showError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    })[functionName](formData);
}

// ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
function validateFormData(data) {
  const requiredFields = {
    'payments': ['ä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'é‡‘é¡'],
    'expenses': ['æ¡ˆä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'é‡‘é¡'],
    'masters': ['æ¡ˆä»¶å', 'æ”¯æ‰•ã„å…ˆ', 'é‡‘é¡']
  };

  const required = requiredFields[currentView] || [];
  
  for (const field of required) {
    if (!data[field] || data[field].trim() === '') {
      showError(`${field}ã¯å¿…é ˆé …ç›®ã§ã™`);
      return false;
    }
  }

  // é‡‘é¡ã®æ•°å€¤ãƒã‚§ãƒƒã‚¯
  if (data['é‡‘é¡'] && isNaN(Number(data['é‡‘é¡']))) {
    showError('é‡‘é¡ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    return false;
  }

  return true;
}

// å‰Šé™¤
function deleteItem(index) {
  const item = filteredData[index];
  
  if (!confirm(`ã“ã®${getCurrentViewLabel()}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
    return;
  }

  showLoading(true);

  const functionName = `delete${currentView.charAt(0).toUpperCase() + currentView.slice(1, -1)}`;

  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸ');
        loadData();
      } else {
        showError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    })[functionName](item['ID']);
}

// CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportCSV() {
  showLoading(true);
  
  const functionName = `export${currentView.charAt(0).toUpperCase() + currentView.slice(1)}CSV`;
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        downloadCSV(result.data, `${currentView}_${new Date().toISOString().split('T')[0]}.csv`);
        showSuccess('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
      } else {
        showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    })[functionName]();
}

// CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
function downloadCSV(csvContent, filename) {
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
function handleCSVImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  showLoading(true);

  const reader = new FileReader();
  reader.onload = function(e) {
    const csv = e.target.result;
    const functionName = `import${currentView.charAt(0).toUpperCase() + currentView.slice(1)}CSV`;
    
    google.script.run
      .withSuccessHandler(function(result) {
        showLoading(false);
        if (result.success) {
          showSuccess(`${result.imported || 0}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
          loadData();
        } else {
          showError('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showError('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      })[functionName](csv);
  };
  
  reader.readAsText(file, 'UTF-8');
  event.target.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
function showLoading(show) {
  const loading = document.getElementById('loading');
  if (loading) {
    loading.style.display = show ? 'block' : 'none';
  }
}

// æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function showSuccess(message) {
  showAlert(message, 'success');
}

// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function showError(message) {
  showAlert(message, 'danger');
}

// ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
function showAlert(message, type) {
  const alertContainer = document.getElementById('alertContainer') || createAlertContainer();
  
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} alert-dismissible fade show`;
  alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  alertContainer.appendChild(alert);
  
  // 5ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
  setTimeout(() => {
    if (alert.parentNode) {
      alert.remove();
    }
  }, 5000);
}

// ã‚¢ãƒ©ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
function createAlertContainer() {
  const container = document.createElement('div');
  container.id = 'alertContainer';
  container.className = 'position-fixed top-0 end-0 p-3';
  container.style.zIndex = '9999';
  document.body.appendChild(container);
  return container;
}

// ç…§åˆæ©Ÿèƒ½ï¼ˆè¿½åŠ æ©Ÿèƒ½ï¼‰
function runMatching() {
  if (!confirm('æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã¨è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®ç…§åˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\næ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
    return;
  }

  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess(`ç…§åˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚${result.matched || 0}ä»¶ã®ä¸€è‡´ã‚’ç™ºè¦‹ã—ã¾ã—ãŸã€‚`);
        loadData();
      } else {
        showError('ç…§åˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ç…§åˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    })
    .matchExpensesWithPayments();
}

// ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­
function runDiagnosis() {
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      showDiagnosisResults(result);
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('è¨ºæ–­ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    })
    .runCompleteDiagnosis();
}

// è¨ºæ–­çµæœè¡¨ç¤º
function showDiagnosisResults(result) {
  const modal = new bootstrap.Modal(document.createElement('div'));
  // è¨ºæ–­çµæœã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã™ã‚‹å‡¦ç†
  // è©³ç´°å®Ÿè£…ã¯å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
  console.log('è¨ºæ–­çµæœ:', result);
  showSuccess('ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
}
// ========== HTML UIé–¢æ•°ã®ãƒ©ãƒƒãƒ‘ãƒ¼ ==========

/**
 * æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
 */
function createNewSpreadsheet() {
  showLoading(true, 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
        showAlert(`
          <strong>æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ</strong><br>
          <small>ID: ${result.spreadsheetId}</small><br>
          <a href="${result.spreadsheetUrl}" target="_blank">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã</a>
        `);
      } else {
        showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .createNewSpreadsheet();
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
 */
function initializeCompleteSystem() {
  if (!confirm('ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ãŒã€è¨­å®šã¨ã‚·ãƒ¼ãƒˆæ§‹é€ ãŒå†ä½œæˆã•ã‚Œã¾ã™ã€‚')) {
    return;
  }
  
  showLoading(true, 'ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ');
        loadData();
      } else {
        showError('åˆæœŸåŒ–ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .initializeCompleteSystem();
}

/**
 * ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆ
 */
function createSampleData() {
  if (!confirm('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
    return;
  }
  
  showLoading(true, 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã—ãŸ');
        loadData();
      } else {
        showError('ä½œæˆã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .createSampleData();
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
 */
function checkSystemStatus() {
  showLoading(true, 'ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªå®Œäº†');
        const status = result.status;
        showAlert(`
          <strong>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</strong><br>
          <small>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ: ${status.spreadsheet ? 'æ­£å¸¸' : 'ã‚¨ãƒ©ãƒ¼'}</small><br>
          <small>ã‚·ãƒ¼ãƒˆæ•°: ${Object.keys(status.sheets).length}</small><br>
          <small>ç¢ºèªæ™‚åˆ»: ${new Date(status.timestamp).toLocaleString()}</small>
        `);
      } else {
        showError('çŠ¶æ…‹ç¢ºèªã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .checkSystemStatus();
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­å®Ÿè¡Œ
 */
function runSystemDiagnosis() {
  showLoading(true, 'ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚’å®Ÿè¡Œä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­å®Œäº†');
        const diagnosis = result.diagnosis;
        showAlert(`
          <strong>è¨ºæ–­çµæœ: ${diagnosis.summary.status}</strong><br>
          <small>ãƒã‚§ãƒƒã‚¯é€šé: ${diagnosis.summary.passedChecks}/${diagnosis.summary.totalChecks}</small><br>
          <small>å®Ÿè¡Œæ™‚åˆ»: ${new Date(diagnosis.timestamp).toLocaleString()}</small>
        `);
      } else {
        showError('è¨ºæ–­ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .runSystemDiagnosis();
}

/**
 * ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
 */
function checkDataIntegrity() {
  showLoading(true, 'ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Œäº†');
        const integrity = result.integrity;
        showAlert(`
          <strong>æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ</strong><br>
          <small>æ­£å¸¸ãƒ¬ã‚³ãƒ¼ãƒ‰: ${integrity.summary.validRecords}</small><br>
          <small>å•é¡Œãƒ¬ã‚³ãƒ¼ãƒ‰: ${integrity.summary.invalidRecords}</small><br>
          <small>ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: ${integrity.summary.totalRecords}</small>
        `);
      } else {
        showError('ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .checkDataIntegrity();
}

/**
 * ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆè¡¨ç¤º
 */
function showPerformanceStats() {
  showLoading(true, 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆã‚’å–å¾—ä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆå–å¾—å®Œäº†');
        const stats = result.stats;
        showAlert(`
          <strong>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆ</strong><br>
          <small>ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º - æ”¯æ‰•ã„: ${stats.dataSize.payments}ä»¶</small><br>
          <small>ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º - è²»ç”¨: ${stats.dataSize.expenses}ä»¶</small><br>
          <small>ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º - ãƒã‚¹ã‚¿ãƒ¼: ${stats.dataSize.masters}ä»¶</small><br>
          <small>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: ${stats.systemHealth}</small>
        `);
      } else {
        showError('çµ±è¨ˆå–å¾—ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .showPerformanceStats();
}

/**
 * ç·Šæ€¥ä¿®å¾©å®Ÿè¡Œ
 */
function runEmergencyRepair() {
  if (!confirm('ç·Šæ€¥ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nã‚·ã‚¹ãƒ†ãƒ ã®ä¸æ•´åˆã‚„ã‚¨ãƒ©ãƒ¼ã‚’è‡ªå‹•ã§ä¿®å¾©ã‚’è©¦ã¿ã¾ã™ã€‚')) {
    return;
  }
  
  showLoading(true, 'ç·Šæ€¥ä¿®å¾©ã‚’å®Ÿè¡Œä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('ç·Šæ€¥ä¿®å¾©å®Œäº†');
        const repair = result.repair;
        showAlert(`
          <strong>ä¿®å¾©çµæœ</strong><br>
          <small>æˆåŠŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${repair.summary.successActions}</small><br>
          <small>å¤±æ•—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${repair.summary.failedActions}</small><br>
          <small>åˆè¨ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${repair.summary.totalActions}</small>
        `);
        loadData();
      } else {
        showError('ä¿®å¾©ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .runEmergencyRepair();
}

/**
 * å…¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°
 */
function refreshAllData() {
  loadData();
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’è¡¨ç¤º
 */
function showSystemStatus() {
  checkSystemStatus();
}

// ========== CSV ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢æ•° ==========

/**
 * Pythonã‚¢ãƒ—ãƒªã®å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
 */
function importPythonAppData() {
  if (!confirm('Pythonã‚¢ãƒ—ãƒªã®å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã€å®Ÿéš›ã®ãƒ©ã‚¸ã‚ªå±€ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚')) {
    return;
  }
  
  showLoading(true, 'å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('å®Ÿãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
        showAlert(`
          <strong>ğŸ“» å®Ÿéš›ã®ãƒ©ã‚¸ã‚ªå±€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ</strong><br>
          <small>æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿: ${result.results.payments}ä»¶</small><br>
          <small>è²»ç”¨ãƒ‡ãƒ¼ã‚¿: ${result.results.expenses}ä»¶</small><br>
          <small>ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿: ${result.results.masters}ä»¶</small><br>
          <br>
          <strong>å«ã¾ã‚Œã‚‹å®Ÿãƒ‡ãƒ¼ã‚¿ä¾‹:</strong><br>
          <small>${result.details['ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­']}</small><br>
          <small>${result.details['ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡']}</small>
        `);
        loadData(); // ç”»é¢æ›´æ–°
      } else {
        showError('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .importPythonAppData();
}

/**
 * CSVãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
 */
function importCSVData(csvText, dataType) {
  if (!csvText || !csvText.trim()) {
    showError('CSVãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
    return;
  }
  
  showLoading(true, 'CSVãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showSuccess('CSVãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
        showAlert(`
          <strong>CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†</strong><br>
          <small>ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—: ${dataType}</small><br>
          <small>æˆåŠŸ: ${result.results.imported}ä»¶</small><br>
          <small>å¤±æ•—: ${result.results.skipped}ä»¶</small><br>
          ${result.results.errors.length > 0 ? '<br><small>ã‚¨ãƒ©ãƒ¼è©³ç´°:<br>' + result.results.errors.slice(0, 3).join('<br>') + '</small>' : ''}
        `);
        loadData(); // ç”»é¢æ›´æ–°
      } else {
        showError('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .importCSVData(csvText, dataType, true); // clearExisting = true
}

/**
 * CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
 */
function showCSVImportDialog() {
  // CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  const dialogHTML = `
    <div id="csvImportModal" class="modal fade" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">CSVãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—</label>
              <select class="form-select" id="csvDataType">
                <option value="payments">æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿</option>
                <option value="expenses">è²»ç”¨ãƒ‡ãƒ¼ã‚¿</option>
                <option value="masters">ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">CSVãƒ•ã‚¡ã‚¤ãƒ«</label>
              <input type="file" class="form-control" id="csvFileInput" accept=".csv" />
              <div class="form-text">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œå¿…é ˆï¼‰</div>
            </div>
            <div class="mb-3">
              <label class="form-label">ã¾ãŸã¯CSVãƒ†ã‚­ã‚¹ãƒˆã‚’ç›´æ¥è²¼ã‚Šä»˜ã‘</label>
              <textarea class="form-control" id="csvTextInput" rows="6" placeholder="id,subject,project_name,payee..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" class="btn btn-primary" onclick="executeCSVImport()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
  const existingModal = document.getElementById('csvImportModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
  document.body.insertAdjacentHTML('beforeend', dialogHTML);
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  const modal = new bootstrap.Modal(document.getElementById('csvImportModal'));
  modal.show();
  
  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('csvFileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file && file.type === 'text/csv') {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('csvTextInput').value = e.target.result;
      };
      reader.readAsText(file);
    }
  });
}

/**
 * CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
 */
function executeCSVImport() {
  const dataType = document.getElementById('csvDataType').value;
  const csvText = document.getElementById('csvTextInput').value.trim();
  
  if (!csvText) {
    showError('CSVãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  const modal = bootstrap.Modal.getInstance(document.getElementById('csvImportModal'));
  modal.hide();
  
  // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
  importCSVData(csvText, dataType);
}

// ========== ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼é–¢æ•°ï¼ˆæ‹¡å¼µç‰ˆï¼‰ ==========

/**
 * ãƒ‡ãƒ¼ã‚¿ä»¶æ•°æ¤œè¨¼
 */
function verifyDataCounts() {
  showLoading(true, 'ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã‚’æ¤œè¨¼ä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        const verification = result.verification;
        showSuccess('ãƒ‡ãƒ¼ã‚¿ä»¶æ•°æ¤œè¨¼å®Œäº†');
        showAlert(`
          <strong>ãƒ‡ãƒ¼ã‚¿ä»¶æ•°æ¤œè¨¼çµæœ: ${verification.summary.status}</strong><br>
          <small>æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿: ${verification.counts.payments}ä»¶</small><br>
          <small>è²»ç”¨ãƒ‡ãƒ¼ã‚¿: ${verification.counts.expenses}ä»¶</small><br>
          <small>ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿: ${verification.counts.masters}ä»¶</small><br>
          <small>ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: ${verification.summary.totalRecords}ä»¶</small><br>
          ${verification.summary.discrepancies.length > 0 ? '<br><small style="color:orange;">ä¸æ•´åˆ:<br>' + verification.summary.discrepancies.join('<br>') + '</small>' : ''}
        `);
      } else {
        showError('ãƒ‡ãƒ¼ã‚¿ä»¶æ•°æ¤œè¨¼ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .verifyDataCounts();
}

/**
 * ãƒ‡ãƒ¼ã‚¿é‡è¤‡ãƒã‚§ãƒƒã‚¯
 */
function checkDataDuplicates() {
  showLoading(true, 'ãƒ‡ãƒ¼ã‚¿é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        const duplicateCheck = result.duplicateCheck;
        showSuccess('ãƒ‡ãƒ¼ã‚¿é‡è¤‡ãƒã‚§ãƒƒã‚¯å®Œäº†');
        showAlert(`
          <strong>ãƒ‡ãƒ¼ã‚¿é‡è¤‡ãƒã‚§ãƒƒã‚¯çµæœ</strong><br>
          <small>é‡è¤‡ä»¶æ•°: ${duplicateCheck.summary.totalDuplicates}ä»¶</small><br>
          <small>å½±éŸ¿ãƒ†ãƒ¼ãƒ–ãƒ«: ${duplicateCheck.summary.affectedTables.join(', ') || 'ãªã—'}</small><br>
          ${duplicateCheck.summary.totalDuplicates > 0 ? '<br><small style="color:orange;">é‡è¤‡ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚</small>' : '<br><small style="color:green;">é‡è¤‡ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</small>'}
        `);
      } else {
        showError('ãƒ‡ãƒ¼ã‚¿é‡è¤‡ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .checkDataDuplicates();
}

/**
 * ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ç¯„å›²ãƒã‚§ãƒƒã‚¯
 */
function validateFieldRanges() {
  showLoading(true, 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ç¯„å›²ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        const validation = result.validation;
        showSuccess('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ç¯„å›²ãƒã‚§ãƒƒã‚¯å®Œäº†');
        showAlert(`
          <strong>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ç¯„å›²ãƒã‚§ãƒƒã‚¯çµæœ</strong><br>
          <small>å•é¡Œä»¶æ•°: ${validation.summary.totalIssues}ä»¶</small><br>
          <small>é‡‘é¡ã‚¨ãƒ©ãƒ¼: ${validation.summary.categories.amount}ä»¶</small><br>
          <small>ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${validation.summary.categories.code}ä»¶</small><br>
          <small>ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${validation.summary.categories.text}ä»¶</small><br>
          ${validation.summary.totalIssues > 0 ? '<br><small style="color:orange;">ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚</small>' : '<br><small style="color:green;">ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ãŒé©åˆ‡ã§ã™ã€‚</small>'}
        `);
      } else {
        showError('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ç¯„å›²ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .validateFieldRanges();
}

/**
 * çµ±åˆãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ï¼ˆå…¨æ¤œè¨¼ã‚’å®Ÿè¡Œï¼‰
 */
function runCompleteDataValidation() {
  if (!confirm('çµ±åˆãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ†ã‚¹ãƒˆã‚’é †æ¬¡å®Ÿè¡Œã—ã¾ã™ã€‚')) {
    return;
  }
  
  showLoading(true, 'çµ±åˆãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’å®Ÿè¡Œä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        const validation = result.validation;
        const status = validation.summary.overallStatus;
        const statusColor = status === 'PASS' ? 'green' : status === 'WARNING' ? 'orange' : 'red';
        
        showSuccess('çµ±åˆãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å®Œäº†');
        showAlert(`
          <strong style="color:${statusColor};">çµ±åˆãƒ‡ãƒ¼ã‚¿æ¤œè¨¼çµæœ: ${status}</strong><br>
          <small>å®Ÿè¡Œãƒ†ã‚¹ãƒˆæ•°: ${validation.summary.totalTests}</small><br>
          <small>æˆåŠŸãƒ†ã‚¹ãƒˆ: ${validation.summary.passedTests}</small><br>
          <small>å¤±æ•—ãƒ†ã‚¹ãƒˆ: ${validation.summary.failedTests}</small><br>
          <br>
          <strong>å®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆ:</strong><br>
          <small>âœ“ ãƒ‡ãƒ¼ã‚¿ä»¶æ•°æ¤œè¨¼</small><br>
          <small>âœ“ ãƒ‡ãƒ¼ã‚¿é‡è¤‡ãƒã‚§ãƒƒã‚¯</small><br>
          <small>âœ“ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ç¯„å›²ãƒã‚§ãƒƒã‚¯</small><br>
          <small>âœ“ ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯</small><br>
          <br>
          <small>è©³ç´°ã¯å„å€‹åˆ¥ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã§ç¢ºèªã§ãã¾ã™ã€‚</small>
        `);
      } else {
        showError('çµ±åˆãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .runCompleteDataValidation();
}

// ========== ãƒ‡ãƒãƒƒã‚°é–¢æ•° ==========

/**
 * ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ
 */
function runSystemDebug() {
  showLoading(true, 'ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒãƒƒã‚°ã‚’å®Ÿè¡Œä¸­...');
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      console.log('ãƒ‡ãƒãƒƒã‚°çµæœ:', result);
      if (result.success) {
        showAlert(`
          <strong>ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒãƒƒã‚°çµæœ</strong><br>
          <small>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID: ${result.spreadsheetId}</small><br>
          <small>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå: ${result.spreadsheetName}</small><br>
          <br>
          <strong>ã‚·ãƒ¼ãƒˆè¡Œæ•°:</strong><br>
          <small>æ”¯æ‰•ã„ã‚·ãƒ¼ãƒˆ: ${result.sheetRows.payments}è¡Œ</small><br>
          <small>è²»ç”¨ã‚·ãƒ¼ãƒˆ: ${result.sheetRows.expenses}è¡Œ</small><br>
          <small>ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆ: ${result.sheetRows.masters}è¡Œ</small><br>
          <br>
          <strong>ãƒ‡ãƒ¼ã‚¿å–å¾—çµæœ:</strong><br>
          <small>æ”¯æ‰•ã„: ${result.dataResults.payments.success ? 'æˆåŠŸ' : 'å¤±æ•—'} (${result.dataResults.payments.totalRows}ä»¶)</small><br>
          <small>è²»ç”¨: ${result.dataResults.expenses.success ? 'æˆåŠŸ' : 'å¤±æ•—'} (${result.dataResults.expenses.totalRows}ä»¶)</small><br>
          <small>ãƒã‚¹ã‚¿ãƒ¼: ${result.dataResults.masters.success ? 'æˆåŠŸ' : 'å¤±æ•—'} (${result.dataResults.masters.totalRows}ä»¶)</small>
        `);
        showSuccess('ãƒ‡ãƒãƒƒã‚°å®Œäº†ã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      } else {
        showError('ãƒ‡ãƒãƒƒã‚°ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message);
    })
    .debugBasicFunctions();
}

/**
 * ç·Šæ€¥ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ¼ã‚¿è¾¼ã¿ï¼‰
 */
function emergencySystemSetup() {
  if (!confirm('ç·Šæ€¥ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’åˆæœŸåŒ–ã—ã€å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚')) {
    return;
  }
  
  showLoading(true, 'ç·Šæ€¥ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚’å®Ÿè¡Œä¸­...');
  
  // 1. ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–çµæœ:', result);
      if (result.success) {
        showSuccess('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†ã€‚å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');
        
        // 2. å®Ÿãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        google.script.run
          .withSuccessHandler(function(importResult) {
            console.log('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ:', importResult);
            showLoading(false);
            if (importResult.success) {
              showSuccess('ç·Šæ€¥ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
              loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            } else {
              showError('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—: ' + importResult.message);
            }
          })
          .withFailureHandler(function(error) {
            showLoading(false);
            showError('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
          })
          .importPythonAppData();
      } else {
        showLoading(false);
        showError('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã«å¤±æ•—: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showError('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
    })
    .initializeCompleteSystem();
}

// === è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼æœˆæ¬¡åæ˜ æ©Ÿèƒ½ ===

function openMasterReflectionModal() {
    const modal = new bootstrap.Modal(document.getElementById('masterReflectionModal'));

    // ç¾åœ¨ã®å¹´æœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;

    document.getElementById('reflectionYear').value = currentYear;
    document.getElementById('reflectionMonth').value = currentMonth;

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    document.getElementById('reflectionPreview').innerHTML = '';
    document.getElementById('reflectionSummary').innerHTML = '';

    modal.show();
}

function previewMasterReflection() {
    const year = parseInt(document.getElementById('reflectionYear').value);
    const month = parseInt(document.getElementById('reflectionMonth').value);

    if (!year || !month || month < 1 || month > 12) {
        showError('æ­£ã—ã„å¹´æœˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    showMessage('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆä¸­...', 'info');

    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                displayReflectionPreview(result);
                showMessage('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
            } else {
                showError(result ? result.message : 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                document.getElementById('reflectionPreview').innerHTML = '';
                document.getElementById('reflectionSummary').innerHTML = '';
            }
        })
        .withFailureHandler(function(error) {
            console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            showError(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error}`);
            document.getElementById('reflectionPreview').innerHTML = '';
            document.getElementById('reflectionSummary').innerHTML = '';
        })
        .previewExpensesFromMaster(year, month);
}

function displayReflectionPreview(result) {
    const previewDiv = document.getElementById('reflectionPreview');
    const summaryDiv = document.getElementById('reflectionSummary');

    // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
    if (result.summary) {
        summaryDiv.innerHTML = `
            <div class="alert alert-info">
                <h6><i class="bi bi-info-circle"></i> ${result.targetPeriod} åæ˜ äºˆå®š</h6>
                <div class="row">
                    <div class="col-md-3">
                        <strong>å¯¾è±¡ä»¶æ•°:</strong> ${result.summary.total}ä»¶
                    </div>
                    <div class="col-md-3">
                        <strong>æ–°è¦ä½œæˆ:</strong> ${result.summary.newItems}ä»¶
                    </div>
                    <div class="col-md-3">
                        <strong>é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—:</strong> ${result.summary.duplicates}ä»¶
                    </div>
                    <div class="col-md-3">
                        <strong>åˆè¨ˆé‡‘é¡:</strong> Â¥${(result.summary.totalAmount || 0).toLocaleString()}
                    </div>
                </div>
            </div>
        `;
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
    if (result.preview && result.preview.length > 0) {
        let html = `
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>æ¡ˆä»¶å</th>
                            <th>æ”¯æ‰•ã„å…ˆ</th>
                            <th>ç¨®åˆ¥</th>
                            <th>å›æ•°</th>
                            <th>é‡‘é¡</th>
                            <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        result.preview.forEach(item => {
            const rowClass = item.isDuplicate ? 'table-warning' : '';
            html += `
                <tr class="${rowClass}">
                    <td>${item.projectName}</td>
                    <td>${item.payee}</td>
                    <td>${item.paymentType}</td>
                    <td>${item.broadcastCount}å›</td>
                    <td class="text-end">Â¥${(item.amount || 0).toLocaleString()}</td>
                    <td>
                        <span class="badge ${item.isDuplicate ? 'bg-warning' : 'bg-success'}">
                            ${item.action}
                        </span>
                    </td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        previewDiv.innerHTML = html;
    } else {
        previewDiv.innerHTML = '<div class="alert alert-secondary">åæ˜ å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    }
}

function executeMasterReflection() {
    const year = parseInt(document.getElementById('reflectionYear').value);
    const month = parseInt(document.getElementById('reflectionMonth').value);

    if (!year || !month || month < 1 || month > 12) {
        showError('æ­£ã—ã„å¹´æœˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    if (!confirm(`${year}å¹´${month}æœˆåˆ†ã®è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰åæ˜ ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    showMessage('è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆä¸­...', 'info');

    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showMessage(result.message, 'success');

                // åæ˜ çµæœã‚’è¡¨ç¤º
                displayReflectionResult(result);

                // è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                refreshExpenses();
                refreshStats();

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('masterReflectionModal'));
                    modal.hide();
                }, 2000);

            } else {
                showError(result ? result.message : 'è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®åæ˜ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .withFailureHandler(function(error) {
            console.error('è²»ç”¨ãƒ‡ãƒ¼ã‚¿åæ˜ ã‚¨ãƒ©ãƒ¼:', error);
            showError(`è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®åæ˜ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error}`);
        })
        .generateExpensesFromMaster(year, month);
}

function displayReflectionResult(result) {
    const resultHtml = `
        <div class="alert alert-success">
            <h6><i class="bi bi-check-circle"></i> åæ˜ å®Œäº†</h6>
            <p><strong>${result.targetPeriod}</strong> ã®è²»ç”¨ãƒ‡ãƒ¼ã‚¿åæ˜ ãŒå®Œäº†ã—ã¾ã—ãŸ</p>
            <ul class="mb-0">
                <li>æ–°è¦ä½œæˆ: ${result.generated}ä»¶</li>
                <li>é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: ${result.skipped}ä»¶</li>
                ${result.errors > 0 ? `<li class="text-warning">ã‚¨ãƒ©ãƒ¼: ${result.errors}ä»¶</li>` : ''}
            </ul>
        </div>
    `;

    document.getElementById('reflectionSummary').innerHTML = resultHtml;

    if (result.errorDetails && result.errorDetails.length > 0) {
        const errorHtml = `
            <div class="alert alert-warning mt-2">
                <h6><i class="bi bi-exclamation-triangle"></i> ã‚¨ãƒ©ãƒ¼è©³ç´°</h6>
                <ul class="mb-0">
                    ${result.errorDetails.map(error => `<li>${error}</li>`).join('')}
                </ul>
            </div>
        `;
        document.getElementById('reflectionSummary').innerHTML += errorHtml;
    }
}

// === æœˆæ¬¡åæ˜ ã®ä¾¿åˆ©é–¢æ•° ===

function setCurrentMonth() {
    const now = new Date();
    document.getElementById('reflectionYear').value = now.getFullYear();
    document.getElementById('reflectionMonth').value = now.getMonth() + 1;
    previewMasterReflection();
}

function setNextMonth() {
    const now = new Date();
    let year = now.getFullYear();
    let month = now.getMonth() + 2; // ç¿Œæœˆ

    if (month > 12) {
        month = 1;
        year++;
    }

    document.getElementById('reflectionYear').value = year;
    document.getElementById('reflectionMonth').value = month;
    previewMasterReflection();
}

function setPreviousMonth() {
    const now = new Date();
    let year = now.getFullYear();
    let month = now.getMonth(); // å‰æœˆ

    if (month <= 0) {
        month = 12;
        year--;
    }

    document.getElementById('reflectionYear').value = year;
    document.getElementById('reflectionMonth').value = month;
    previewMasterReflection();
}

// === ãƒã‚¹ã‚¿ãƒ¼ã‚¿ãƒ–ã®æœˆæ¬¡æ“ä½œæ©Ÿèƒ½è¿½åŠ  ===

function generateFromMasterForCurrentMonth() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;

    if (!confirm(`${year}å¹´${month}æœˆåˆ†ã®è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    showMessage('è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆä¸­...', 'info');

    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showMessage(`${result.message} (ç”Ÿæˆ: ${result.generated}ä»¶, ã‚¹ã‚­ãƒƒãƒ—: ${result.skipped}ä»¶)`, 'success');
                refreshExpenses();
                refreshStats();
            } else {
                showError(result ? result.message : 'è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .withFailureHandler(function(error) {
            console.error('è²»ç”¨ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            showError(`è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error}`);
        })
        .generateExpensesFromMaster(year, month);
}

function generateFromMasterForNextMonth() {
    const now = new Date();
    let year = now.getFullYear();
    let month = now.getMonth() + 2; // ç¿Œæœˆ

    if (month > 12) {
        month = 1;
        year++;
    }

    if (!confirm(`${year}å¹´${month}æœˆåˆ†ã®è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è²»ç”¨ãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    showMessage('è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆä¸­...', 'info');

    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showMessage(`${result.message} (ç”Ÿæˆ: ${result.generated}ä»¶, ã‚¹ã‚­ãƒƒãƒ—: ${result.skipped}ä»¶)`, 'success');
                refreshExpenses();
                refreshStats();
            } else {
                showError(result ? result.message : 'è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .withFailureHandler(function(error) {
            console.error('è²»ç”¨ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            showError(`è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error}`);
        })
        .generateExpensesFromMaster(year, month);
}

// === ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ===
document.addEventListener('DOMContentLoaded', function() {
    // æœˆæ¬¡åæ˜ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const yearInput = document.getElementById('reflectionYear');
    const monthInput = document.getElementById('reflectionMonth');

    if (yearInput && monthInput) {
        yearInput.addEventListener('change', function() {
            if (this.value && monthInput.value) {
                previewMasterReflection();
            }
        });

        monthInput.addEventListener('change', function() {
            if (this.value && yearInput.value) {
                previewMasterReflection();
            }
        });
    }
});

// ãƒ‡ãƒãƒƒã‚°ç”¨é–¢æ•° - JavaScriptãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒ†ã‚¹ãƒˆ
function debugTest() {
    console.log('JavaScript is loaded successfully!');
    alert('JavaScript is working!');
    return true;
}

// é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
function checkFunctionDefinitions() {
    const functions = [
        'initializeCompleteSystem',
        'createSampleData',
        'checkSystemStatus',
        'createNewSpreadsheet',
        'importPythonAppData',
        'showCSVImportDialog'
    ];

    const results = {};
    functions.forEach(funcName => {
        results[funcName] = typeof window[funcName] === 'function';
    });

    console.log('Function definitions check:', results);
    return results;
}

// ä¸è¶³ã—ã¦ã„ãŸé–¢æ•°ã‚’è¿½åŠ 
function refreshPayments() {
    return getPaymentData();
}

function searchPayments() {
    return getPaymentData();
}

function resetPaymentFilters() {
    return getPaymentData();
}

function refreshExpenses() {
    return getExpenseData();
}

function searchExpenses() {
    return getExpenseData();
}

function resetExpenseFilters() {
    return getExpenseData();
}

function refreshMasters() {
    return getMasterData();
}

function searchMasters() {
    return getMasterData();
}

function resetMasterFilters() {
    return getMasterData();
}

function runAutoMatching() {
    if (!confirm('æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã¨è²»ç”¨ãƒ‡ãƒ¼ã‚¿ã®ç…§åˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\næ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
        return;
    }

    showLoading(true, 'ç…§åˆå‡¦ç†ã‚’å®Ÿè¡Œä¸­...');

    google.script.run
        .withSuccessHandler(function(result) {
            showLoading(false);
            if (result.success) {
                showSuccess(`ç…§åˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚${result.matched || 0}ä»¶ã®ä¸€è‡´ã‚’ç™ºè¦‹ã—ã¾ã—ãŸã€‚`);
                loadData();
            } else {
                showError('ç…§åˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
            }
        })
        .withFailureHandler(function(error) {
            showLoading(false);
            showError('ç…§åˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .runAutoMatching();
}