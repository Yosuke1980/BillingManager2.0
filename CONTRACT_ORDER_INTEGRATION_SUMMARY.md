# å¥‘ç´„ãƒ»ç™ºæ³¨çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ç§»è¡Œå®Œäº†ã‚µãƒãƒªãƒ¼

## ğŸ“‹ æ¦‚è¦

å¥‘ç´„ç®¡ç†ï¼ˆorder_contractsï¼‰ã¨ç™ºæ³¨ç®¡ç†ï¼ˆexpenses_orderï¼‰ã‚’çµ±åˆã—ã€ã‚·ãƒ³ãƒ—ãƒ«ã§ä¸€è²«æ€§ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ç§»è¡Œã—ã¾ã—ãŸã€‚

## ğŸ¯ ç›®çš„

### ç§»è¡Œå‰ã®å•é¡Œç‚¹
- **äºŒé‡ç®¡ç†**: å¥‘ç´„ã¨ç™ºæ³¨ãŒåˆ¥ã€…ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†ã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡ã‚„ä¸æ•´åˆãŒç™ºç”Ÿ
- **ç´ä»˜ã‘ã®ä¸æ˜ç¢ºã•**: å¥‘ç´„ã¨å®Ÿéš›ã®æ”¯æ‰•ã„ã®é–¢ä¿‚ãŒæ›–æ˜§
- **è‡ªå‹•åŒ–ã®æ¬ å¦‚**: å¥‘ç´„ã‚’ä½œæˆã—ã¦ã‚‚ã€ç™ºæ³¨ãƒ‡ãƒ¼ã‚¿ã¯æ‰‹å‹•ã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã£ãŸ

### ç§»è¡Œå¾Œã®ãƒ¡ãƒªãƒƒãƒˆ
âœ… **ãƒ‡ãƒ¼ã‚¿ã®ä¸€å…ƒç®¡ç†**: å¥‘ç´„ã¨è²»ç”¨ãŒ`contract_id`ã§æ˜ç¢ºã«ç´ä»˜ã
âœ… **ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ **: ãƒ†ãƒ¼ãƒ–ãƒ«åã¨ã‚«ãƒ©ãƒ åãŒæ˜ç¢ºã§ç†è§£ã—ã‚„ã™ã„
âœ… **æ‹¡å¼µæ€§**: å°†æ¥çš„ãªæ©Ÿèƒ½è¿½åŠ ï¼ˆè‡ªå‹•è²»ç”¨é …ç›®ç”Ÿæˆãªã©ï¼‰ãŒå®¹æ˜“
âœ… **æ•´åˆæ€§**: ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡ã‚„ä¸ä¸€è‡´ã‚’é˜²æ­¢

---

## ğŸ“Š æ–°ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

### 1. **contractsï¼ˆå¥‘ç´„ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰**

å¥‘ç´„ã®ãƒã‚¹ã‚¿ãƒ¼æƒ…å ±ã‚’ç®¡ç†

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
|---------|-----|------|
| id | INTEGER | å¥‘ç´„IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰|
| production_id | INTEGER | ç•ªçµ„ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆIDï¼ˆNULLè¨±å¯ï¼‰|
| project_id | INTEGER | æ¡ˆä»¶IDï¼ˆNULLè¨±å¯ï¼‰|
| partner_id | INTEGER | å–å¼•å…ˆIDï¼ˆå¿…é ˆï¼‰|
| work_type | TEXT | æ¥­å‹™ç¨®åˆ¥ï¼ˆåˆ¶ä½œ/å‡ºæ¼”ï¼‰|
| item_name | TEXT | å¥‘ç´„é …ç›®å |
| contract_type | TEXT | å¥‘ç´„ç¨®åˆ¥ï¼ˆregular_fixed/regular_count/spotï¼‰|
| contract_start_date | DATE | å¥‘ç´„é–‹å§‹æ—¥ |
| contract_end_date | DATE | å¥‘ç´„çµ‚äº†æ—¥ |
| payment_type | TEXT | æ”¯æ‰•ã‚¿ã‚¤ãƒ—ï¼ˆæœˆé¡å›ºå®š/å›æ•°æ‰•ã„/å˜ç™ºï¼‰|
| unit_price | REAL | å˜ä¾¡ |
| spot_amount | REAL | å˜ç™ºé‡‘é¡ |
| payment_timing | TEXT | æ”¯æ‰•ã‚¿ã‚¤ãƒŸãƒ³ã‚° |
| document_type | TEXT | æ›¸é¡ç¨®åˆ¥ï¼ˆå¥‘ç´„æ›¸/ç™ºæ³¨æ›¸/ç™ºæ³¨ãƒ¡ãƒ¼ãƒ«ï¼‰|
| document_status | TEXT | æ›¸é¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæœª/æ¸ˆï¼‰|
| auto_renewal_enabled | INTEGER | è‡ªå‹•å»¶é•·æœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| renewal_period_months | INTEGER | å»¶é•·æœŸé–“ï¼ˆæœˆæ•°ï¼‰|
| notes | TEXT | å‚™è€ƒ |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_contracts_production` (production_id)
- `idx_contracts_partner` (partner_id)
- `idx_contracts_dates` (contract_start_date, contract_end_date)
- `idx_contracts_work_type` (work_type)

---

### 2. **expense_itemsï¼ˆè²»ç”¨é …ç›®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰**

å®Ÿéš›ã®æ”¯æ‰•ã„ãƒ»ç™ºæ³¨ã®æ˜ç´°ã‚’ç®¡ç†

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
|---------|-----|------|
| id | INTEGER | è²»ç”¨é …ç›®IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰|
| contract_id | INTEGER | å¥‘ç´„IDï¼ˆNULLè¨±å¯ï¼šå¥‘ç´„å¤–ã®è²»ç”¨ï¼‰|
| production_id | INTEGER | ç•ªçµ„ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆIDï¼ˆå¿…é ˆï¼‰|
| partner_id | INTEGER | å–å¼•å…ˆIDï¼ˆNULLè¨±å¯ï¼‰|
| item_name | TEXT | è²»ç”¨é …ç›®å |
| amount | REAL | é‡‘é¡ |
| implementation_date | DATE | å®Ÿæ–½æ—¥ |
| order_number | TEXT | ç™ºæ³¨ç•ªå·ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰|
| order_date | DATE | ç™ºæ³¨æ—¥ |
| status | TEXT | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆç™ºæ³¨äºˆå®š/ç™ºæ³¨æ¸ˆ/æ¤œåæ¸ˆï¼‰|
| expected_payment_date | DATE | æ”¯æ‰•äºˆå®šæ—¥ |
| payment_date | DATE | å®Ÿéš›ã®æ”¯æ‰•æ—¥ |
| payment_status | TEXT | æ”¯æ‰•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæœªæ‰•ã„/æ”¯æ‰•æ¸ˆ/é‡‘é¡ç›¸é•ï¼‰|
| payment_matched_id | INTEGER | ç…§åˆã•ã‚ŒãŸå…¥å‡ºé‡‘ID |
| notes | TEXT | å‚™è€ƒ |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_expense_items_contract` (contract_id)
- `idx_expense_items_production` (production_id)
- `idx_expense_items_partner` (partner_id)
- `idx_expense_items_payment_date` (expected_payment_date)
- `idx_expense_items_status` (status, payment_status)

---

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ç§»è¡Œçµæœ

### ç§»è¡Œå‰
- `order_contracts`: 16ä»¶
- `expenses_order`: 80ä»¶

### ç§»è¡Œå¾Œ
- `contracts`: 16ä»¶ âœ…
- `expense_items`: 80ä»¶ âœ…
- æ—§ãƒ†ãƒ¼ãƒ–ãƒ«: `order_contracts_old`, `expenses_order_old`ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰

**ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: [migrate_to_unified_tables.py](migrate_to_unified_tables.py)

---

## ğŸ› ï¸ ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚µãƒãƒªãƒ¼

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç§»è¡Œ
- âœ… æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆcontracts, expense_itemsï¼‰
- âœ… æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼ˆ16ä»¶ã®å¥‘ç´„ã€80ä»¶ã®è²»ç”¨é …ç›®ï¼‰
- âœ… æ—§ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ_old ã«ãƒªãƒãƒ¼ãƒ ï¼‰

### Phase 2: database_manager.py ä¿®æ­£
- âœ… å…¨SQLã‚¯ã‚¨ãƒªã‚’æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾å¿œï¼ˆ60ç®‡æ‰€ä»¥ä¸Šï¼‰
- âœ… ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£:
  - `save_order_contract()`: contracts ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
  - `delete_order_contract()`: contracts ã‹ã‚‰å‰Šé™¤
  - `get_expenses_by_production()`: expense_items ã‹ã‚‰å–å¾—
  - `save_expense_order()`: expense_items ã«ä¿å­˜
  - `get_production_cast_with_contracts()`: å‡ºæ¼”è€…ã¨å¥‘ç´„ã‚’å–å¾—
  - `get_production_producers_with_contracts()`: åˆ¶ä½œè€…ã¨å¥‘ç´„ã‚’å–å¾—

### Phase 3: UIä¿®æ­£
- âœ… production_edit_dialog.py: ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆdocument_statusï¼‰
- âœ… expense_edit_dialog.py: å¾Œæ–¹äº’æ›æ€§ã«ã‚ˆã‚Šä¿®æ­£ä¸è¦

---

## ğŸ”‘ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®å¤‰æ›´

### çµ±ä¸€ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å

| æ—§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å | æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å | ç†ç”± |
|--------------|--------------|------|
| `order_contracts` | `contracts` | ã‚·ãƒ³ãƒ—ãƒ«åŒ– |
| `expenses_order` | `expense_items` | æ˜ç¢ºãªå‘½å |
| `supplier_id` | `partner_id` | å–å¼•å…ˆã®çµ±ä¸€ |
| `order_type` | `document_type` | æ›¸é¡ç¨®åˆ¥ã®æ˜ç¢ºåŒ– |
| `order_status` | `document_status` | æ›¸é¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ˜ç¢ºåŒ– |

### å¾Œæ–¹äº’æ›æ€§

database_manager.pyã§ã¯ã€ä»¥ä¸‹ã®å¾Œæ–¹äº’æ›æ€§ã‚’ç¢ºä¿:
```python
# supplier_idãŒã‚ã‚Œã°partner_idã¨ã—ã¦æ‰±ã†
partner_id = expense_data.get('partner_id') or expense_data.get('supplier_id')
```

---

## ğŸ“ ä»Šå¾Œã®æ‹¡å¼µæ©Ÿèƒ½ï¼ˆæœªå®Ÿè£…ï¼‰

### å¥‘ç´„ä¿å­˜æ™‚ã®è‡ªå‹•è²»ç”¨é …ç›®ç”Ÿæˆ

**ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼å¥‘ç´„ã®å ´åˆ**:
```python
# å¥‘ç´„ä¿å­˜æ™‚ â†’ å¥‘ç´„æœŸé–“å†…ã®æœˆæ¬¡è²»ç”¨é …ç›®ã‚’è‡ªå‹•ç”Ÿæˆï¼ˆexpense_itemsï¼‰
# ä¾‹: 2025å¹´4æœˆã€œ9æœˆã®å¥‘ç´„ â†’ 6ä»¶ã®æœˆæ¬¡è²»ç”¨é …ç›®ã‚’è‡ªå‹•ä½œæˆ
```

**å˜ç™ºå¥‘ç´„ã®å ´åˆ**:
```python
# å¥‘ç´„ä¿å­˜æ™‚ â†’ å®Ÿæ–½æ—¥ã®è²»ç”¨é …ç›®ã‚’1ä»¶ç”Ÿæˆï¼ˆexpense_itemsï¼‰
```

ã“ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€å¥‘ç´„ã‚’ä½œæˆã™ã‚‹ã¨è‡ªå‹•çš„ã«æ”¯æ‰•äºˆå®šãŒä½œæˆã•ã‚Œã¾ã™ã€‚

---

## âš ï¸ æ³¨æ„äº‹é …

### ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§
- æ—§ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`order_contracts_old`, `expenses_order_old`ï¼‰ã¯å‰Šé™¤ã—ãªã„ã§ãã ã•ã„
- ã“ã‚Œã‚‰ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦ä¿æŒã•ã‚Œã¦ã„ã¾ã™

### å‹•ä½œç¢ºèªé …ç›®
1. âœ… ç•ªçµ„ç·¨é›†ç”»é¢ã§å‡ºæ¼”è€…/åˆ¶ä½œè€…ã®å¥‘ç´„æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹
2. âœ… å¥‘ç´„ã®æ–°è¦ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
3. âœ… è²»ç”¨é …ç›®ã®æ–°è¦ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
4. â³ å¥‘ç´„ã¨è²»ç”¨é …ç›®ã®ç´ä»˜ã‘ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
5. â³ æœˆæ¬¡æ”¯æ‰•ã„ç®¡ç†ã§è²»ç”¨é …ç›®ãŒæ­£ã—ãé›†è¨ˆã•ã‚Œã‚‹

### æ—¢çŸ¥ã®åˆ¶é™
- å¥‘ç´„ä¿å­˜æ™‚ã®è‡ªå‹•è²»ç”¨é …ç›®ç”Ÿæˆæ©Ÿèƒ½ã¯æœªå®Ÿè£…
- è²»ç”¨é …ç›®ã¨å¥‘ç´„ã®è‡ªå‹•ç´ä»˜ã‘ãƒ­ã‚¸ãƒƒã‚¯ã¯åŸºæœ¬çš„ãªã‚‚ã®ã®ã¿ï¼ˆproduction_id + partner_id + item_name + æœŸé–“ï¼‰

---

## ğŸ‰ ç§»è¡Œå®Œäº†

ã™ã¹ã¦ã®ä¸»è¦ãªå¤‰æ›´ãŒå®Œäº†ã—ã€GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸã€‚

### ã‚³ãƒŸãƒƒãƒˆå±¥æ­´
1. **Phase 1**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç§»è¡Œï¼ˆcontracts, expense_items ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã¨ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼‰
2. **Phase 2**: database_manager.py ã®å…¨ãƒ¡ã‚½ãƒƒãƒ‰å¯¾å¿œ
3. **Phase 3**: UIã‚³ãƒ¡ãƒ³ãƒˆã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ã®èª¿æ•´

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œç¢ºèª
- å¥‘ç´„ä¿å­˜æ™‚ã®è‡ªå‹•è²»ç”¨é …ç›®ç”Ÿæˆæ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†

---

**ä½œæˆæ—¥**: 2025-01-08
**ä½œæˆè€…**: Claude Code
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
